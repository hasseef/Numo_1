<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>منصة نمو NOMU — v4.0 (جميع التبويبات + CRUD + حفظ محلي)</title>
<style>
:root{
  --bg:#f7fbff; --paper:#fff; --brand:#16a34a; --ink:#0f172a; --sub:#475569; --accent:#f59e0b;
  --muted:#f1f5f9; --border:#e2e8f0; --radius:16px; --pad:16px; --gap:12px; --gap-lg:20px; --shadow:0 10px 30px rgba(2,12,27,.06);
  --font:"Tajawal","Noto Kufi Arabic",system-ui,-apple-system,"Segoe UI",Arial;
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.7 var(--font)}
a{color:#0ea5e9;text-decoration:none}
header{position:sticky;top:0;z-index:30;background:#ffffffe6;backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
.topbar{max-width:1240px;margin:auto;padding:10px var(--pad);display:flex;align-items:center;gap:10px}
.logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 180deg,#22c55e,#86efac,#34d399,#22c55e);box-shadow:0 6px 16px rgba(16,185,129,.25)}
.left-logos{margin-inline-start:auto;display:flex;gap:8px}
.pill-logo{display:flex;align-items:center;gap:8px;background:var(--muted);border:1px solid var(--border);border-radius:999px;padding:6px 10px}
.pill-logo img{height:28px;display:block}
.main{max-width:1240px;margin:20px auto;display:grid;grid-template-columns:280px 1fr;gap:var(--gap-lg);padding:0 var(--pad)}
nav .side{position:sticky;top:72px;background:var(--paper);border:1px solid var(--border);border-radius:var(--radius);padding:10px;box-shadow:var(--shadow)}
.group h4{margin:10px 8px;color:var(--sub);font-size:13px}
.link{display:flex;gap:10px;padding:10px;border-radius:12px;color:var(--ink);border:1px solid transparent}
.link:hover{background:var(--muted);border-color:var(--border)} .link.active{background:linear-gradient(180deg,#ecfdf5,#e7f9f0);border-color:#befae0}
.content{display:grid;gap:var(--gap-lg)}
.card{background:var(--paper);border:1px solid var(--border);border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow)}
.toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.tag{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#f0fdf4;color:#14532d;padding:6px 10px;border-radius:999px;font-size:12px}
.btn{background:var(--brand);color:#052e1d;border:none;padding:9px 12px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 6px 18px rgba(34,197,94,.25)}
.ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}
.grid{display:grid;gap:var(--gap)} .two{grid-template-columns:1fr 1fr} .three{grid-template-columns:repeat(3,1fr)} .four{grid-template-columns:repeat(4,1fr)}
.form label{display:block;margin:6px 0 4px} .form input,.form select,.form textarea{width:100%;padding:9px;border:1px solid var(--border);border-radius:10px;background:#fff}
.tabs{display:flex;gap:8px;flex-wrap:wrap;border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:8px}
.tab{padding:8px 12px;border:1px solid var(--border);border-bottom:none;border-radius:10px 10px 0 0;background:#f8fafc;cursor:pointer}
.tab.active{background:#fff;border-color:#22c55e}
.tabpanel{border:1px solid var(--border);border-radius:0 12px 12px 12px;padding:12px;background:#fff}
.kpi{border:1px solid var(--border);border-radius:14px;padding:14px;background:#f8fffb} .kpi b{display:block;font-size:22px;margin-top:6px}
table{width:100%;border-collapse:separate;border-spacing:0 8px} th,td{text-align:right;padding:10px;background:#fcfdff} th{color:#64748b;font-size:12px}
.tools{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.search{display:flex;gap:8px;align-items:center}
.files{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px} .filepill{display:flex;align-items:center;gap:6px;border:1px dashed #cbd5e1;background:#fff;border-radius:999px;padding:6px 10px;font-size:12px}
.note{font-size:12px;color:#64748b}
.callout{background:#f0f9ff;border:1px solid #bae6fd;border-radius:12px;padding:10px}
.danger{background:#fff1f2;border:1px solid #fecdd3}
footer{max-width:1240px;margin:22px auto 36px;color:#64748b;text-align:center;padding:0 var(--pad)}
@media (max-width:980px){ .main{grid-template-columns:1fr} .four{grid-template-columns:1fr 1fr} }
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px">
      <div class="logo" aria-hidden="true"></div>
      <div><b>NOMU — منصة نمو</b><div style="font-size:12px;color:#0f766e">منصة وطنية للطفولة المبكرة</div></div>
    </div>
    <div class="left-logos">
      <span class="pill-logo" title="Vision 2030">
        <img alt="Vision 2030" src='data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="140" height="36"><rect x="1" y="5" rx="12" width="138" height="26" fill="%23f1f5f9" stroke="%23cbd5e1"/><text x="70" y="24" text-anchor="middle" font-size="14" font-family="Tajawal,Arial" fill="%230f172a">Vision 2030</text></svg>'/>
      </span>
      <span class="pill-logo" title="مبادرة تلبية">
        <img alt="Talbiya" src='data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="140" height="36"><rect x="1" y="5" rx="12" width="138" height="26" fill="%23f1f5f9" stroke="%23cbd5e1"/><text x="70" y="24" text-anchor="middle" font-size="14" font-family="Tajawal,Arial" fill="%230f172a">%D9%85%D8%A8%D8%A7%D8%AF%D8%B1%D8%A9%20%D8%AA%D9%84%D8%A8%D9%8A%D8%A9</text></svg>'/>
      </span>
    </div>
  </div>
</header>

<main class="main">
  <nav>
    <div class="side">
      <div class="group">
        <h4>التعاريف</h4>
        <a class="link" href="#/intro">عن المنصة</a>
        <a class="link" href="#/kpi">سجل KPI</a>
      </div>
      <div class="group">
        <h4>الحسابات</h4>
        <a class="link" href="#/acc/health">وزارة الصحة</a>
        <a class="link" href="#/acc/clinic">المراكز الصحية</a>
        <a class="link" href="#/acc/education">وزارة التعليم</a>
        <a class="link" href="#/acc/neighborhood">مراكز الأحياء</a>
        <a class="link" href="#/acc/nonprofit">الجمعيات</a>
        <a class="link" href="#/acc/hr">الموارد البشرية</a>
        <a class="link" href="#/acc/csr">القطاع الخاص</a>
        <a class="link" href="#/acc/family">الأسرة</a>
        <a class="link" href="#/acc/admin">اللجنة الوطنية</a>
      </div>
      <div class="group">
        <h4>تشغيل</h4>
        <a class="link" href="#/dispatch">موزّع المواعيد</a>
        <a class="link" href="#/ops">لوحة المراكز</a>
      </div>
      <div class="group">
        <h4>الاستدامة</h4>
        <a class="link" href="#/sponsors">بوابة الرعاة</a>
        <a class="link" href="#/pricing">لوائح الأسعار</a>
      </div>
      <div class="group">
        <h4>الأمن والربط</h4>
        <a class="link" href="#/sso">SSO نفاذ</a>
        <a class="link" href="#/rbac">RBAC</a>
        <a class="link" href="#/config">الإعدادات</a>
      </div>
      <div class="group">
        <h4>سياسات ومساعدة</h4>
        <a class="link" href="#/privacy">الخصوصية</a>
        <a class="link" href="#/child">حماية الطفل</a>
        <a class="link" href="#/help">مركز المساعدة</a>
        <a class="link" href="#/terms">الشروط والأحكام</a>
      </div>
      <div class="group">
        <h4>أدوات</h4>
        <a class="link" href="#/export">تصدير</a>
        <a class="link" href="#/apidocs">API Docs</a>
      </div>
    </div>
  </nav>
  <section class="content" id="view"></section>
</main>

<footer>نمو NOMU — v4.0 (منصة متكاملة بواجهة واحدة: CRUD + تبويبات + حفظ محلي + تشغيل + استدامة + سياسات)</footer>

<script>
/* ============= أدوات عامة ============= */
const $=(q,root=document)=>root.querySelector(q);
const $$=(q,root=document)=>Array.from(root.querySelectorAll(q));
function route(){ const p=location.hash.slice(1)||'/intro'; $$('a.link').forEach(a=>a.classList.toggle('active', a.getAttribute('href')===`#${p}`)); (routes[p]||intro)(); }
window.addEventListener('hashchange',route);

const downloadFile=(name,blob)=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); };
const downloadJSON=(name,obj)=>downloadFile(name,new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}));
const toCSV=(rows)=>rows.map(r=>r.map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
const downloadCSV=(name,rows)=>downloadFile(name,new Blob([toCSV(rows)],{type:'text/csv'}));
const uid=(p='ID')=>p+'-'+Math.random().toString(36).slice(2,8).toUpperCase();
const today=()=>new Date().toISOString().slice(0,10);

/* ============= SSO & RBAC & Config ============= */
const DEFAULT_CONFIG={
  sso:{ issuer:'https://nafath.example.gov.sa', authorize_url:'https://nafath.example.gov.sa/authorize', token_url:'https://nafath.example.gov.sa/token', client_id:'NOMU-CLIENT-ID', redirect_uri:'https://nomu.gov.sa/callback' },
  apis:{ internal:{ health:'/api/health', clinic:'/api/clinic', education:'/api/education', neighborhood:'/api/neighborhood', nonprofit:'/api/nonprofit', hr:'/api/hr', csr:'/api/csr', family:'/api/family', admin:'/api/admin', dispatch:'/api/dispatch' } }
};
const loadCfg=()=>{ try{ return JSON.parse(localStorage.getItem('nomu_cfg')||'null') || DEFAULT_CONFIG }catch(e){ return DEFAULT_CONFIG } };
const saveCfg=(cfg)=>localStorage.setItem('nomu_cfg', JSON.stringify(cfg));

let RBAC={ roles:{
  'health.practitioner':['child.read','health.write','referral.send','referral.accept','appointment.manage','kpi.view'],
  'clinic.staff':['child.read','appointment.manage','referral.accept','kpi.view'],
  'education.specialist':['child.read','education.write','referral.accept','kpi.view'],
  'neighborhood.coordinator':['program.manage','booking.manage','referral.accept','kpi.view'],
  'nonprofit.worker':['child.read','service.write','referral.accept','kpi.view'],
  'admin.national':['kpi.view','kpi.define','policy.write','audit.read'],
  'family.guardian':['child.own','consent.grant','appointment.book']
}};
const can=(role,perm,consent=true)=> (RBAC.roles[role]||[]).includes(perm) && (perm!=='child.read' || consent || role==='admin.national');

/* ============= قاعدة بيانات محلية (Mock API) ============= */
const DB_KEY='nomu_db_v40';
const DB=()=>{ try{ return JSON.parse(localStorage.getItem(DB_KEY)||'{}') }catch(e){ return {} } };
const DB_SAVE=(db)=>localStorage.setItem(DB_KEY, JSON.stringify(db));
const ensure=(...path)=>{ const db=DB(); let cur=db; for(const k of path){ cur[k]=cur[k]||{}; cur=cur[k]; } DB_SAVE(db); return cur; };

const API={
  list:(entity,section)=>Object.values(ensure(entity,section).items||{}),
  create:(entity,section,record)=>{ const root=ensure(entity,section); root.items=root.items||{}; const id=uid('REC'); root.items[id]={id,...record,createdAt:new Date().toISOString()}; DB_SAVE(DB()); return root.items[id]; },
  update:(entity,section,id,patch)=>{ const root=ensure(entity,section); if(root.items?.[id]){ root.items[id]={...root.items[id],...patch,updatedAt:new Date().toISOString()}; DB_SAVE(DB()); return root.items[id]; } },
  remove:(entity,section,id)=>{ const root=ensure(entity,section); if(root.items?.[id]){ delete root.items[id]; DB_SAVE(DB()); return true; } return false; },
  import:(entity,section,arr)=>{ const root=ensure(entity,section); root.items=root.items||{}; arr.forEach(x=>{ const id=x.id||uid('REC'); root.items[id]={id,...x}; }); DB_SAVE(DB()); },
  clear:(entity,section)=>{ const root=ensure(entity,section); root.items={}; DB_SAVE(DB()); },
};

/* ============= بيانات تشغيل المراكز + توزيع ============= */
const CENTERS=[
  { id:'CLN-001', name:'مركز صحي حي الازدهار', type:'clinic', region:'الرياض', specialty:['نمائي','تخاطب'], capacityDay:24, bookedToday:8, avgVisitMin:30, slaDays:7 },
  { id:'CLN-002', name:'مركز صحي حي الشاطئ', type:'clinic', region:'الشرقية', specialty:['نمائي','وظيفي'], capacityDay:18, bookedToday:15, avgVisitMin:40, slaDays:5 },
  { id:'NHB-101', name:'مركز حي التعاون', type:'neighborhood', region:'الرياض', specialty:['توعية','فرز أولي'], capacityDay:40, bookedToday:10, avgVisitMin:20, slaDays:3 },
  { id:'NHB-102', name:'مركز حي العليا', type:'neighborhood', region:'الرياض', specialty:['توعية','فرز أولي'], capacityDay:35, bookedToday:34, avgVisitMin:20, slaDays:3 },
  { id:'NGO-501', name:'جمعية نماء الطفولة', type:'nonprofit', region:'الرياض', specialty:['تدخل مبكر','تخاطب'], capacityDay:22, bookedToday:6, avgVisitMin:45, slaDays:10 }
];
const occPct=c=>Math.round((c.bookedToday / Math.max(1,c.capacityDay))*100);
const estWaitDays=c=>{ const overflow=Math.max(0, c.bookedToday - c.capacityDay); return overflow>0 ? Math.ceil(overflow / Math.max(1,c.capacityDay)) : 0; };
function pickCenter({region, need, maxSlaDays=14}){
  const candidates = CENTERS.filter(c=> (c.region===region) && (need==='فرز أولي' ? true : c.specialty.includes(need)));
  if(!candidates.length) return null;
  const scored = candidates.map(c=>{
    const occ = c.bookedToday/Math.max(1,c.capacityDay), occScore=1-Math.min(1,occ);
    const slaScore=Math.max(0,(maxSlaDays-c.slaDays)/maxSlaDays);
    return {c,score:occScore*0.6+slaScore*0.4};
  }).sort((a,b)=>b.score-a.score);
  return scored[0]?.c||null;
}

/* ============= تعريفات KPI ============= */
const KPI_REGISTRY=[
  { id:'DEV_SCREEN', name:'نسبة تغطية الفحص النمائي', owner:'وزارة الصحة', formula:'المفحوصون ÷ المستهدفون ×100', period:'شهري', source:'HealthAssessment' },
  { id:'SCHOOL_READY', name:'نسبة الجاهزية المدرسية', owner:'وزارة التعليم', formula:'جاهزون ÷ إجمالي 5–6 ×100', period:'فصلي', source:'EducationPlan' },
  { id:'REF_TTR', name:'زمن الإحالة (يوم)', owner:'اللجنة الوطنية', formula:'متوسط (قبول − فتح)', period:'شهري', source:'Referral' },
  { id:'WAIT', name:'متوسط انتظار الخدمة', owner:'الجهة المقدِّمة', formula:'متوسط (أول جلسة − القبول)', period:'شهري', source:'ServiceSession' },
  { id:'CSR_FUNDS', name:'تمويل CSR', owner:'القطاع الخاص + المنصة', formula:'التعهدات المؤكدة + المحوّل', period:'ربع سنوي', source:'CSRCommitment' },
  { id:'ACTIVE_REF', name:'الإحالات النشطة', owner:'اللجنة الوطنية', formula:'المفتوحة − المغلقة', period:'يومي', source:'Referral' }
];

/* ============= مولّد نماذج/جداول عام ============= */
function buildForm(container, schema, current=null){
  container.innerHTML = `<div class="form grid two">
    ${schema.map(f=>{
      const val=current?.[f.key]??(f.value??'');
      const type=f.type||'text';
      const extra=(type==='textarea')?`<textarea data-key="${f.key}" placeholder="${f.key}">${val}</textarea>`:`<input type="${type}" data-key="${f.key}" value="${val}" placeholder="${f.key}"/>`;
      return `<label>${f.label}${extra}</label>`;
    }).join('')}
    ${schema.some(f=>f.type==='file')?`<div class="files" id="flist"></div>`:''}
  </div>`;
  // مرفقات عامة (إذا طلب)
  schema.filter(f=>f.type==='file').forEach(f=>{
    const input = container.querySelector(`[data-key="${f.key}"]`);
    const flist = container.querySelector('#flist');
    input.addEventListener('change', e=>{
      [...e.target.files].forEach(file=>{
        const fileId=uid('FILE');
        const url=URL.createObjectURL(file);
        const pill=document.createElement('span'); pill.className='filepill';
        pill.innerHTML=`📎 ${file.name} • ${(file.size/1024).toFixed(1)} KB <a href="${url}" download="${file.name}">تنزيل</a>`;
        flist.appendChild(pill);
      });
    });
  });
}
function buildTable(container, schema, rows, {onEdit,onDelete}={}){
  if(!rows.length){ container.innerHTML='<div class="note">لا توجد سجلات.</div>'; return; }
  const cols = ['id',...schema.map(f=>f.key),'createdAt','updatedAt'];
  container.innerHTML = `
    <div class="tools">
      <div class="search">
        <input id="q" placeholder="بحث سريع" />
        <button class="ghost" id="exportCsv">تصدير CSV</button>
        <label class="ghost" style="padding:6px 10px;border-radius:10px;cursor:pointer">
          استيراد JSON <input id="importJson" type="file" accept="application/json" style="display:none"/>
        </label>
      </div>
    </div>
    <div style="overflow:auto"><table id="tbl"><thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}<th>إجراءات</th></tr></thead><tbody></tbody></table></div>`;
  const tbody=$('#tbl tbody',container);
  const render=(data)=>{ tbody.innerHTML=data.map(r=>`<tr>${cols.map(c=>`<td>${(r[c]??'')}</td>`).join('')}<td>
      <button class="ghost" data-edit="${r.id}">تعديل</button>
      <button class="ghost" data-del="${r.id}">حذف</button>
    </td></tr>`).join(''); };
  render(rows);
  $('#q',container).oninput=(e)=>{ const q=e.target.value.trim(); const filtered=rows.filter(r=>JSON.stringify(r).includes(q)); render(filtered); };
  $('#exportCsv',container).onclick=()=>{ const header=[...cols]; const data=rows.map(r=>cols.map(c=>r[c]??'')); downloadCSV('export.csv',[header,...data]); };
  $('#importJson',container).onchange=(e)=>{ const file=e.target.files[0]; if(!file) return; const fr=new FileReader(); fr.onload=()=>{ try{ const arr=JSON.parse(fr.result||'[]'); onEdit?.({import:arr}); }catch(err){ alert('صيغة JSON غير صحيحة'); } }; fr.readAsText(file); };
  container.addEventListener('click',(ev)=>{
    const id=ev.target.getAttribute('data-edit'); const del=ev.target.getAttribute('data-del');
    if(id && onEdit) onEdit({id});
    if(del && onDelete) onDelete({id:del});
  });
}

/* ============= تعريف الحقول/التبويبات لكل حساب ============= */
const ACCOUNTS={
  health:{ title:'وزارة الصحة', tabs:{
    'سجل الفحوص':[
      {label:'MRN',key:'mrn'},{label:'نتيجة الفحص النمائي',key:'dev_result'},
      {label:'PHQ-2/9',key:'phq_score'},{label:'ICD-10',key:'icd10'}
    ],
    'التدخل المبكر':[
      {label:'نوع التدخل',key:'intervention_type'},{label:'عدد الجلسات',key:'sessions',type:'number'},
      {label:'موعد المتابعة',key:'followup_date',type:'date'}
    ],
    'الإحالات':[
      {label:'تاريخ فتح الحالة',key:'opened_at',type:'date',value:today()},{label:'جهة الإحالة',key:'ref_to'},
      {label:'أولوية',key:'priority'},{label:'SLA (يوم)',key:'sla',type:'number',value:7}
    ],
    'المواعيد':[
      {label:'هوية الطفل',key:'childId'},{label:'المنطقة',key:'region'},{label:'الحاجة',key:'need'},{label:'أولوية',key:'prio'}
    ],
    'مطالبات NPHIES':[
      {label:'رقم المطالبة',key:'claim_id'},{label:'الحالة',key:'claim_status'}
    ],
    'تقارير':[],
    'مرفقات':[ {label:'ملفات',key:'files',type:'file'} ]
  }},
  clinic:{ title:'المراكز الصحية', tabs:{
    'المواعيد':[ {label:'سجل الطفل',key:'mrn'},{label:'التخصص',key:'specialty'},{label:'موعد (تاريخ/ساعة)',key:'appt_datetime',type:'datetime-local'} ],
    'الإحالات':[ {label:'من جهة',key:'ref_from'},{label:'حالة الإحالة',key:'ref_status'},{label:'تاريخ القبول',key:'accepted_at',type:'date'} ],
    'الخدمات':[ {label:'اسم الخدمة',key:'service'},{label:'SLA أيام',key:'sla_days',type:'number'} ],
    'المخزون':[ {label:'معدات/أدوات',key:'inventory_item'},{label:'الكمية',key:'qty',type:'number'} ],
    'التقارير':[], 'مرفقات':[ {label:'ملفات',key:'files',type:'file'} ]
  }},
  education:{ title:'وزارة التعليم', tabs:{
    'جاهزية المدرسة':[ {label:'درجة الجاهزية',key:'readiness_score',type:'number'},{label:'المدرسة',key:'school_name'} ],
    'IEP/دمج':[ {label:'IEP JSON',key:'iep_json',type:'textarea'},{label:'نوع الدمج',key:'inclusion_type'} ],
    'الإحالات':[ {label:'تاريخ فتح',key:'opened_at',type:'date',value:today()},{label:'إلى جهة',key:'ref_to'},{label:'SLA (يوم)',key:'sla',type:'number',value:10} ],
    'تواصل الأسرة':[ {label:'هوية ولي الأمر',key:'guardian_id'},{label:'القناة',key:'channel'} ],
    'تقارير نور':[], 'مرفقات':[ {label:'ملفات',key:'files',type:'file'} ]
  }},
  neighborhood:{ title:'مراكز الأحياء', tabs:{
    'البرامج':[ {label:'اسم البرنامج',key:'program'},{label:'الفئة العمرية',key:'age_band'},{label:'الطاقة الاستيعابية',key:'capacity',type:'number'} ],
    'المتطوعون':[ {label:'اسم المتطوع',key:'vol_name'},{label:'ساعات التطوع',key:'vol_hours',type:'number'} ],
    'الحجوزات':[ {label:'تاريخ',key:'date',type:'date'},{label:'عدد المقاعد',key:'seats',type:'number'} ],
    'الإحالات':[ {label:'من/إلى',key:'ref_direction'},{label:'الحالة',key:'status'} ],
    'التقارير':[], 'مرفقات':[ {label:'ملفات',key:'files',type:'file'} ]
  }},
  nonprofit:{ title:'الجمعيات', tabs:{
    'البرامج':[ {label:'اسم البرنامج',key:'program'},{label:'عدد الجلسات',key:'sessions',type:'number'} ],
    'المستفيدون':[ {label:'هوية ولي الأمر',key:'guardian_id'},{label:'المنطقة',key:'region'} ],
    'المتطوعون':[ {label:'اسم المتطوع',key:'vol_name'},{label:'ساعات التطوع',key:'hours',type:'number'} ],
    'الإحالات':[ {label:'إلى جهة',key:'ref_to'},{label:'الحالة',key:'status'} ],
    'قياس الأثر':[ {label:'تحسن الطفل (%)',key:'improve_pct',type:'number'} ],
    'التقارير':[], 'مرفقات':[ {label:'ملفات',key:'files',type:'file'} ]
  }},
  hr:{ title:'الموارد البشرية', tabs:{
    'محفظة الدعم':[ {label:'نوع الدعم',key:'support_type'},{label:'المبلغ/الشهر',key:'amount',type:'number'},{label:'أهلية الأسرة',key:'eligibility'} ],
    'التطوع الوطني':[ {label:'المبادرة',key:'initiative'},{label:'الساعات',key:'hours',type:'number'} ],
    'التقارير':[], 'مرفقات':[ {label:'ملفات',key:'files',type:'file'} ]
  }},
  csr:{ title:'القطاع الخاص', tabs:{
    'سوق الرعاية':[ {label:'اسم الشركة',key:'company'},{label:'الفئة',key:'tier'},{label:'المنطقة',key:'region'} ],
    'تعهدات الشركة':[ {label:'قيمة التعهد',key:'amount',type:'number'},{label:'الغرض',key:'purpose'} ],
    'تقارير الأثر':[], 'حوكمة CSR':[], 'مرفقات':[ {label:'ملفات',key:'files',type:'file'} ]
  }},
  family:{ title:'الأسرة', tabs:{
    'ملف الحمل والطفل':[ {label:'هوية ولي الأمر',key:'guardian_id'},{label:'المنطقة',key:'region'},{label:'موافقة مشاركة البيانات',key:'consent'} ],
    'المواعيد':[ {label:'الخدمة',key:'service'},{label:'موعد',key:'date',type:'date'} ],
    'التوصيات':[], 'الخدمات المساندة':[], 'مرفقات':[ {label:'ملفات',key:'files',type:'file'} ]
  }},
  admin:{ title:'اللجنة الوطنية', tabs:{
    'لوحة وطنية':[],
    'حوكمة البيانات':[ {label:'قرار سياسة',key:'policy_decision'} ],
    'التكاملات':[ {label:'تعريف KPI',key:'kpi_def'} ],
    'الإشراف على الإحالات':[ {label:'SLA افتراضي (يوم)',key:'sla_default',type:'number',value:7} ],
    'التقارير الوطنية':[], 'مرفقات':[ {label:'ملفات',key:'files',type:'file'} ]
  }},
};

/* ============= صفحات ============= */
function intro(){
  const v=$('#view');
  v.innerHTML = `<div class="card">
    <div class="toolbar"><h2>عن منصة نمو (NOMU)</h2><span class="tag">منصة وطنية للطفولة المبكرة</span></div>
    <p><b>الرؤية:</b> تمكين كل طفل في المملكة من بداية قوية متكاملة صحيًا وتعليميًا واجتماعيًا.<br/>
       <b>الرسالة:</b> منصة موحدة لرحلة الطفل والأسرة عبر التكامل، الإحالات، المؤشرات، والاستدامة.</p>
    <div class="grid four">
      <div class="kpi"><div>تغطية الفحص النمائي</div><b id="k1">—%</b><span class="note">هدف 2025: 80%</span></div>
      <div class="kpi"><div>الجاهزية المدرسية</div><b id="k2">—%</b><span class="note">هدف 2025: 75%</span></div>
      <div class="kpi"><div>متوسط زمن الإحالة</div><b id="k3">— يوم</b><span class="note">≤ 7</span></div>
      <div class="kpi"><div>تمويل CSR</div><b id="k4">— ر.س</b><span class="note">سنوي</span></div>
    </div>
  </div>`;
}
function kpiPage(){
  const v=$('#view');
  v.innerHTML = `<div class="card">
    <div class="toolbar"><h2>سجل تعريفات KPI</h2><button class="ghost" id="dl">تنزيل JSON</button></div>
    <table><thead><tr><th>المؤشر</th><th>المالك</th><th>الصيغة</th><th>الفترة</th><th>المصدر</th></tr></thead>
      <tbody>${KPI_REGISTRY.map(k=>`<tr><td><b>${k.name}</b><div class='note'>${k.id}</div></td><td>${k.owner}</td><td>${k.formula}</td><td>${k.period}</td><td>${k.source}</td></tr>`).join('')}</tbody>
    </table>
  </div>`;
  $('#dl').onclick=()=>downloadJSON('kpi_registry.json',KPI_REGISTRY);
}

/* === صفحة حساب عام (كل التبويبات + CRUD) === */
function accountPage(key){
  const A=ACCOUNTS[key]; const v=$('#view'); const tabs=Object.keys(A.tabs);
  v.innerHTML = `<div class="card">
    <div class="toolbar"><h2>${A.title}</h2><span class="tag">كل التبويبات مفعّلة</span></div>
    <div class="tabs">${tabs.map((t,i)=>`<button class="tab ${i===0?'active':''}" data-tab="${t}">${t}</button>`).join('')}</div>
    <div id="tabpanel" class="tabpanel"></div>
  </div>`;
  const renderTab=(name)=>{
    const schema=A.tabs[name]; const panel=$('#tabpanel'); panel.innerHTML='';
    // نموذج الإدخال + أدوات
    panel.innerHTML = `<div class="grid two">
      <div id="formCard" class="card">
        <div class="toolbar"><h3>${name}</h3><span class="tag">نموذج الإدخال</span></div>
        <div id="formHost"></div>
        <div class="tools"><button class="btn" id="saveRec">حفظ</button><button class="ghost" id="reset">تفريغ</button>
          ${name==='المواعيد'?'<button class="ghost" id="smartAssign">توزيع ذكي</button>':''}
          ${name==='الإحالات'?'<button class="ghost" id="rf_send">إرسال إحالة</button><button class="ghost" id="rf_accept">قبول</button><button class="ghost" id="rf_reject">رفض</button>':''}
        </div>
        ${name==='الإحالات'?'<div class="callout" id="slaNote">—</div>':''}
      </div>
      <div id="tableCard" class="card">
        <div class="toolbar"><h3>السجلات</h3><span class="tag">CRUD + بحث + استيراد/تصدير</span></div>
        <div id="tableHost"></div>
      </div>
    </div>`;
    let editId=null;
    buildForm($('#formHost'), schema);
    const refresh=()=>{ const rows=API.list(key,name); buildTable($('#tableHost'), schema, rows,{
      onEdit:({id,import:arr})=>{
        if(arr){ API.import(key,name,arr); refresh(); return; }
        const rec=rows.find(r=>r.id===id); editId=id; buildForm($('#formHost'),schema,rec);
      },
      onDelete:({id})=>{ API.remove(key,name,id); refresh(); }
    }); };
    refresh();

    const readForm=()=>Object.fromEntries(schema.map(f=>[f.key, $('#formHost [data-key="'+f.key+'"]')?.value??'']));
    const clearForm=()=>buildForm($('#formHost'),schema);
    $('#saveRec').onclick=()=>{ const data=readForm(); if(editId){ API.update(key,name,editId,data); editId=null; } else { API.create(key,name,data); } refresh(); clearForm(); };
    $('#reset').onclick=()=>{ editId=null; clearForm(); };

    // توزيع ذكي للمواعيد
    if(name==='المواعيد' && $('#smartAssign')){
      $('#smartAssign').onclick=()=>{
        const region=$('#formHost [data-key="region"]')?.value||'الرياض';
        const need=$('#formHost [data-key="need"]')?.value||$('#formHost [data-key="service"]')?.value||'نمائي';
        const role='clinic.staff';
        if(!can(role,'appointment.manage')){ alert('⛔ لا تملك صلاحية الحجز'); return; }
        const c=pickCenter({region,need,maxSlaDays:14});
        if(!c){ alert('لا يوجد مركز مناسب'); return; }
        if(occPct(c)<100){ c.bookedToday+=1; alert(`✅ حجز في ${c.name} — إشغال ${occPct(c)}%`); }
        else { alert(`⌛ امتلاء اليوم — انتظار ${c.name} (≈ ${estWaitDays(c)} يوم)`); }
      };
    }

    // إحالات + SLA
    if(name==='الإحالات'){
      const updateSLA=()=>{
        const opened=$('#formHost [data-key="opened_at"]')?.value;
        const sla=parseInt($('#formHost [data-key="sla"]')?.value||7,10);
        if(!opened){ $('#slaNote').textContent='—'; return; }
        const days=Math.ceil((new Date().getTime()-new Date(opened).getTime())/86400000);
        $('#slaNote').textContent = days>sla? `⛔ تجاوز SLA (${days}/${sla} يوم)`:`✅ ضمن SLA (${days}/${sla} يوم)`;
      };
      $('#formHost').addEventListener('input', e=>{ if(e.target.matches('[data-key="opened_at"],[data-key="sla"]')) updateSLA(); });
      updateSLA();
      $('#rf_send').onclick=()=>{ if(!can('health.practitioner','referral.send')){ alert('⛔ صلاحية مفقودة'); return; } alert('✅ تم إرسال الإحالة (محاكاة)'); };
      $('#rf_accept').onclick=()=>{ if(!can('clinic.staff','referral.accept')){ alert('⛔ صلاحية مفقودة'); return; } alert('✅ تم قبول الإحالة (محاكاة)'); };
      $('#rf_reject').onclick=()=>alert('تم رفض الإحالة (محاكاة)');
    }
  };
  renderTab(tabs[0]);
  $$('.tab',v).forEach(b=>b.onclick=(e)=>{ $$('.tab',v).forEach(x=>x.classList.remove('active')); e.currentTarget.classList.add('active'); renderTab(e.currentTarget.dataset.tab); });
}

/* === الموزع الذكي === */
function dispatchPage(){
  ensure('dispatch','queue'); const v=$('#view');
  v.innerHTML=`<div class="card">
    <div class="toolbar"><h2>الموزّع الذكي للمواعيد</h2><span class="tag">اختيار مركز حسب الإشغال/SLA/المنطقة</span></div>
    <div class="grid two form">
      <label>هوية الطفل<input id="childId" placeholder="Child-XXXX"/></label>
      <label>المنطقة<select id="region"><option>الرياض</option><option>الشرقية</option></select></label>
      <label>الحاجة<select id="need"><option>نمائي</option><option>تخاطب</option><option>وظيفي</option><option>فرز أولي</option></select></label>
      <label>الأولوية<select id="priority"><option>عادية</option><option>عاجلة</option></select></label>
      <label>SLA الأقصى<input id="sla" type="number" value="14"/></label>
      <label>الدور<select id="role"><option>clinic.staff</option><option>health.practitioner</option><option>neighborhood.coordinator</option><option>admin.national</option></select></label>
    </div>
    <div class="tools"><button class="btn" id="go">توزيع</button><button class="ghost" id="export">تصدير CSV</button></div>
    <pre id="out" class="callout" style="white-space:pre-wrap"></pre>
  </div>
  <div class="card"><div class="toolbar"><h3>الطلبات</h3><span class="tag">قائمة</span></div><div id="qList"></div></div>`;
  const render=()=>{ const rows=API.list('dispatch','queue'); buildTable($('#qList'),[{key:'childId'},{key:'region'},{key:'need'},{key:'priority'},{key:'centerId'},{key:'centerName'},{key:'status'}],rows,{
    onEdit:()=>{}, onDelete:({id})=>{ API.remove('dispatch','queue',id); render(); }
  }); };
  render();
  $('#go').onclick=()=>{
    const role=$('#role').value; if(!can(role,'appointment.manage')){ $('#out').textContent='⛔ ليس لديك صلاحية الحجز'; return; }
    const req={ id:uid('REQ'), childId:$('#childId').value||'Child-—', region:$('#region').value, need:$('#need').value, priority:$('#priority').value, status:'جديد' };
    const target=pickCenter({region:req.region,need:req.need,maxSlaDays:parseInt($('#sla').value||'14',10)});
    if(target){
      if(occPct(target)<100){ target.bookedToday+=1; req.centerId=target.id; req.centerName=target.name; req.status='محجوز اليوم'; $('#out').textContent=`✅ حُجز في ${target.name} — إشغال ${occPct(target)}%`; }
      else{ req.centerId=target.id; req.centerName=target.name; req.status='انتظار بالمركز'; $('#out').textContent=`⌛ انتظار في ${target.name} (≈ ${estWaitDays(target)} يوم)`; }
    } else { req.status='انتظار عام'; $('#out').textContent='⚠️ لا يوجد مركز مناسب — أُضيف للانتظار العام'; }
    API.create('dispatch','queue',req); render();
  };
  $('#export').onclick=()=>{
    const rows=API.list('dispatch','queue'); const cols=['id','childId','region','need','priority','centerId','centerName','status','createdAt'];
    downloadCSV('dispatch_queue.csv',[cols,...rows.map(r=>cols.map(c=>r[c]??''))]);
  };
}

/* === لوحة المراكز === */
function opsPage(){
  const v=$('#view');
  const cards=CENTERS.map(c=>`<div class="card">
    <div class="toolbar"><h3>${c.name}</h3><span class="tag">${c.type}</span></div>
    <div class="grid two">
      <div class="kpi"><div>الإشغال</div><b>${occPct(c)}%</b><span class="note">سعة ${c.capacityDay}/يوم</span></div>
      <div class="kpi"><div>انتظار تقديري</div><b>${estWaitDays(c)} يوم</b><span class="note">SLA: ${c.slaDays} أيام</span></div>
    </div>
    <div class="note">تخصصات: ${c.specialty.join('، ')} • المنطقة: ${c.region}</div>
  </div>`).join('');
  v.innerHTML=`<div class="card"><div class="toolbar"><h2>لوحة تشغيل المراكز</h2><span class="tag">تشغيل</span></div><div class="grid two">${cards}</div></div>
  <div class="card danger"><b>توصية:</b> نموذج هجين: المراكز الصحية للتدخل المتخصص، ومراكز الأحياء للفرز/البرامج المجتمعية بإشراف فني لتخفيف ضغط التوظيف.</div>`;
}

/* === الرعاة + الأسعار === */
function sponsorsPage(){
  const v=$('#view'); v.innerHTML=`<div class="card">
    <div class="toolbar"><h2>بوابة الرعاة</h2><span class="tag">اتفاقية قابلة للطباعة</span></div>
    <div class="three grid">
      <div class='card'><h3>ماسي</h3><div style='font-size:20px;font-weight:800;color:#0f766e'>1,500,000 ر.س/سنة</div><ul><li>الشعار في كل الصفحات</li><li>تقرير أثر ربع سنوي</li><li>أولوية تسمية</li><li>مقعد مجلس الرعاة</li></ul></div>
      <div class='card'><h3>ذهبي</h3><div style='font-size:20px;font-weight:800;color:#0f766e'>700,000 ر.س/سنة</div><ul><li>الشعار بالصفحات الرئيسية</li><li>تقارير نصف سنوية</li><li>دعوات فعاليات</li></ul></div>
      <div class='card'><h3>فضي</h3><div style='font-size:20px;font-weight:800;color:#0f766e'>300,000 ر.س/سنة</div><ul><li>الشعار بصفحة الرعاة</li><li>شارة التقارير</li></ul></div>
    </div>
    <h3>طلب رعاية</h3>
    <div class="grid two form">
      <label>اسم الجهة<input id="sp_org"/></label>
      <label>س.ت/رقم ضريبي<input id="sp_cr"/></label>
      <label>البريد الإلكتروني<input id="sp_mail"/></label>
      <label>فئة الرعاية<select id="sp_tier"><option>Diamond</option><option>Gold</option><option>Silver</option></select></label>
      <label>المنطقة<select id="sp_region"><option>على مستوى المملكة</option><option>الرياض</option><option>الشرقية</option></select></label>
      <label>المدة (أشهر)<input id="sp_months" type="number" value="12"/></label>
    </div>
    <button class="btn" id="gen">إنشاء اتفاقية</button>
    <div class="card" id="agreement" style="display:none;margin-top:12px"></div>
  </div>`;
  $('#gen').onclick=()=>{
    const org=$('#sp_org').value||'____', tier=$('#sp_tier').value, region=$('#sp_region').value, cr=$('#sp_cr').value||'—', months=parseInt($('#sp_months').value||'12',10);
    const todayStr=new Date().toLocaleDateString('ar-SA');
    const rights=tier==='Diamond'?'شعار شامل + تقارير ربع سنوية + أولوية تسمية + مجلس الرعاة':(tier==='Gold'?'شعار بالصفحات الرئيسية + تقارير نصف سنوية + دعوات':'شعار بصفحة الرعاة + شارة تقارير');
    $('#agreement').style.display='block';
    $('#agreement').innerHTML=`<h3>اتفاقية رعاية منصة نمو</h3>
    <p>بتاريخ <b>${todayStr}</b> بين منصة <b>نمو NOMU</b> والجهة <b>${org}</b> (س.ت/ضريبي: ${cr}) كراعي <b>${tier}</b> في <b>${region}</b> لمدة <b>${months}</b> شهرًا.</p>
    <h4>الحقوق والمزايا</h4><p>${rights}</p>
    <h4>حماية البيانات</h4><p>لا وصول لبيانات شخصية. أي مشاركة بيانات تخضع لـ PDPL واتفاقيات معالجة مستقلة.</p>
    <button class="ghost" onclick="window.print()">طباعة / PDF</button>`;
  };
}
function pricingPage(){
  const v=$('#view'); v.innerHTML=`<div class="card">
    <div class="toolbar"><h2>لوائح أسعار الرعاية</h2><span class="tag">قابلة للتعديل</span></div>
    <table><thead><tr><th>الفئة</th><th>السعر السنوي (ر.س)</th><th>المزايا</th></tr></thead>
      <tbody>
        <tr><td><b>ماسي</b></td><td>1,500,000</td><td>شعار شامل + تقارير ربع سنوية + مجلس الرعاة</td></tr>
        <tr><td><b>ذهبي</b></td><td>700,000</td><td>شعار بالصفحات الرئيسية + تقارير نصف سنوية + دعوات</td></tr>
        <tr><td><b>فضي</b></td><td>300,000</td><td>شعار بصفحة الرعاة + شارة تقارير</td></tr>
      </tbody></table>
  </div>`;
}

/* === الأمن والربط === */
function ssoPage(){ const v=$('#view'); const cfg=loadCfg(); v.innerHTML=`<div class="card">
  <div class="toolbar"><h2>SSO نفاذ (محاكاة)</h2><span class="tag">OIDC</span></div>
  <p>ISSUER: <code>${cfg.sso.issuer}</code> • AUTHZ: <code>${cfg.sso.authorize_url}</code> • TOKEN: <code>${cfg.sso.token_url}</code></p>
  <button class="btn" id="nafath">الدخول عبر نفاذ</button>
  <pre id="ssoLog" class="callout" style="white-space:pre-wrap;margin-top:10px"></pre></div>`;
  $('#nafath').onclick=()=>{ const mock='USR-'+Math.random().toString(36).slice(2,8).toUpperCase(); $('#ssoLog').textContent=`→ code → id_token\nUserID: ${mock}\nRoles: ["clinic.staff","referral.accept"]`; };
}
function rbacPage(){ const v=$('#view'); const allPerms=Array.from(new Set(Object.values(RBAC.roles).flat()));
  v.innerHTML=`<div class="card"><div class="toolbar"><h2>RBAC</h2><span class="tag">تعريف وتقييم</span></div>
  <div class="grid two">
    <div><h3>الأدوار</h3>${Object.entries(RBAC.roles).map(([r,ps])=>`<div class='note'><b>${r}</b>: ${ps.join(', ')}</div>`).join('')}
    <div class="form" style="margin-top:10px"><label>دور جديد<input id="newRole"/></label><label>امتيازات (بفواصل)<input id="newPerms"/></label><button class="btn" id="addRole">حفظ</button></div></div>
    <div><h3>تقييم</h3><div class="form">
      <label>الدور<select id="roleSel">${Object.keys(RBAC.roles).map(r=>`<option>${r}</option>`).join('')}</select></label>
      <label>الامتياز<select id="permSel">${allPerms.map(p=>`<option>${p}</option>`).join('')}</select></label>
      <label>موافقة PDPL؟<select id="consSel"><option value="true">نعم</option><option value="false">لا</option></select></label></div>
      <button class="btn" id="eval">تقييم</button>
      <pre id="rbacOut" class="callout" style="white-space:pre-wrap;margin-top:10px"></pre></div>
  </div></div>`;
  $('#addRole').onclick=()=>{ const r=$('#newRole').value.trim(); const perms=$('#newPerms').value.split(',').map(x=>x.trim()).filter(Boolean); if(!r||!perms.length) return alert('أدخل القيم'); RBAC.roles[r]=perms; alert('تم'); route(); };
  $('#eval').onclick=()=>{ const role=$('#roleSel').value, perm=$('#permSel').value, consent=$('#consSel').value==='true'; $('#rbacOut').textContent=(can(role,perm,consent)?'✅ مسموح':'⛔ مرفوض')+`\nالدور: ${role}\nالامتياز: ${perm}\nالموافقة: ${consent}`; };
}
function configPage(){ const v=$('#view'); const cfg=loadCfg(); v.innerHTML=`<div class="card">
  <div class="toolbar"><h2>الإعدادات</h2><span class="tag">Endpoints</span></div>
  <div class="grid two form">
    <label>SSO Issuer<input id="issuer" value="${cfg.sso.issuer}"/></label>
    <label>Authorize URL<input id="authz" value="${cfg.sso.authorize_url}"/></label>
    <label>Token URL<input id="token" value="${cfg.sso.token_url}"/></label>
    <label>Client ID<input id="cid" value="${cfg.sso.client_id}"/></label>
    <label>Redirect URI<input id="redir" value="${cfg.sso.redirect_uri}"/></label>
  </div>
  <h3>مسارات داخلية</h3>
  <div class="grid two form">
    ${Object.entries(cfg.apis.internal).map(([k,v2])=>`<label>${k}<input data-int="${k}" value="${v2}"/></label>`).join('')}
  </div>
  <div class="tools"><button class="btn" id="saveCfg">حفظ</button><button class="ghost" id="dlCfg">تنزيل config.json</button><button class="ghost" id="resetCfg">استعادة الافتراضي</button></div>
</div>`;
  $('#saveCfg').onclick=()=>{ const next={ sso:{ issuer:$('#issuer').value, authorize_url:$('#authz').value, token_url:$('#token').value, client_id:$('#cid').value, redirect_uri:$('#redir').value }, apis:{ internal:Object.fromEntries($$('[data-int]').map(i=>[i.dataset.int,i.value])) } }; saveCfg(next); alert('تم الحفظ'); };
  $('#dlCfg').onclick=()=>downloadJSON('config.json', loadCfg());
  $('#resetCfg').onclick=()=>{ localStorage.removeItem('nomu_cfg'); alert('تمت الاستعادة'); route(); };
}

/* === سياسات / مساعدة / شروط === */
function privacyPage(){ const v=$('#view'); v.innerHTML=`<div class="card"><div class="toolbar"><h2>سياسة الخصوصية (PDPL)</h2><span class="tag">تنفيذية</span></div>
<ul><li>موافقة ولي الأمر</li><li>تشفير أثناء النقل والتخزين</li><li>RBAC وتسجيل الأثر</li><li>حقوق: الاطلاع/التصحيح/السحب/الحذف</li></ul><button class="ghost" onclick="window.print()">طباعة</button></div>`; }
function childPage(){ const v=$('#view'); v.innerHTML=`<div class="card"><div class="toolbar"><h2>حماية الطفل</h2><span class="tag">سلامة أولًا</span></div>
<ol><li>توثيق الواقعة</li><li>تقييم المخاطر</li><li>الإحالة والمتابعة</li></ol><div class="callout">قناة الإبلاغ متاحة للمخوّلين.</div><button class="ghost" onclick="window.print()">طباعة</button></div>`; }
function helpPage(){ const v=$('#view'); v.innerHTML=`<div class="card"><div class="toolbar"><h2>مركز المساعدة</h2><span class="tag">FAQ</span></div>
<details open><summary><b>الحفظ المحلي</b></summary><p>كل ما تُدخله يُحفظ في LocalStorage ويمكن تصديره JSON/CSV.</p></details>
<details><summary><b>ربط الخلفية</b></summary><p>استبدل دوال API الداخلية بواجهتك الحقيقية (fetch).</p></details></div>`; }
function termsPage(){ const v=$('#view'); v.innerHTML=`<div class="card"><div class="toolbar"><h2>الشروط والأحكام</h2><span class="tag">استخدام</span></div>
<ul><li>الالتزام بالسياسات الوطنية وPDPL.</li><li>حظر مشاركة البيانات خارج المنظومة.</li><li>التكامل عبر القنوات الرسمية.</li></ul><button class="ghost" onclick="window.print()">طباعة</button></div>`; }

/* === API Docs / Export === */
function apiDocsPage(){ const v=$('#view'); const cfg=loadCfg(); v.innerHTML=`<div class="card">
  <div class="toolbar"><h2>API Docs (محاكاة)</h2><span class="tag">Endpoints</span></div>
  <table><thead><tr><th>الكيان</th><th>Endpoint</th></tr></thead><tbody>${Object.entries(cfg.apis.internal).map(([k,val])=>`<tr><td>${k}</td><td><code>${val}</code></td></tr>`).join('')}</tbody></table>
  <h3>POST /api/health/referral</h3><pre class="callout">{ "mrn":"...", "ref_to":"education", "priority":"high", "attachments":["url1"] }</pre>
</div>`; }
function exportPage(){ const v=$('#view'); const db=DB(); v.innerHTML=`<div class="card"><div class="toolbar"><h2>تصدير/استيراد قاعدة البيانات</h2><span class="tag">LocalStorage</span></div>
<div class="tools"><button class="btn" id="dlDb">تنزيل JSON كامل</button><label class="ghost" style="padding:6px 10px;border-radius:10px;cursor:pointer">استيراد JSON<input id="upDb" type="file" accept="application/json" style="display:none"/></label><button class="ghost" id="wipe">تفريغ كامل</button></div>
<pre class="note">المفتاح: ${DB_KEY} • الحجم الحالي: ${new Blob([JSON.stringify(db)]).size} بايت</pre></div>`;
  $('#dlDb').onclick=()=>downloadJSON('nomu_db_backup.json', DB());
  $('#upDb').onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ const obj=JSON.parse(fr.result||'{}'); DB_SAVE(obj); alert('تم الاستيراد'); }catch(err){ alert('JSON غير صالح'); } }; fr.readAsText(f); };
  $('#wipe').onclick=()=>{ if(confirm('سيمسح كل البيانات المحلية')){ DB_SAVE({}); alert('تم'); } };
}

/* ============= Router ============= */
const routes={
  '/intro':intro,'/kpi':kpiPage,
  '/acc/health':()=>accountPage('health'),'/acc/clinic':()=>accountPage('clinic'),'/acc/education':()=>accountPage('education'),
  '/acc/neighborhood':()=>accountPage('neighborhood'),'/acc/nonprofit':()=>accountPage('nonprofit'),'/acc/hr':()=>accountPage('hr'),
  '/acc/csr':()=>accountPage('csr'),'/acc/family':()=>accountPage('family'),'/acc/admin':()=>accountPage('admin'),
  '/dispatch':dispatchPage,'/ops':opsPage,
  '/sponsors':sponsorsPage,'/pricing':pricingPage,
  '/sso':ssoPage,'/rbac':rbacPage,'/config':configPage,
  '/privacy':privacyPage,'/child':childPage,'/help':helpPage,'/terms':termsPage,
  '/export':exportPage,'/apidocs':apiDocsPage
};
if(!location.hash) location.hash='#/intro';
route();
</script>
</body>
</html>
