<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>نمو NOMU — منصة وطنية للطفولة المبكرة</title>
<style>
  :root{ --bg:#0b1220;--card:#121a2b;--muted:#1a2440;--pri:#5ac8fa;--sec:#8ef6d0;--acc:#ffd166;--danger:#ff6b6b;--ok:#22c55e;--text:#e6edf7;--sub:#a7b0c3;--border:#263251;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:18px;--pad:18px;--gap:14px;--gap-lg:22px;--font:system-ui,"Segoe UI",Tahoma,Arial }
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:linear-gradient(180deg,#0b1220 0%,#0b1220 50%,#0e172a 100%);color:var(--text);font:15px/1.6 var(--font)}
  a{color:var(--pri);text-decoration:none}
  .app{display:grid;grid-template-rows:auto 1fr;min-height:100vh}
  header{position:sticky;top:0;z-index:50;background:rgba(11,18,32,.85);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
  .topbar{display:flex;align-items:center;gap:12px;max-width:1200px;margin:auto;padding:10px var(--pad)}
  .logo{display:flex;align-items:center;gap:10px;font-weight:800}.logo .ph{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,var(--pri),var(--sec))}
  .badge{display:inline-flex;align-items:center;gap:6px;background:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--sub);font-size:12px}
  .search{margin-inline-start:auto;position:relative}
  .search input{width:320px;max-width:60vw;background:var(--card);border:1px solid var(--border);color:var(--text);padding:10px 34px 10px 12px;border-radius:10px}
  .search svg{position:absolute;inset-inline-end:10px;top:50%;transform:translateY(-50%);opacity:.7}
  .user{display:flex;align-items:center;gap:10px}
  .avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#4158d0,#c850c0 60%,#ffcc70)}
  .main{max-width:1200px;margin:24px auto;display:grid;grid-template-columns:260px 1fr;gap:var(--gap-lg);padding:0 var(--pad)}
  nav{position:sticky;top:65px;height:fit-content}
  .side{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:10px}
  .group{margin:10px 0}.group h4{margin:6px 12px 8px;color:var(--sub);font-weight:600;font-size:13px}
  .link{display:flex;align-items:center;gap:10px;border-radius:10px;padding:10px 12px;color:var(--text);border:1px solid transparent}
  .link:hover{background:var(--muted);border-color:var(--border)} .link.active{background:linear-gradient(180deg,rgba(90,200,250,.09),rgba(90,200,250,.04));border-color:#274a70}
  .content{display:grid;gap:var(--gap-lg)}
  .cards{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap)}
  .card{grid-column:span 4;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow)}
  .wide{grid-column:span 12}.half{grid-column:span 6}.third{grid-column:span 4}
  .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .tag{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--muted);padding:6px 10px;border-radius:999px;color:var(--sub);font-size:12px}
  button,.btn{background:var(--pri);color:#071426;border:none;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(90,200,250,.25)}
  .ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
  .danger{background:#ff6b6b}.warn{background:#ffd166;color:#1b1100}
  .empty{border:1px dashed var(--border);border-radius:14px;padding:26px;color:var(--sub);text-align:center}
  .grid{display:grid;gap:var(--gap)} .grid.two{grid-template-columns:1fr 1fr} .grid.three{grid-template-columns:repeat(3,1fr)}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th,td{text-align:right;padding:12px;background:#0f172a} th{color:var(--sub);font-size:12px}
  /* Intro */
  .hero{background:linear-gradient(180deg,#0d1830,#0e172a);border:1px solid var(--border);border-radius:18px;padding:22px}
  .pill{display:inline-flex;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--muted);font-size:12px;margin:2px}
  .banner{border:1px dashed var(--border);border-radius:14px;padding:14px;background:#0f172a;color:var(--sub)}
  /* Architecture */
  .arch {display:grid; gap: var(--gap-lg)}
  .arch .grid-2 {display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap)}
  .arch .tree {background: var(--card); border:1px solid var(--border); border-radius: var(--radius); padding: var(--pad)}
  .arch details {border:1px dashed var(--border); border-radius:12px; padding:10px; margin:8px 0; background: #0f172a}
  .arch summary {cursor:pointer; font-weight:700}
  .arch .muted {color: var(--sub); font-size:12px}
  .arch .pill {display:inline-flex; gap:8px; padding:6px 10px; border:1px solid var(--border); background:var(--muted); border-radius:999px; font-size:12px; margin:4px 6px 0 0}
  .arch .badge-ok{background:rgba(34,197,94,.15); border-color:#14532d}
  .arch .searchbar input{width:100%; background:var(--card); border:1px solid var(--border); color:var(--text); padding:10px 12px; border-radius:10px}
  .arch .hit {outline:2px solid var(--pri); border-radius:10px}
  @media (max-width:960px){ .main{grid-template-columns:1fr} nav{position:static} .cards{grid-template-columns:repeat(6,1fr)} .card{grid-column:span 6} .half{grid-column:span 6} .third{grid-column:span 6} .arch .grid-2 {grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="topbar">
      <div class="logo"><div class="ph"></div><span>نمو NOMU</span><span class="badge">National</span></div>
      <nav class="actions">
        <a class="btn" href="#/intro">التعريفات</a>
        <button class="ghost" onclick="openLogin()">تسجيل الدخول</button>
      </nav>
      <div class="search"><input id="q" placeholder="ابحث عن طفل، إحالة، جمعية، مبادرة…" oninput="globalSearch(this.value)" /><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></div>
      <div class="user"><div class="tag" id="roleTag">دخول ضيف</div><div class="avatar"></div></div>
    </div>
  </header>

  <main class="main">
    <nav>
      <div class="side">
        <div class="group">
          <h4>بوابة البداية</h4>
          <a class="link" href="#/intro" data-route>التعريفات & أدوار الشركاء</a>
        </div>
        <div class="group">
          <h4>لوحات</h4>
          <a class="link" href="#/home" data-route>الرئيسية</a>
          <a class="link" href="#/architecture" data-route>خريطة الهيكل</a>
        </div>
        <div class="group">
          <h4>الحسابات</h4>
          <a class="link" href="#/family" data-route data-perm="family:view">حساب الأسرة</a>
          <a class="link" href="#/health" data-route data-perm="health:view">الصحة</a>
          <a class="link" href="#/education" data-route data-perm="education:view">التعليم</a>
          <a class="link" href="#/nonprofit" data-route data-perm="nonprofit:view">الجمعيات</a>
          <a class="link" href="#/csr" data-route data-perm="csr:view">القطاع الخاص (CSR)</a>
          <a class="link" href="#/admin" data-route data-perm="admin:view">اللجنة الوطنية</a>
        </div>
        <div class="group">
          <h4>أدوات</h4>
          <a class="link" href="#/market" data-route data-perm="market:view">سوق الرعاية</a>
          <a class="link" href="#/referrals" data-route data-perm="referrals:view">الإحالات</a>
          <a class="link" href="#/reports" data-route data-perm="reports:view">التقارير</a>
          <a class="link" href="#/settings" data-route>الإعدادات</a>
        </div>
      </div>
    </nav>

    <section class="content" id="view"></section>
  </main>

  <footer class="footer" style="margin:30px auto;max-width:1200px;color:#a7b0c3;text-align:center;padding:10px">
    NOMU — نسخة دمج: التعريفات الافتراضية + المنصة التشغيلية.
  </footer>
</div>

<!-- Minimal modals (Login & Screening/Referral/CSR/Market/IEP are same as earlier where needed) -->
<div class="modal" id="modal-login" style="position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.5)">
  <div style="width:min(520px,94vw);background:#121a2b;border:1px solid #263251;border-radius:16px;padding:18px">
    <h3>تسجيل الدخول</h3>
    <div class="grid two">
      <label>الدور<select id="loginRole"><option value="guest">ضيف</option><option value="family">أسرة</option><option value="health">الصحة</option><option value="education">التعليم</option><option value="nonprofit">جمعية</option><option value="csr">شركة (CSR)</option><option value="admin">لجنة وطنية</option></select></label>
      <label>المنطقة<select id="loginRegion"><option>الرياض</option><option>حائل</option><option>الشرقية</option></select></label>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" onclick="doLogin()">دخول</button>
      <button class="ghost" onclick="closeLogin()">إلغاء</button>
    </div>
  </div>
</div>

<script>
const $=(q,root=document)=>root.querySelector(q); const $$=(q,root=document)=>Array.from(root.querySelectorAll(q));
const store={ load(){ try{ const data=JSON.parse(localStorage.getItem('nomu')||'{}'); this.state=Object.assign({ user:{role:localStorage.getItem('nomu.role')||'guest',region:localStorage.getItem('nomu.region')||'الرياض'}, households:[{id:'H-1001', father:'محمد', mother:'سارة', region:'حائل', children:[{id:'C-501', name:'ليان', dob:'2021-03-10'},{id:'C-502', name:'تركي', dob:'2019-11-02'}]}], screenings:[{id:'S-9001', childId:'C-501', type:'نمو نمائي', date:'2025-09-20', result:'سليم', facility:'مركز صحي شمال حائل'}], referrals:[{id:'R-7001', from:'الصحة', to:'التعليم', childId:'C-502', priority:'عادية', status:'قيد المعالجة', created:'2025-09-25'}], ieps:[{id:'IEP-3001', childId:'C-502', goals:'تحسين المهارات اللغوية', review:'2025-12-01'}], nonprofits:[{id:'NPO-10', name:'جمعية نماء للطفولة', region:'حائل', programs:3, beneficiaries:120}], marketplace:[{id:'M-1', title:'جلسات تدخل مبكر لحائل', kpi:'100 طفل خلال 6 أشهر', ask:250000, funded:120000, owner:'جمعية نماء'}, {id:'M-2', title:'فحوص سمع لحديثي الولادة – الشرقية', kpi:'300 وليد', ask:180000, funded:45000, owner:'صحة الشرقية'}], csr:[{id:'CSR-100', company:'شركة الأفق', amount:50000, to:'M-1', date:'2025-10-01'}]}, data)}catch(e){ this.state={} } }, save(){ localStorage.setItem('nomu', JSON.stringify(this.state)) } };
store.load();

/* RBAC */
const permsByRole={ guest:['home:view','reports:view','market:view','referrals:view','settings:view'], family:['home:view','family:view','referrals:view','screening:create','settings:view'], health:['home:view','health:view','screening:create','referrals:create','reports:view','settings:view'], education:['home:view','education:view','iep:create','referrals:view','reports:view','settings:view'], nonprofit:['home:view','nonprofit:view','market:create','reports:view','settings:view'], csr:['home:view','csr:view','csr:create','market:view','reports:view','settings:view'], admin:['home:view','admin:view','family:view','health:view','education:view','nonprofit:view','csr:view','market:view','referrals:view','reports:view','settings:view'] };
function can(perm){ const role=store.state.user.role||'guest'; return (permsByRole[role]||[]).includes(perm) }
function enforceRBAC(){ $$('[data-perm]').forEach(el=>{ el.hidden=!can(el.getAttribute('data-perm')) }) }

/* Utils */
function fmt(n){return new Intl.NumberFormat('ar-SA').format(n)} function today(){return new Date().toISOString().slice(0,10)}
function toast(msg){ const wrap=document.body; const t=document.createElement('div'); t.style.cssText='position:fixed;left:18px;bottom:18px;background:#111b;color:#fff;padding:10px 14px;border-radius:12px;z-index:9999'; t.textContent=msg; wrap.appendChild(t); setTimeout(()=>t.remove(),2500) }
function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/csv;charset=utf-8;'})); a.download=filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),500) }

/* Charts */
function drawTrend(el,title,data){ const w=el.clientWidth||600,h=180,p=24; const min=Math.min(...data,0),max=Math.max(...data,1); const rng=(max-min)||1; const toX=i=>p + (i*(w-2*p))/(data.length-1); const toY=v=>h-p - ((v-min)*(h-2*p))/rng; const pts=data.map((v,i)=>`${toX(i)},${toY(v)}`).join(' '); const circles=data.map((v,i)=>`<circle cx="${toX(i)}" cy="${toY(v)}" r="3.5" fill="${getComputedStyle(document.documentElement).getPropertyValue('--pri')}"/>`).join(''); el.innerHTML = `<b>${title}</b><svg viewBox="0 0 ${w} ${h}" width="100%" height="${h}"><polyline points="${pts}" fill="none" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--pri')}" stroke-width="3"/>${circles}</svg>`; }

/* Router */
function parseHash(){ const [path,q='']=(location.hash.replace('#','')||'/intro').split('?'); const params=Object.fromEntries(new URLSearchParams(q).entries()); return {path,params} }
const routes={'/intro':viewIntro,'/home':viewHome,'/family':viewFamily,'/health':viewHealth,'/education':viewEducation,'/nonprofit':viewNonprofit,'/csr':viewCSR,'/admin':viewAdmin,'/market':viewMarket,'/referrals':viewReferrals,'/reports':viewReports,'/settings':viewSettings,'/architecture':viewArchitecture};
function router(){ const {path,params}=parseHash(); $$('a.link').forEach(a=>a.classList.toggle('active',a.getAttribute('href')===`#${path}`)); const el=$('#view'); el.innerHTML=''; (routes[path]||viewIntro)(el,params); enforceRBAC() }
window.addEventListener('hashchange',router);

/* Intro view */
function viewIntro(root){
  root.innerHTML = `
  <div class="card hero">
    <h2>التعريفات الأساسية للمنصة</h2>
    <p class="banner">منصة نمو NOMU: منظومة وطنية تربط الأسرة بالقطاعات (الصحة/التعليم/الدعم الاجتماعي) والجمعيات والقطاع الخاص بإشراف اللجنة الوطنية.</p>
    <div class="grid three" style="margin-top:10px">
      <div class="card"><b>رحلة الطفل</b><p>ما قبل الزواج/الحمل → الحمل → الولادة → 0–3 → 3–6 → خدمات الأسرة</p><div class="pill">Transitions</div><div class="pill">KPIs</div></div>
      <div class="card"><b>التكاملات</b><p>الصحة: SEHA/NPHIES — التعليم: نور — الدعم: الضمان — التطوع الوطني</p><div class="pill">APIs</div></div>
      <div class="card"><b>الخصوصية</b><p>PDPL، موافقات، تشفير، MFA، Audit Trail، PoLP</p><div class="pill">PDPL</div></div>
    </div>
    <div class="grid two">
      <div class="card"><b>سوق الرعاية (CSR)</b><p>تمويل مبادرات مرتبطة بمؤشرات أثر تنموية، محفظة رقمية وتقارير أثر.</p></div>
      <div class="card"><b>كيف تبدأ؟</b><p>اختر دورك ثم ابدأ. يمكنك تغيير الدور لاحقًا من “تسجيل الدخول”.</p></div>
    </div>
    <div class="grid" style="margin-top:6px">
      <button class="btn" onclick="location.hash='#/home'">بدء استخدام المنصة ← لوحة القيادة</button>
      <button class="ghost" onclick="openLogin()">تسجيل الدخول/تبديل الدور</button>
    </div>
  </div>

  <div class="card">
    <div class="grid two">
      <div>
        <h3>مصفوفة أدوار الشركاء (مختصرة)</h3>
        <table>
          <thead><tr><th>الشريك</th><th>مسؤوليات</th><th>يوفّر</th><th>يستهلك</th><th>مخرجات</th></tr></thead>
          <tbody id="rolesBody"></tbody>
        </table>
        <div class="grid" style="margin-top:8px">
          <button class="ghost" onclick="exportRoles()">تصدير Matrix.csv</button>
        </div>
      </div>
      <div>
        <h3>تعريف كل حساب وقوائمه</h3>
        <ul id="accountDefs" style="line-height:1.9"></ul>
        <div id="menusByAccount" class="grid two" style="margin-top:10px"></div>
      </div>
    </div>
  </div>`;

  renderRoles(); renderAccountDefs();
}

/* Roles & Accounts (Intro helpers) */
const rolesMatrix=[
  {partner:'الأسرة', resp:['تحديث ملف الحمل/الطفل','الالتزام بالمواعيد','الموافقة على مشاركة البيانات'], provide:['بيانات ديموغرافية','سجل منزلي'], consume:['توصيات','نتائج فحوص'], out:['حجوزات','طلبات إحالة']},
  {partner:'الصحة', resp:['فحوص نمائية ووليد','تدخل مبكر','فحص اكتئاب ما بعد الولادة'], provide:['نتائج فحص','خطة تدخل'], consume:['ملف الطفل','جاهزية المدرسة'], out:['تقارير قطاعية','إحالات للتعليم']},
  {partner:'التعليم', resp:['جاهزية المدرسة','IEP/دمج','متابعة منزلية'], provide:['تقارير جاهزية','IEP'], consume:['تقارير نمائية','دعم الأسرة'], out:['قرارات دمج','خطط فردية']},
  {partner:'الموارد البشرية', resp:['دعم مالي وأسري','منصة التطوع'], provide:['بيانات دعم','مؤشرات استقرار'], consume:['احتياج الأسرة'], out:['قرارات دعم','فرص تطوع']},
  {partner:'الجمعيات', resp:['برامج تنموية','إرشاد','قياس أثر'], provide:['تقارير أثر','بيانات مستفيدين'], consume:['إحالات','تمويل CSR'], out:['نتائج برامج']},
  {partner:'القطاع الخاص', resp:['تمويل مبادرات','حوكمة CSR'], provide:['مساهمات مالية'], consume:['تقارير أثر'], out:['شراكات مستدامة']},
  {partner:'اللجنة الوطنية', resp:['إشراف وتكامل وطني','سياسات وحوكمة بيانات'], provide:['لوحات وطنية','مؤشرات موحدة'], consume:['بيانات الجهات'], out:['قرارات سياسات']}
];
function renderRoles(){ $('#rolesBody').innerHTML = rolesMatrix.map(r=>`<tr><td>${r.partner}</td><td>${r.resp.join('، ')}</td><td>${r.provide.join('، ')}</td><td>${r.consume.join('، ')}</td><td>${r.out.join('، ')}</td></tr>`).join('') }
function exportRoles(){ const headers=['partner','responsibilities','provides','consumes','outputs']; const rows=rolesMatrix.map(r=>({partner:r.partner,responsibilities:r.resp.join('|'),provides:r.provide.join('|'),consumes:r.consume.join('|'),outputs:r.out.join('|')})); const csv = headers.join(',') + '\n' + rows.map(o=>headers.map(h=>`"${(''+o[h]).replaceAll('"','""')}"`).join(',')).join('\n'); download('Roles_Matrix.csv',csv) }

const accountDefs=[
  {name:'حساب الأسرة', def:'إدارة رحلة الطفل كاملة من الحمل حتى الجاهزية.', menus:['ملف الحمل والطفل','الخدمات المساندة','التوصيات الذكية','المكتبة','حجوزات الفحص']},
  {name:'وزارة الصحة', def:'فحوص نمائية/وليد والتدخل المبكر وصحة الأم النفسية.', menus:['سجل الفحوص','الإحالات','التدخل المبكر','تقارير قطاعية','تكامل NPHIES/SEHA']},
  {name:'وزارة التعليم', def:'الجاهزية وIEP والدمج والمتابعة المنزلية.', menus:['جاهزية المدرسة','IEP','إشعارات الأسرة','إحالات واردة','تكامل نور']},
  {name:'وزارة الموارد البشرية', def:'الدعم المالي والأسري والتطوع ومؤشرات الاستقرار.', menus:['محفظة الدعم','برامج تمكين','المنصة الوطنية للتطوع','تقارير الاستقرار']},
  {name:'الجمعيات', def:'برامج ومبادرات، مستفيدون، متطوعون، قياس أثر.', menus:['البرامج','المستفيدون','المتطوعون','قياس الأثر']},
  {name:'القطاع الخاص (CSR)', def:'تمويل المبادرات وتقارير أثر وملف حوكمة.', menus:['سوق الرعاية','مساهمات الشركة','تقارير الأثر','ملف CSR']},
  {name:'اللجنة الوطنية', def:'إشراف موحد وحوكمة وتبادل بيانات ولوحات.', menus:['لوحة وطنية','سياسات وتكامل','حوكمة البيانات','التمويل الوطني']}
];
function renderAccountDefs(){
  $('#accountDefs').innerHTML = accountDefs.map(a=>`<li><b>${a.name}:</b> ${a.def}</li>`).join('');
  $('#menusByAccount').innerHTML = accountDefs.map(a=>`
    <div class="card">
      <b>${a.name}</b>
      <p class="sub" style="color:#a7b0c3">${a.def}</p>
      <div>${a.menus.map(m=>`<span class="pill">${m}</span>`).join('')}</div>
    </div>`).join('');
}

/* Home view (light) */
function kpiCard(title,value){ return `<div class="card third"><span class="k">${title}</span><b class="v" style="display:block;font-size:26px;margin-top:6px">${value}</b></div>` }
function viewHome(root){
  const totalKids = store.state.households.reduce((a,h)=>a+h.children.length,0);
  const screened = store.state.screenings.length;
  const referrals = store.state.referrals.length;
  const funded = store.state.marketplace.reduce((a,m)=>a+m.funded,0);
  root.innerHTML = `
    <div class="toolbar">
      <h2>لوحة وطنية مختصرة</h2>
      <div class="actions"><span class="tag">المنطقة: ${store.state.user.region}</span></div>
    </div>
    <div class="cards">
      ${kpiCard('الأطفال في السجل', fmt(totalKids))}
      ${kpiCard('فحوص نمائية مُسجلة', fmt(screened))}
      ${kpiCard('إحالات نشطة', fmt(referrals))}
      ${kpiCard('تمويل CSR/منح (ر.س)', fmt(funded))}
      <div class="card wide" id="chart"></div>
    </div>`;
  drawTrend($('#chart'),'أطفال مفحوصون خلال 6 أشهر',[40,55,61,70,86,93]);
}

/* Stubs for other views (optional minimal to keep file compact) */
function viewFamily(r){ r.innerHTML = `<div class="empty"><b>واجهة حساب الأسرة</b><div>مثال توضيحي مختصر — يمكن توسيعه لاحقًا.</div></div>` }
function viewHealth(r){ r.innerHTML = `<div class="empty"><b>واجهة الصحة</b></div>` }
function viewEducation(r){ r.innerHTML = `<div class="empty"><b>واجهة التعليم</b></div>` }
function viewNonprofit(r){ r.innerHTML = `<div class="empty"><b>واجهة الجمعيات</b></div>` }
function viewCSR(r){ r.innerHTML = `<div class="empty"><b>واجهة القطاع الخاص (CSR)</b></div>` }
function viewAdmin(r){ r.innerHTML = `<div class="empty"><b>واجهة اللجنة الوطنية</b></div>` }
function viewMarket(r){ r.innerHTML = `<div class="empty"><b>سوق الرعاية</b></div>` }
function viewReferrals(r){ r.innerHTML = `<div class="empty"><b>الإحالات</b></div>` }
function viewReports(r){ r.innerHTML = `<div class="empty"><b>التقارير</b></div>` }
function viewSettings(r){ r.innerHTML = `<div class="empty"><b>الإعدادات</b></div>` }

/* Architecture page (compact) */
const archData={ national:{items:['لوحة قيادة وطنية KPIs','إدارة التكامل','السياسات','تمويل وطني','تقارير وطنية','تكامل: NPHIES/SEHA – نور – الضمان – التطوع – نفاذ']}, accounts:[{ key:'family:view', title:'حساب الأسرة', bullets:['ملف الطفل','الخدمات المساندة','التوصيات','المكتبة','حجوزات']},{ key:'health:view', title:'وزارة الصحة', bullets:['فحوص نمائية','تدخل مبكر','صحة نفسية','تكامل NPHIES/SEHA']},{ key:'education:view', title:'وزارة التعليم', bullets:['جاهزية المدرسة','IEP','التواصل مع الأسرة']},{ key:'nonprofit:view', title:'الجمعيات', bullets:['البرامج','المستفيدون','المتطوعون','قياس أثر']},{ key:'csr:view', title:'القطاع الخاص', bullets:['سوق الرعاية','محفظة','تقارير الأثر']},{ key:'admin:view', title:'اللجنة الوطنية', bullets:['إشراف وطني','حوكمة','PDPL','تقارير وطنية']},{ key:'family:view', title:'الموارد البشرية', bullets:['الدعم المالي','الدعم الأسري','مؤشرات الاستقرار','التطوع'] }], shared:['SSO','توقيع إلكتروني','لوحات وتنبيهات','مكتبة','دعم الوصول','تطبيق جوال','API + CSV/PDF','PoLP/MFA/Audit/Aware/PDPL'], journey:[{title:'ما قبل الزواج/الحمل',x:'الصحة + الجمعيات',kpi:'% المقبلين المفحوصين'},{title:'الحمل',x:'المستشفيات + دعم نفسي',kpi:'% الأمهات المفحوصات نفسيًا'},{title:'الولادة',x:'فحص مواليد + NICU',kpi:'% المواليد المفحوصين'},{title:'0–3 سنوات',x:'متابعة نمو + تدخل',kpi:'% الأطفال المفحوصين نمائيًا'},{title:'3–6 سنوات',x:'الدمج ورياض الأطفال',kpi:'% الجاهزين للمدرسة'},{title:'الخدمات المساندة',x:'إرشاد + دعم مالي',kpi:'% الأسر المستفيدة'}]};
function renderDetails(title,items){ return `<details open><summary><b>${title}</b></summary>${items.map(i=>`<div class="tree">${i}</div>`).join('')}</details>` }
function renderAccounts(){ return archData.accounts.filter(a=>can(a.key)||a.key==='family:view').map(a=>`<details open><summary><b>${a.title}</b></summary>${a.bullets.map(b=>`<div class="tree">• ${b}</div>`).join('')}</details>`).join('') }
function renderJourney(){ return archData.journey.map(j=>`<details open><summary>${j.title}</summary><div class="muted">${j.x}</div><span class="pill">${j.kpi}</span></details>`).join('') }
function kpisFromStore(){ const totalKids=store.state.households.reduce((a,h)=>a+h.children.length,0); const screenedKids=new Set(store.state.screenings.map(s=>s.childId)).size; const pctScreened= totalKids? Math.round(screenedKids*100/totalKids):0; const csrTotal=store.state.csr.reduce((a,c)=>a+c.amount,0); const kids=store.state.households.flatMap(h=>h.children); const now=new Date(); const ageYears=d=>{const dt=new Date(d);return isNaN(dt)?0:((now-dt)/(365.25*24*3600*1000))}; const elig=kids.filter(k=>{const a=ageYears(k.dob); return a>=5&&a<7}); const activeRefKids=new Set(store.state.referrals.filter(r=>r.status!=='مكتملة').map(r=>r.childId)); const eligReady=elig.filter(k=> store.state.screenings.some(s=>s.childId===k.id) && !activeRefKids.has(k.id)).length; const pctReady=elig.length? Math.round(eligReady*100/elig.length):0; const byMonth={}, csrByMonth={}; store.state.screenings.forEach(s=>{ const m=(s.date||today()).slice(0,7); byMonth[m]=(byMonth[m]||0)+1 }); store.state.csr.forEach(c=>{ const m=(c.date||today()).slice(0,7); csrByMonth[m]=(csrByMonth[m]||0)+(c.amount||0) }); const months=Object.keys(byMonth).sort().slice(-6), csrMonths=Object.keys(csrByMonth).sort().slice(-6); const trend=months.map(m=>byMonth[m]); const csrTrend=csrMonths.map(m=>csrByMonth[m]); const activeReferrals=store.state.referrals.filter(r=>r.status!=='مكتملة').length; const fundedInitiatives=store.state.marketplace.filter(m=>(m.funded||0)>0).length; return {pctScreened,pctReady,csrTotal,trend,csrTrend,activeReferrals,fundedInitiatives}; }
function viewArchitecture(root){ const k=kpisFromStore(); root.innerHTML=`
  <div class="toolbar"><h2>خريطة هيكل منصة نمو</h2><div class="actions"><span class="tag">يعرض العناصر وفق صلاحيات دورك</span></div></div>
  <div class="arch">
    <div class="grid two">
      <div class="card tree">${renderDetails('الطبقة الوطنية', archData.national.items)}<hr style="border-color:var(--border)"/><b>المكونات المشتركة</b>${renderDetails('المكونات المشتركة', archData.shared)}</div>
      <div class="card tree"><b>حسابات المنصة</b><div id="archAccounts">${renderAccounts()}</div></div>
    </div>
    <div class="card"><b>رحلة الطفل (Transitions)</b><div id="archJourney">${renderJourney()}</div></div>
    <div class="card"><b>مؤشرات رئيسية</b>
      <div class="grid three">
        ${kpiCard('% الأطفال المفحوصين نمائيًا', k.pctScreened+'%')}
        ${kpiCard('% الأطفال الجاهزين للمدرسة', k.pctReady+'%')}
        ${kpiCard('CSR/منح (ر.س)', fmt(k.csrTotal))}
        ${kpiCard('إحالات نشطة', fmt(k.activeReferrals))}
        ${kpiCard('مبادرات ممولة', fmt(k.fundedInitiatives))}
      </div>
    </div>
    <div class="grid two">
      <div class="card" id="archChart"></div>
      <div class="card" id="archChart2"></div>
    </div>
  </div>`;
  drawTrend($('#archChart'),'فحوص شهرية (عدد)', k.trend.length?k.trend:[0,0,0,0,0,0]);
  drawTrend($('#archChart2'),'تمويل CSR شهري (ر.س)', k.csrTrend.length?k.csrTrend:[0,0,0,0,0,0]);
}

/* Tables & search (lite) */
function globalSearch(q){ q=(q||'').trim(); if(q.length<2) return; const inStr=s=>(s||'').toString().toLowerCase(); const ql=q.toLowerCase(); const h=store.state.households[0]; const kid=h?.children?.find(c=> inStr(c.id).includes(ql) || inStr(c.name).includes(ql)); if(kid){ location.hash=`#/home`; toast('فتح ملف الطفل: '+kid.id); return } const ref=store.state.referrals.find(r=>inStr(r.id).includes(ql)||inStr(r.childId).includes(ql)); if(ref){ location.hash='#/referrals'; toast('عرض الإحالة: '+ref.id); return } const m=store.state.marketplace.find(m=>inStr(m.title).includes(ql)); if(m){ location.hash='#/market'; toast('عرض المبادرة: '+m.id); return } toast('لا نتائج مطابقة') }

/* Session */
function openLogin(){ $('#modal-login').style.display='grid' } function closeLogin(){ $('#modal-login').style.display='none' }
function doLogin(){ const role=$('#loginRole').value; const region=$('#loginRegion').value; store.state.user={role,region}; localStorage.setItem('nomu.role',role); localStorage.setItem('nomu.region',region); $('#roleTag').textContent='دور: '+role; closeLogin(); router() }

/* Init */
function init(){ if(!location.hash) location.hash='#/intro'; $('#roleTag').textContent='دور: '+(store.state.user.role||'guest'); router(); enforceRBAC(); }
init();
</script>
</body>
</html>
