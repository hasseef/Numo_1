<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>منصة نمو – v7.1 (ملف واحد)</title>
<meta name="color-scheme" content="light only">
<style>
:root{--ink:#0f172a;--muted:#64748b;--border:#e6e9ef;--bg:#fff;--brand:#0ea5e9}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic UI",sans-serif;color:var(--ink);background:#fff}
header .topbar{display:flex;align-items:center;gap:12px;padding:12px 14px;min-height:78px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#fff;z-index:60}
.brand{display:flex;align-items:center;gap:10px;cursor:pointer;min-width:0}.brand .mark svg{display:block}.brand .word{font-weight:900;margin-top:2px}.brand .sub{font-size:11px;color:var(--muted);margin-top:0}
.home-btn,.btn{display:inline-flex;align-items:center;gap:6px;background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-size:13px;text-decoration:none;cursor:pointer}
.btn.ghost{background:#fff;border:1px solid var(--border);color:var(--ink)}
.left-logos{margin-inline-start:auto;display:flex;align-items:center;gap:6px}.left-logos img{height:24px;width:auto;object-fit:contain;opacity:.95}
.icon{width:18px;height:18px;vertical-align:-3px}.bell{position:relative;width:40px;height:40px;border:1px solid var(--border);border-radius:12px;background:#fff;display:flex;align-items:center;justify-content:center}
.badge-dot{position:absolute;inset:auto auto 2px 2px;width:8px;height:8px;border-radius:99px;background:#ef4444}
@media (min-width:980px){.layout{display:grid;grid-template-columns:300px 1fr;gap:16px;padding:16px}.mega-left{position:sticky;top:90px;align-self:start}.mega-left details{border:1px solid var(--border);border-radius:12px;margin:8px 0;background:#fff;overflow:hidden}
.mega-left summary{list-style:none;cursor:pointer;padding:10px 12px;font-weight:700}.mega-left summary::-webkit-details-marker{display:none}.mega-left .group-body{padding:8px 10px;display:grid;gap:6px}
.mega-left a{padding:8px 10px;border-radius:10px;color:#334155;text-decoration:none;display:flex;align-items:center;gap:8px}.mega-left a:hover{background:#f1f5f9}}
#view{padding:16px}.card{border:1px solid var(--border);border-radius:12px;background:#fff;padding:16px}
.section-title{display:flex;align-items:center;gap:8px;margin:0 0 8px 0}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 8px}.tab{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer;font-weight:600;text-decoration:none;color:var(--ink);display:inline-flex;align-items:center;gap:6px}
.tab[aria-selected="true"]{border-color:#0ea5e9;outline:2px solid rgba(14,165,233,.15)}
.kpi-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}.kpi-card{border:1px solid var(--border);border-radius:12px;background:#fff;padding:12px;display:flex;gap:10px;align-items:flex-start;cursor:pointer}
.kpi-card:hover{box-shadow:0 8px 24px rgba(2,12,27,.08)}.kpi-icon{font-size:0;width:36px;height:36px;border-radius:10px;background:#f1f5f9;display:flex;align-items:center;justify-content:center}
.kpi-value{font-weight:800;font-size:18px}.kpi-title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.kpi-meta{display:flex;gap:10px;align-items:center;margin-top:4px;color:var(--muted);font-size:12px}
.badge{padding:3px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px}.badge.ok{color:#065f46;border-color:#bbf7d0;background:#ecfdf5}.badge.warn{color:#92400e;border-color:#fde68a;background:#fffbeb}.badge.bad{color:#991b1b;border-color:#fecaca;background:#fef2f2}.badge.info{color:#075985;border-color:#bae6fd;background:#eff6ff}
.badge.tgt{color:#0369a1;border-color:#bae6fd;background:#eff6ff}.badge.unit{color:#334155;border-color:#e2e8f0;background:#fff}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}.table th{font-size:13px;color:var(--muted);padding:0 10px;cursor:pointer;user-select:none}.table td{background:#fff;border:1px solid var(--border);padding:10px}
.table tr td:first-child{border-radius:12px 0 0 12px}.table tr td:last-child{border-radius:0 12px 12px 0}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 12px}.input{border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;background:#fff}
.services-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}.service{border:1px solid var(--border);border-radius:12px;background:#fff;padding:12px}.service h4{margin:0 0 6px 0}.service p{margin:0;color:var(--muted);font-size:13px}
.form-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}.form-grid .field{display:flex;flex-direction:column;gap:6px}
.form-grid .field input,.form-grid .field select{border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff}
.hint{font-size:12px;color:#64748b;margin-top:2px}.req:after{content:" *"; color:#ef4444; font-weight:700}.input.bad{border-color:#ef4444}.role-chip{padding:3px 8px;border:1px dashed #cbd5e1;border-radius:999px;font-size:12px;color:#475569;background:#f8fafc}
@media (max-width:979px){.brand .word{font-size:18px}.layout{display:block;padding:12px}.mega-left{display:none}.tabs,.toolbar{display:block}.tabs>*{display:block;margin:6px 0}.kpi-grid{grid-template-columns:1fr 1fr}.services-grid{grid-template-columns:1fr}.form-grid{grid-template-columns:1fr}
.fab-home{position:fixed;right:14px;bottom:14px;z-index:9998;width:52px;height:52px;border-radius:999px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;background:#0ea5e9;color:#fff;font-size:22px;text-decoration:none;box-shadow:0 10px 30px rgba(2,12,27,.18)}}
a:focus,button:focus,input:focus,select:focus{outline:2px solid #0ea5e9;outline-offset:2px}
svg.i{width:18px;height:18px;stroke:#0f172a;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}svg.i.muted{stroke:#64748b}svg.i.brand{stroke:#0ea5e9}
@media print{header,.mega-left,.fab-home{display:none!important}#view{padding:0}.card{box-shadow:none;border:1px solid #ddd;border-radius:0}}
</style>
</head>
<body>
<header><div class="topbar">
  <div class="brand" onclick="location.hash='#/overview'" role="link" tabindex="0" aria-label="الرئيسية">
    <div class="mark"><!-- شعار نمو SVG خفيف -->
      <svg xmlns='http://www.w3.org/2000/svg' width='52' height='52' viewBox='0 0 200 200' aria-label='شعار نمو'>
        <defs><linearGradient id='g1' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='#0ea5e9'/><stop offset='100%' stop-color='#22c55e'/></linearGradient></defs>
        <circle cx='70' cy='100' r='38' fill='#0ea5e9' fill-opacity='0.9'/><circle cx='110' cy='70' r='38' fill='#22c55e' fill-opacity='0.9'/><circle cx='110' cy='130' r='38' fill='#facc15' fill-opacity='0.9'/>
        <circle cx='96' cy='100' r='62' fill='none' stroke='url(#g1)' stroke-width='8' opacity='.75'/>
      </svg>
    </div>
    <div><div class="word">منصة نمو</div><div class="sub">تكامل وطني لتنمية الطفولة المبكرة</div></div>
  </div>
  <a class="home-btn" href="#/overview">الرئيسية</a>
  <button class="btn ghost" id="globalSearchBtn">بحث موحّد</button>
  <button class="btn ghost" id="mobileMenuBtn">القائمة ☰</button>
  <div class="left-logos">
    <!-- شعاري رؤية 2030 وتلبية كصور مضمّنة بدون نصوص إضافية -->
    <img alt="شعار رؤية 2030" src="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 240 80'%3E%3Crect width='240' height='80' fill='white'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Segoe UI' font-size='22' fill='%230f172a'%3E%D8%B1%D8%A4%D9%8A%D8%A9%202030%3C/text%3E%3C/svg%3E">
    <img alt="شعار تلبية" src="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 240 80'%3E%3Crect width='240' height='80' fill='white'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Segoe UI' font-size='22' fill='%230f172a'%3E%D8%AA%D9%84%D8%A8%D9%8A%D8%A9%3C/text%3E%3C/svg%3E">
    <button class="btn" id="desktopLoginBtn">تسجيل الدخول</button>
    <button id="bell" class="bell" aria-label="الإشعارات">
      <svg class="i muted" viewBox="0 0 24 24"><path d="M15 17h5l-1.4-1.4A2 2 0 0 1 18 14.2V11a6 6 0 0 0-12 0v3.2a2 2 0 0 1-.6 1.4L4 17h5"/><path d="M10 21a2 2 0 0 0 4 0"/></svg><span class="badge-dot"></span>
    </button>
  </div>
</div></header>

<!-- أيقونات -->
<svg xmlns="http://www.w3.org/2000/svg" style="display:none">
  <symbol id="ico-health" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/><rect x="3" y="3" width="18" height="18" rx="3"/></symbol>
  <symbol id="ico-clinic" viewBox="0 0 24 24"><path d="M3 21V10l9-7 9 7v11"/><path d="M9 21V12h6v9"/></symbol>
  <symbol id="ico-edu" viewBox="0 0 24 24"><path d="M3 7l9-4 9 4-9 4-9-4"/><path d="M21 10v6"/><path d="M3 10v6l9 4 9-4"/></symbol>
  <symbol id="ico-town" viewBox="0 0 24 24"><path d="M3 21V8h6v13M9 21h12V10h-6v11"/><path d="M9 8V3h6v7"/></symbol>
  <symbol id="ico-nonprofit" viewBox="0 0 24 24"><path d="M12 21s-7-4.5-7-10a4 4 0 0 1 7-2 4 4 0 0 1 7 2c0 5.5-7 10-7 10z"/></symbol>
  <symbol id="ico-mhrsd" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-8 0v2"/><circle cx="12" cy="7" r="4"/></symbol>
  <symbol id="ico-csr" viewBox="0 0 24 24"><path d="M3 13h18M5 21h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2z"/></symbol>
  <symbol id="ico-family" viewBox="0 0 24 24"><circle cx="7" cy="8" r="3"/><circle cx="17" cy="8" r="3"/><path d="M2 21v-2a5 5 0 0 1 5-5h0M22 21v-2a5 5 0 0 0-5-5h0"/></symbol>
  <symbol id="ico-admin" viewBox="0 0 24 24"><path d="M12 22s8-3 8-10V5l-8-3-8 3v7c0 7 8 10 8 10z"/></symbol>
  <symbol id="ico-kpi" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 15l3-3 2 2 5-5"/></symbol>
  <symbol id="ico-form" viewBox="0 0 24 24"><path d="M4 4h16v16H4z"/><path d="M8 8h8M8 12h8M8 16h8"/></symbol>
</svg>

<div class="layout">
  <aside class="mega-left" aria-label="القائمة الرئيسية">
    <details open><summary>البدء السريع</summary><div class="group-body">
      <a href="#/overview"><svg class="i" viewBox="0 0 24 24"><path d="M3 12l9-9 9 9"/><path d="M9 21V9h6v12"/></svg> نظرة عامة</a>
      <a href="#/intro"><svg class="i" viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5z"/><path d="M3 21a9 9 0 0 1 18 0"/></svg> من نحن</a>
      <a href="#/services"><svg class="i" viewBox="0 0 24 24"><path d="M10 6h11M3 6h3M10 12h11M3 12h6M10 18h11M3 18h8"/></svg> الخدمات</a>
    </div></details>
    <details><summary>الحسابات</summary><div class="group-body">
      <a href="#/acc/health"><svg class="i" viewBox="0 0 24 24"><use href="#ico-health"/></svg> وزارة الصحة</a>
      <a href="#/acc/clinic"><svg class="i" viewBox="0 0 24 24"><use href="#ico-clinic"/></svg> المراكز الصحية</a>
      <a href="#/acc/education"><svg class="i" viewBox="0 0 24 24"><use href="#ico-edu"/></svg> وزارة التعليم</a>
      <a href="#/acc/neighborhood"><svg class="i" viewBox="0 0 24 24"><use href="#ico-town"/></svg> مراكز الأحياء</a>
      <a href="#/acc/nonprofit"><svg class="i" viewBox="0 0 24 24"><use href="#ico-nonprofit"/></svg> الجمعيات</a>
      <a href="#/acc/mhrsd"><svg class="i" viewBox="0 0 24 24"><use href="#ico-mhrsd"/></svg> الموارد البشرية والتنمية</a>
      <a href="#/acc/csr"><svg class="i" viewBox="0 0 24 24"><use href="#ico-csr"/></svg> القطاع الخاص</a>
      <a href="#/acc/family"><svg class="i" viewBox="0 0 24 24"><use href="#ico-family"/></svg> الأسرة</a>
      <a href="#/acc/admin"><svg class="i" viewBox="0 0 24 24"><use href="#ico-admin"/></svg> اللجنة الوطنية</a>
    </div></details>
    <details><summary>التشغيل والتقارير</summary><div class="group-body">
      <a href="#/operations"><svg class="i" viewBox="0 0 24 24"><path d="M3 12h18M3 6h18M3 18h18"/></svg> التشغيل</a>
      <a href="#/reports"><svg class="i" viewBox="0 0 24 24"><path d="M3 3h18v18H3z"/><path d="M7 15l3-3 2 2 5-5"/></svg> التقارير</a>
      <a href="#/kpi"><svg class="i" viewBox="0 0 24 24"><use href="#ico-kpi"/></svg> مؤشرات KPI</a>
    </div></details>
    <details><summary>التكامل</summary><div class="group-body">
      <a href="#/integration"><svg class="i" viewBox="0 0 24 24"><path d="M3 12h6l3-3 3 6 3-3h3"/><path d="M3 6h6M15 18h6"/></svg> تكامل الشركاء</a>
    </div></details>
    <details><summary>الدعم والجودة</summary><div class="group-body">
      <a href="#/support"><svg class="i" viewBox="0 0 24 24"><path d="M12 22s8-3 8-10V5l-8-3-8 3v7c0 7 8 10 8 10z"/></svg> الدعم الفني</a>
      <a href="#/policies"><svg class="i" viewBox="0 0 24 24"><path d="M6 4h12v16H6z"/><path d="M9 4v16"/></svg> الأدلة والسياسات</a>
      <a href="#/contact"><svg class="i" viewBox="0 0 24 24"><path d="M22 12H2"/><path d="M2 12l6-6M2 12l6 6"/></svg> اتصل بنا</a>
    </div></details>
  </aside>

  <section id="view" class="content">
    <div class="card"><h2 class="section-title">أهلًا بك في منصة نمو</h2>
      <p>منصة وطنية تُعنى بتنمية الطفولة المبكرة عبر التكامل بين القطاعات وتوحيد الجهود والبيانات والمبادرات.</p>
    </div>
    <div class="kpi-grid" id="kpiHome" style="margin-top:12px"></div>
  </section>
</div>

<a class="fab-home" href="#/overview" aria-label="الرئيسية" style="display:none">⌂</a>

<!-- تسجيل الدخول -->
<div id="loginBackdrop" style="position:fixed;inset:0;background:rgba(2,12,27,.45);display:none;z-index:10000"></div>
<div id="loginWrap" style="position:fixed;inset:0;display:none;place-items:center;z-index:10001">
  <div id="loginCard" role="dialog" aria-modal="true" aria-labelledby="loginTitle" style="width:min(92vw,720px);background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 20px 60px rgba(2,12,27,.25)">
    <h3 id="loginTitle">تسجيل الدخول</h3>
    <div class="login-grid">
      <div class="login-row" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label>اسم المستخدم</label><input id="lg_user" class="input" value="NOMU" autocomplete="username"></div>
        <div><label>كلمة المرور</label><input id="lg_pass" class="input" type="password" value="1234" autocomplete="current-password"></div>
      </div>
      <div><label>نوع الحساب</label><select id="lg_acc" class="input"></select></div>
      <div><label>الدور/الصلاحية</label>
        <select id="lg_role" class="input">
          <option value="viewer">عارض</option><option value="kpi">مشرف مؤشرات</option>
          <option value="ops">محرر عمليات</option><option value="report">منسق تقارير</option>
          <option value="owner">مالك الحساب</option>
        </select>
      </div>
      <div class="login-actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="lg_cancel" class="btn ghost">إلغاء</button><button id="lg_ok" class="btn">دخول</button>
      </div>
    </div>
  </div>
</div>

<!-- بحث موحّد -->
<div id="globalSearchBackdrop" style="position:fixed;inset:0;background:rgba(2,12,27,.45);display:none;z-index:10000"></div>
<div id="globalSearchWrap" style="position:fixed;inset:0;display:none;place-items:center;z-index:10001">
  <div style="width:min(92vw,820px);max-height:80vh;overflow:auto;background:#fff;border:1px solid #e6e9ef;border-radius:16px;padding:16px;box-shadow:0 20px 60px rgba(2,12,27,.25)">
    <h3>بحث موحّد في الخدمات</h3>
    <div style="display:flex;gap:8px;margin:8px 0 12px">
      <input id="gs_q" class="input" placeholder="اكتب اسم خدمة أو حساب...">
      <button class="btn" id="gs_go">بحث</button>
      <button class="btn ghost" id="gs_close">إغلاق</button>
    </div>
    <div id="gs_results" class="services-grid" style="grid-template-columns:repeat(2,minmax(0,1fr))"></div>
  </div>
</div>

<script>
"use strict";
const $$=(s,root=document)=>Array.from(root.querySelectorAll(s));
const $=(s,root=document)=>root.querySelector(s);
const isMobile = ()=> window.matchMedia && matchMedia("(max-width:979px)").matches;

/* ===== KPI schema: units + thresholds (per indicator) ===== */
const KPI_SCHEMA = {
  "نسبة": (v)=>({unit:"%", value:v, grade: v>=90?"ok": v>=75?"warn":"bad", target:"≥90%"}),
  "دقيقة": (v)=>({unit:"د", value:v, grade: v<=10?"ok": v<=20?"warn":"bad", target:"≤10د"}),
  "مؤشر": (v)=>({unit:"نقطة", value:v, grade: v>=85?"ok": v>=70?"warn":"bad", target:"≥85"})
};
function inferKPI(indTitle){
  if(/انتظار|طوارئ|د\)/.test(indTitle)) return "دقيقة";
  if(/رضا|التزام|تغطية|تحقق|جاهزية|حضور|نجاح|شفافية/.test(indTitle)) return "نسبة";
  return "مؤشر";
}
function makeKPIRow(title){
  const kind = inferKPI(title);
  const raw = kind==="دقيقة" ? (4 + Math.floor(Math.random()*18)) : (75 + Math.floor(Math.random()*20));
  const calc = KPI_SCHEMA[kind](raw);
  const trend = (Math.random()>.5?"+":"-") + (Math.random()*5|0) + "%";
  return {title, value: calc.value + (calc.unit==="%"?"%":"") + (calc.unit==="د"?"د":""), unit:calc.unit, grade:calc.grade, trend, target: calc.target};
}

/* ===== OFFICIAL KPIs per account (titles + kind + target) ===== */
const OFFICIAL_KPIS = {
  health: [
    {title:"اكتمال التطعيمات الأساسية", kind:"نسبة",  target:"≥95%"},
    {title:"تغطية الفحص السمعي المبكر", kind:"نسبة",  target:"≥90%"},
    {title:"جاهزية ملف الطفل الصحي",   kind:"نسبة",  target:"≥92%"},
    {title:"إغلاق الإحالات خلال 7 أيام",kind:"نسبة",  target:"≥85%"},
    {title:"زمن انتظار الطوارئ",        kind:"دقيقة", target:"≤10د"},
    {title:"رضا أولياء الأمور",         kind:"نسبة",  target:"≥88%"}
  ],
  clinic: [
    {title:"نسبة الحضور للموعد",        kind:"نسبة",  target:"≥92%"},
    {title:"بدء الخدمة الأولى",         kind:"دقيقة", target:"≤12د"},
    {title:"الزيارات الوقائية المجدولة", kind:"نسبة",  target:"≥75%"},
    {title:"إغلاق الإحالات",            kind:"نسبة",  target:"≥90%"},
    {title:"رضا المستفيدين اليومي",     kind:"نسبة",  target:"≥88%"}
  ],
  education: [
    {title:"الالتحاق برياض الأطفال",    kind:"نسبة",  target:"≥80%"},
    {title:"الانضباط والحضور",           kind:"نسبة",  target:"≥92%"},
    {title:"جاهزية الصف الأول",          kind:"نسبة",  target:"≥85%"},
    {title:"إتقان القراءة المبكرة",      kind:"نسبة",  target:"≥70%"},
    {title:"شراكات صحية تعليمية",       kind:"نسبة",  target:"≥60%"}
  ],
  neighborhood: [
    {title:"تنفيذ الفعاليات المجتمعية", kind:"نسبة",  target:"≥85%"},
    {title:"مشاركة الأسر",               kind:"نسبة",  target:"≥70%"},
    {title:"التغطية الجغرافية للأنشطة", kind:"نسبة",  target:"≥75%"},
    {title:"رضا المجتمع",                kind:"نسبة",  target:"≥85%"}
  ],
  nonprofit: [
    {title:"إنجاز البرامج التنموية",     kind:"نسبة",  target:"≥85%"},
    {title:"الشفافية والتقارير",         kind:"نسبة",  target:"≥90%"},
    {title:"إشراك المتطوعين الفعّال",    kind:"نسبة",  target:"≥70%"},
    {title:"تحقق الأثر المجتمعي",        kind:"نسبة",  target:"≥75%"}
  ],
  mhrsd: [
    {title:"معالجة البلاغات ضمن المدة",  kind:"نسبة",  target:"≥90%"},
    {title:"التكامل بين الجهات",         kind:"نسبة",  target:"≥85%"},
    {title:"رضا المستفيدين",             kind:"نسبة",  target:"≥88%"},
    {title:"الحماية والدعم الأسري",      kind:"نسبة",  target:"≥80%"}
  ],
  csr: [
    {title:"الالتزام بالعقود",           kind:"نسبة",  target:"≥90%"},
    {title:"الصرف حسب الخطة",            kind:"نسبة",  target:"≥85%"},
    {title:"شراكات فعّالة",              kind:"نسبة",  target:"≥70%"},
    {title:"تقارير الأثر",               kind:"نسبة",  target:"≥90%"}
  ],
  family: [
    {title:"تفاعل الأسر",                kind:"نسبة",  target:"≥75%"},
    {title:"التزام خطط المتابعة المنزلية",kind:"نسبة", target:"≥70%"},
    {title:"رضا المستخدمين",             kind:"نسبة",  target:"≥85%"},
    {title:"تحسن مؤشرات النمو",          kind:"نسبة",  target:"≥65%"}
  ],
  admin: [
    {title:"تحديث المؤشرات آليًا",       kind:"نسبة",  target:"≥90%"},
    {title:"الامتثال للسياسات",          kind:"نسبة",  target:"≥95%"},
    {title:"سرعة إصدار التقارير الوطنية",kind:"دقيقة", target:"≤10د"},
    {title:"تكامل الجهات الوطنية",       kind:"نسبة",  target:"≥85%"}
  ]
};

/* استخدم المؤشرات الرسمية إن وُجدت للحساب */
function makeKPIsForAccount(accKey){
  const list = OFFICIAL_KPIS[accKey];
  if (!list || !list.length) return (DATA[accKey]?.kpis||[]).map(makeKPIRow);
  return list.map(item=>{
    let base;
    if (item.kind === "نسبة") {
      const tgt = parseInt(item.target.replace(/\D/g,'')) || 85;
      base = Math.max(tgt - 8, 60) + Math.floor(Math.random()*12);
    } else if (item.kind === "دقيقة") {
      const lim = parseInt(item.target.replace(/\D/g,'')) || 10;
      base = Math.max(3, lim - 2) + Math.floor(Math.random()*6);
    } else { base = 80 + Math.floor(Math.random()*15); }
    const calc = KPI_SCHEMA[item.kind](base);
    const trend = (Math.random()>.5?"+":"-") + (Math.random()*4|0) + "%";
    return {title:item.title, value:calc.value + (calc.unit==="%"?"%":"") + (calc.unit==="د"?"د":""), unit:calc.unit, grade:calc.grade, target:item.target||calc.target, trend};
  });
}

/* بيانات الحسابات */
const DATA = {
  "health": {"services":{"الخدمات الصحية الذكية":["الملف الصحي الموحّد للطفل","سجل التطعيمات الذكي","الفحص السمعي والبصري المبكر","نظام الإشعارات الوقائية","تكامل الوصفات الإلكترونية","لوحة الأمراض المعدية للأطفال","مسار الإحالات المعزّز"],"الأداء والجودة":["زمن الانتظار حسب العيادة","نسبة إغلاق الإحالات","تتبّع الأحداث السلبية","رضا أولياء الأمور","التغطية الجغرافية للفحوص"],"نماذج وحقول (تجريبية)":[{"form":"تسجيل زيارة طفل","fields":["رقم الملف","العمر (أشهر)","الوزن","الطول","محیط الرأس","ملاحظات"]},{"form":"إحالة حالة خاصة","fields":["التشخيص الأولي","درجة الخطورة","جهة الإحالة","سبب الإحالة","مرفقات"]}]},"kpis":["إتمام التطعيمات الأساسية","الفحص المبكر المكتمل","زمن انتظار الطوارئ (د)","إغلاق الإحالات خلال 7 أيام","رضا أولياء الأمور","تغطية العيادات الوقائية"],"ops":["حملة تطعيم موسمية","توسعة عيادة الأطفال","ربط نظام الإحالات"]},
  "clinic": {"services":{"التشغيل اليومي":["جدولة المواعيد الذكية","توزيع الطاقة الاستيعابية","إدارة قوائم الانتظار","آلية النداء بالأولوية","استبيانات فورية بعد الزيارة"],"التواصل الأسري":["تقارير منزلية مبسطة","خطة متابعة الحالات المزمنة","تذكير بالزيارات","موافقة ولي الأمر الرقمية"],"نماذج وحقول (تجريبية)":[{"form":"فتح موعد","fields":["التاريخ","الوقت","العيادة","الطبيب","نوع الزيارة"]},{"form":"إغلاق إحالة","fields":["رقم الإحالة","تاريخ الإغلاق","نتيجة الإحالة","ملاحظات"]}]},"kpis":["حجوزات إلكترونية","نسبة الحضور للموعد","إغلاق الإحالات","رضا المستفيدين اليومي","زمن تقديم أول خدمة (د)","التزام الزيارات الوقائية"],"ops":["تحسين النداء بالأولوية","تقليل زمن الانتظار","خطة صيانة الأجهزة"]},
  "education": {"services":{"مؤشرات التعليم المبكر":["قياس التحصيل المعرفي KG","الحضور والانضباط","تأهيل الكادر التربوي","نسبة التسرب المبكر","جاهزية الصف الأول"],"الربط الصحي التعليمي":["مواءمة الفحوص مع التحصيل","متابعة التغذية المدرسية","الأنشطة الرياضية","برامج توعوية مشتركة"],"نماذج وحقول (تجريبية)":[{"form":"تقييم طفل روضة","fields":["الصف","المعلم","المجال اللغوي","المجال العددي","المهارات الاجتماعية","ملاحظات"]}]},"kpis":["التحاق برياض الأطفال","جاهزية مدرسية","تدريب المعلمين","نسبة التسرب المبكر","انتقال ناجح للصف الأول","شراكات صحية تعليمية"],"ops":["برنامج القراءة المبكرة","ورشة تدريب الكادر","تحسين الحضور"]},
  "neighborhood": {"services":{"الأنشطة المجتمعية":["تقويم الفعاليات","التسجيل والمقاعد","نقاط مشاركة الأسر","التغطية الجغرافية للأنشطة"],"الخدمات الاجتماعية":["إحالة الأسر المحتاجة","متابعة المبادرات التطوعية","شراكات محلية","قياس رضا المجتمع"],"نماذج وحقول (تجريبية)":[{"form":"تسجيل فعالية","fields":["العنوان","التاريخ","الموقع","الطاقة الاستيعابية","الفئة المستهدفة"]}]},"kpis":["فعاليات منفذة","مشاركة أسرية","مشاركة أطفال","رضا المجتمع","شراكات محلية فعّالة"],"ops":["مهرجان الأسرة والطفل","حملة توعية غذائية","برنامج مهارات الحياة"]},
  "nonprofit": {"services":{"المشاريع التنموية":["إدارة مقترحات البرامج","إدارة المتطوعين","تتبع الإنفاق والأثر","تقارير للممولين"],"الشفافية والمسؤولية":["مؤشرات الحوكمة","نشر الإنجازات","تكامل مع الجهات الحكومية"],"نماذج وحقول (تجريبية)":[{"form":"طلب دعم برنامج","fields":["اسم البرنامج","الميزانية","المؤشرات المتوقعة","الفترة","الموقع الجغرافي"]}]},"kpis":["عدد البرامج","دعم مالي/عيني","تحقق أثر مجتمعي","متطوعون نشطون","شفافية التقارير"],"ops":["إطلاق برنامج حضانة","حملة تجهيز فصول","دورة تدريب متطوعين"]},
  "mhrsd": {"services":{"الرعاية الاجتماعية":["تتبّع البلاغات الأسرية","دعم الأسر الحاضنة","برامج الحماية","التنسيق عبر الجهات"],"الجودة والتكامل":["مؤشرات جودة الخدمات الاجتماعية","إحالة آمنة","لوحة المخاطر الاجتماعية"],"نماذج وحقول (تجريبية)":[{"form":"فتح بلاغ اجتماعي","fields":["نوع البلاغ","الفئة العمرية","الموقع","الأولوية","الجهة المتابعة"]}]},"kpis":["أسر مستفيدة","معالجة البلاغات بالمدة","رضا المستفيدين","تنسيق بين الجهات","وقاية من العنف الأسري"],"ops":["تفعيل خط الدعم","تكامل بلاغات مع الصحة","برنامج إسناد الأسر"]},
  "csr": {"services":{"المسؤولية الاجتماعية CSR":["تقديم مبادرات التمويل","لوحة أثر واستدامة","متابعة الصرف","إدارة الشراكات"],"التواصل مع الجهات":["قائمة مشاريع قابلة للدعم","عقود رقمية","تقارير العائد الاجتماعي"],"نماذج وحقول (تجريبية)":[{"form":"مبادرة تمويل","fields":["اسم المبادرة","المبلغ","الجهة المنفذة","مؤشرات الأثر","فترة التنفيذ"]}]},"kpis":["برامج ممولة","إجمالي المساهمات","التزام تقارير الأثر","شراكات فعّالة","الأثر الاجتماعي"],"ops":["تمويل عيادات متنقلة","رعاية برنامج روضات","مبادرة غذاء صحي"]},
  "family": {"services":{"التوعية والمتابعة":["تطبيق نمو طفلي","تذكير التطعيمات","استشارات نفسية وتربوية","برنامج القراءة المبكرة"],"المشاركة المجتمعية":["التطوع الأسري","حضور الأنشطة","تقييم الخدمات","اقتراحات"],"نماذج وحقول (تجريبية)":[{"form":"خطة متابعة منزلية","fields":["عمر الطفل","الأولوية","نوع النشاط","التكرار الأسبوعي","ملاحظات"]}]},"kpis":["تفاعل الأسر","زيارات/أسرة/شهر","ملفات نمو مكتملة","رضا المستخدمين","تحسن مؤشرات النمو"],"ops":["برنامج روتين منزلي","مجموعة دعم للأمهات","تحدي قراءة شهري"]},
  "admin": {"services":{"إدارة المنظومة":["حوكمة البيانات","صلاحيات وهوية","كتالوج البيانات الوطني","تكامل مع المستودعات"],"التقارير الوطنية":["تقارير موحّدة متعددة الجهات","لوحة الأثر على رؤية 2030","مؤشرات استراتيجية"],"نماذج وحقول (تجريبية)":[{"form":"طلب تكامل جهة","fields":["اسم الجهة","نوع البيانات","دورية التحديث","نقطة الاتصال"]}]},"kpis":["جهات متكاملة وطنياً","مؤشرات محدّثة آلياً","الامتثال للسياسات","سرعة التقارير الوطنية","أثر على أهداف 2030"],"ops":["توقيع مذكرات تكامل","نشر تقرير وطني","تدقيق صلاحيات"]}
};

/* حسابات + تبويبات */
const ACCOUNTS = {
  "health":    { name:"وزارة الصحة", icon:"#ico-health" },
  "clinic":    { name:"المراكز الصحية", icon:"#ico-clinic" },
  "education": { name:"وزارة التعليم", icon:"#ico-edu" },
  "neighborhood": { name:"مراكز الأحياء", icon:"#ico-town" },
  "nonprofit": { name:"الجمعيات", icon:"#ico-nonprofit" },
  "mhrsd":     { name:"الموارد البشرية والتنمية", icon:"#ico-mhrsd" },
  "csr":       { name:"القطاع الخاص", icon:"#ico-csr" },
  "family":    { name:"الأسرة", icon:"#ico-family" },
  "admin":     { name:"اللجنة الوطنية", icon:"#ico-admin" }
};
const TABS = [
  {key:"summary",label:"الملخص"},
  {key:"services",label:"الخدمات والتقنيات"},
  {key:"operations",label:"العمليات"},
  {key:"indicators",label:"المؤشرات"},
  {key:"reports",label:"التقارير"},
  {key:"resources",label:"الموارد"},
  {key:"governance",label:"الحوكمة"}
];

/* أدوار وصلاحيات */
function getRole(){ try{ return JSON.parse(localStorage.getItem('nomu_auth')||'{}').role || 'viewer'; }catch(_){ return 'viewer'; } }
function enforceRole(ctx){
  const role = getRole();
  const chip = document.getElementById('roleChip'); if(chip){ chip.textContent = {'viewer':'عارض','kpi':'مشرف مؤشرات','ops':'محرر عمليات','report':'منسق تقارير','owner':'مالك الحساب'}[role]||role; }
  if(ctx==='services'){
    $$('#accContent .btn').forEach(b=>{
      if(/حفظ|مسودة|استرجاع|تفريغ/.test(b.textContent)) b.disabled = (role==='viewer');
    });
  }
  if(ctx==='operations'){
    const canEdit = (role==='ops' || role==='owner');
    const addBtn = $('#accContent [id^=addOp_]'); if(addBtn) addBtn.disabled = !canEdit;
    $$('#accContent .card button').forEach(b=>{ if(b.textContent==='تم') b.disabled = !canEdit; });
  }
}

/* نموذج عام */
function formCard(title, fields, accKey){
  return `<div class="card" style="margin-top:8px" data-form-title="${title}">
    <div style="display:flex;align-items:center;gap:8px"><svg class="i" viewBox="0 0 24 24"><use href="#ico-form"/></svg><b>${title}</b></div>
    <div class="form-grid" style="margin-top:8px">
      ${fields.map((f,i)=>{
        const isReq = /^(الاسم|العمر|الوزن|الطول|رقم|التاريخ|الجهة|الأولوية|نوع|العنوان)$/u.test(f) || i<2;
        return `<div class='field'><label class='${isReq?'req':''}'>${f}</label><input class='input' placeholder='${f}' data-required='${isReq?1:0}'></div>`;
      }).join('')}
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn ghost" onclick="return saveFormDraft(this,'${accKey||''}','${title||''}')">مسودة</button>
      <button class="btn" onclick="return saveFormFinal(this,'${accKey||''}','${title||''}')">حفظ</button>
      <button class="btn ghost" onclick="return loadForm(this,'${accKey||''}','${title||''}')">استرجاع</button>
      <button class="btn ghost" onclick="return clearForm(this,'${accKey||''}','${title||''}')">تفريغ</button>
    </div>
    <div class="hint">يتم حفظ البيانات محليًا على جهازك (تجريبي).</div>
  </div>`;
}
function formKey(acc, title){ return `nomu.form.${acc}.${title}`; }
function formCollect(card){
  const inputs = $$('.input', card);
  const data = {}; let ok = true;
  inputs.forEach((inp)=>{
    const label = inp.parentElement.querySelector('label')?.textContent?.replace('*','').trim()||'';
    const req = inp.dataset.required==='1';
    if(req && !inp.value.trim()){ ok=false; inp.classList.add('bad'); }
    else { inp.classList.remove('bad'); }
    data[label] = inp.value;
  });
  return {ok, data};
}
function saveFormDraft(btn, acc, title){
  const card = btn.closest('[data-form-title]');
  const {data} = formCollect(card);
  try{ localStorage.setItem(formKey(acc,title), JSON.stringify({data, draft:true, ts:Date.now()})); toast('تم حفظ المسودة'); }catch(_){ toast('تعذر الحفظ'); }
  return false;
}
function saveFormFinal(btn, acc, title){
  const card = btn.closest('[data-form-title]');
  const res = formCollect(card);
  if(!res.ok){ toast('الرجاء تعبئة الحقول الإلزامية'); return false; }
  try{ localStorage.setItem(formKey(acc,title), JSON.stringify({data:res.data, draft:false, ts:Date.now()})); toast('تم الحفظ بنجاح'); }catch(_){ toast('تعذر الحفظ'); }
  return false;
}
function loadForm(btn, acc, title){
  const card = btn.closest('[data-form-title]');
  const raw = localStorage.getItem(formKey(acc,title)); if(!raw){ toast('لا توجد بيانات محفوظة'); return false; }
  try { const {data} = JSON.parse(raw); $$('.input', card).forEach(inp=>{
    const label = inp.parentElement.querySelector('label')?.textContent?.replace('*','').trim()||'';
    if(data[label]!=null) inp.value = data[label];
  }); toast('تم الاسترجاع'); } catch(_){ toast('تعذر الاسترجاع'); }
  return false;
}
function clearForm(btn, acc, title){
  const card = btn.closest('[data-form-title]');
  $$('.input', card).forEach(inp=> inp.value='');
  try{ localStorage.removeItem(formKey(acc,title)); }catch(_){}
  toast('تم التفريغ'); return false;
}

/* Toast */
function toast(msg){
  const t=document.createElement('div'); t.textContent=msg;
  t.style.cssText='position:fixed;left:50%;transform:translateX(-50%);top:16px;background:#0ea5e9;color:#fff;padding:8px 12px;border-radius:10px;z-index:9999';
  document.body.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; t.style.transition='.2s'; setTimeout(()=> t.remove(), 180); }, 1200);
}

/* Excel + Print */
function toRowsFromTable(selector){
  const tbl = document.querySelector(selector);
  const rows=[Array.from(tbl.tHead.rows[0].cells).map(th=>th.textContent.trim())];
  $$('#accContent tbody tr').forEach(tr=>{ rows.push(Array.from(tr.cells).map(td=> td.textContent.trim())); });
  return rows;
}
function rowsToXLS(name, rows){
  const esc = (s)=> String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const shRows = rows.map(r=> '<Row>'+ r.map(c=> `<Cell><Data ss:Type="String">${esc(c)}</Data></Cell>`).join('') +'</Row>').join('');
  const xml = `<?xml version="1.0"?>
  <Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
    xmlns:o="urn:schemas-microsoft-com:office:office"
    xmlns:x="urn:schemas-microsoft-com:office:excel"
    xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
    <Worksheet ss:Name="${esc(name)}"><Table>${shRows}</Table></Worksheet>
  </Workbook>`;
  const blob = new Blob([xml], {type:'application/vnd.ms-excel'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=name+'.xls';
  document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
}
function printSection(){ window.print(); }

/* عناصر الهيدر */
document.getElementById('mobileMenuBtn').onclick = (e)=>{ e.preventDefault(); openMobileMenu(); };
document.getElementById('bell').onclick = (e)=>{ e.preventDefault(); toast('لا توجد إشعارات جديدة.'); };
document.getElementById('desktopLoginBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); showLogin(); });

/* قائمة جوال Bottom Sheet */
function openMobileMenu(){
  if (!isMobile()) return;
  if (document.getElementById('mobileMenuSheet')) return;
  const sheet = document.createElement('div');
  sheet.id='mobileMenuSheet';
  sheet.style.cssText='position:fixed;inset:auto 0 0 0;background:#fff;border-top:1px solid var(--border);border-radius:16px 16px 0 0;box-shadow:0 -12px 30px rgba(2,12,27,.15);z-index:9999;max-height:65vh;overflow:auto;padding:12px;transform:translateY(16px);opacity:0;transition:.2s';
  sheet.innerHTML = document.querySelector('.mega-left').innerHTML;
  sheet.querySelectorAll('a').forEach(a=> a.addEventListener('click', ev=>{ ev.preventDefault(); location.hash=a.getAttribute('href'); close(); }));
  document.body.appendChild(sheet);
  requestAnimationFrame(()=>{ sheet.style.transform='translateY(0)'; sheet.style.opacity='1'; });
  function close(){ sheet.style.transform='translateY(16px)'; sheet.style.opacity='0'; setTimeout(()=> sheet.remove(), 180); }
  document.addEventListener('click', (ev)=>{ if(!sheet.contains(ev.target)) close(); }, {once:true});
}

/* تسجيل الدخول */
const loginBackdrop = document.getElementById('loginBackdrop');
const loginWrap = document.getElementById('loginWrap');
function showLogin(pref){
  const sel = document.getElementById('lg_acc');
  if (!sel.options.length){
    Object.entries(ACCOUNTS).forEach(([k,v])=>{ const o=document.createElement('option'); o.value=k; o.textContent=v.name; sel.appendChild(o); });
  }
  if (pref && ACCOUNTS[pref]) sel.value=pref;
  loginBackdrop.style.display='block'; loginWrap.style.display='grid'; setTimeout(()=> document.getElementById('lg_user').focus(), 0);
}
function hideLogin(){ loginBackdrop.style.display='none'; loginWrap.style.display='none'; }
document.getElementById('lg_cancel').onclick = hideLogin;
document.getElementById('lg_ok').onclick = ()=>{
  const u = document.getElementById('lg_user').value.trim(), p = document.getElementById('lg_pass').value.trim(), a = document.getElementById('lg_acc').value, r = document.getElementById('lg_role').value;
  if (!u || !p || !a){ toast('الرجاء تعبئة الحقول'); return; }
  localStorage.setItem('nomu_auth', JSON.stringify({user:u, acc:a, role:r}));
  hideLogin(); location.hash = `#/acc/${a}?tab=summary`;
};

/* العرض */
const view = document.getElementById('view');
function KPIIcon(){ return '<svg class="i brand" viewBox="0 0 24 24"><use href="#ico-kpi"/></svg>'; }
function clearNode(el){ while(el.firstChild) el.removeChild(el.firstChild); }

function makeDemoKPIsFromList(list){ return list.map(t=> makeKPIRow(t)); }

/* صفحات بسيطة */
function renderIntro(){
  view.innerHTML = `
    <div class="card">
      <h2 class="section-title">من نحن</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="card" style="border-style:dashed"><b>الرؤية</b><br>أن تكون المرجع الوطني الشامل لتطوير منظومة الطفولة المبكرة.</div>
        <div class="card" style="border-style:dashed"><b>الرسالة</b><br>تمكين الجهات عبر أدوات تحليلية وتشغيلية ومؤشرات أداء داعمة لصنع القرار.</div>
      </div>
      <div class="card" style="margin-top:12px"><b>الأهداف الإستراتيجية</b>
        <ul style="margin:8px 0 0 0;padding-inline-start:18px">
          <li>رفع جودة وكفاءة الخدمات المقدمة للطفل والأسرة.</li>
          <li>تعزيز التكامل والمواءمة بين الجهات والبرامج.</li>
          <li>تحسين إتاحة البيانات ودعم اتخاذ القرار.</li>
          <li>قياس الأثر وتحسين الاستثمار الاجتماعي.</li>
        </ul>
      </div>
    </div>`;
}
function renderSupport(){ view.innerHTML = `<div class="card"><h2>الدعم الفني</h2><p>تجريبي: support@nomu.sa</p></div>`; }
function renderPolicies(){ view.innerHTML = `<div class="card"><h2>الأدلة والسياسات</h2><p>حوكمة البيانات والخصوصية والامتثال — نماذج تجريبية.</p></div>`; }
function renderContact(){ view.innerHTML = `<div class="card"><h2>اتصل بنا</h2><p>نموذج تواصل بسيط — تجريبي.</p></div>`; }
function renderIntegration(){
  view.innerHTML = `<div class="card"><h2>تكامل الشركاء</h2>
    <p>واجهة ربط تجريبية (Mock) للتوضيح. سيتم ربط الإصدار الفعلي بمستودع البيانات الوطني.</p>
    <div class="card" style="margin-top:8px"><b>نماذج نقاط نهاية عامة</b>
    <ul style="margin:8px 0 0 0;padding-inline-start:18px">
      <li><code>POST /api/v1/cases</code> — استقبال/إنشاء حالة (صحة/اجتماعي/تعليمي).</li>
      <li><code>POST /api/v1/referrals</code> — إنشاء إحالة بين جهتين.</li>
      <li><code>GET /api/v1/indicators?account=health</code> — مؤشرات محدثة حسب الحساب.</li>
      <li><code>PUT /api/v1/services/:id</code> — تحديث خدمة أو طاقتها.</li>
    </ul></div>
    <div class="card" style="margin-top:8px"><b>خريطة الحقول المشتركة (Data Dictionary)</b>
      <div class="services-grid" style="grid-template-columns:repeat(2,minmax(0,1fr))">
        <div class="service"><h4>هوية الطفل</h4><p>national_id, child_id, birth_date, gender</p></div>
        <div class="service"><h4>الموقع</h4><p>region, city, district, facility_id</p></div>
        <div class="service"><h4>الصحة</h4><p>immunization_status, screening_result, referral_id</p></div>
        <div class="service"><h4>التعليم</h4><p>kg_readiness, attendance_rate, teacher_id</p></div>
        <div class="service"><h4>الاجتماعي</h4><p>case_risk, family_status, support_program</p></div>
        <div class="service"><h4>الميتاداتا</h4><p>source_system, created_at, updated_at</p></div>
      </div>
    </div>
    <div class="card" style="margin-top:8px"><b>ضوابط الحوكمة</b>
      <ul style="margin:8px 0 0 0;padding-inline-start:18px">
        <li>مبدأ أقل صلاحية (Least Privilege).</li>
        <li>إخفاء الهوية على مستويات التقارير المشتركة.</li>
        <li>تشفير أثناء النقل (TLS) وAt-Rest).</li>
        <li>تدقيق الدخول والتغييرات (Audit Trail).</li>
      </ul>
    </div>
  </div>`;
}

/* التوجيه */
function parseRoute(){
  const h = location.hash || "";
  if (!h || h==="#" || h==="#/") return {type:"overview"};
  if (h==="#/overview") return {type:"overview"};
  if (h==="#/intro") return {type:"intro"};
  if (h==="#/services") return {type:"services"};
  if (h==="#/support") return {type:"support"};
  if (h==="#/policies") return {type:"policies"};
  if (h==="#/contact") return {type:"contact"};
  if (h==="#/integration") return {type:"integration"};
  const m = h.match(/^#\/acc\/([^?]+)(?:\?tab=([a-z]+))?/);
  if (m) return {type:"acc", key:m[1], tab:m[2]||"summary"};
  return {type:"unknown"};
}
function applyTitle(){
  const h = location.hash;
  const MAP={"#/overview":"نظرة عامة – منصة نمو","#/intro":"من نحن – منصة نمو","#/services":"الخدمات – منصة نمو","#/support":"الدعم الفني – منصة نمو","#/policies":"الأدلة والسياسات – منصة نمو","#/contact":"اتصل بنا – منصة نمو","#/integration":"تكامل الشركاء – منصة نمو"};
  if (MAP[h]) document.title = MAP[h];
  if (/^#\/acc\//.test(h)) document.title = "الحساب – منصة نمو";
}
function render404(){ view.innerHTML = `<div class="card"><h2>لم يتم العثور على الصفحة</h2><p>تحقق من الرابط أو اختر صفحة من القائمة.</p></div>`; }
function route(){
  applyTitle();
  const r = parseRoute();
  if (r.type==="overview") return renderOverview();
  if (r.type==="intro") return renderIntro();
  if (r.type==="services") return renderServicesCatalog();
  if (r.type==="support") return renderSupport();
  if (r.type==="policies") return renderPolicies();
  if (r.type==="contact") return renderContact();
  if (r.type==="integration") return renderIntegration();
  if (r.type==="acc") return renderAccount(r.key, r.tab);
  return render404();
}
window.addEventListener('hashchange', route);

/* نظرة عامة */
function renderOverview(){
  const kpis = makeDemoKPIsFromList(["تغطية الخدمات","التكامل بين الجهات","رضا المستفيدين","سرعة المعالجة","جودة البيانات","الأثر المجتمعي","كفاءة الإنفاق","التحسين المستمر"]).slice(0,8);
  const mount = document.getElementById('kpiHome'); clearNode(mount);
  const frag = document.createDocumentFragment();
  kpis.forEach(k=>{ const div=document.createElement('div'); div.className='kpi-card'; div.innerHTML = `
    <div class="kpi-icon">${KPIIcon()}</div>
    <div><div class="kpi-title">${k.title}</div>
      <div class="kpi-meta"><span class="kpi-value">${k.value}</span>
        <span class="badge ${k.grade}">${k.grade==="ok"?"جيد":k.grade==="warn"?"تحذير":"حرِج"}</span>
        <span class="badge info">${k.trend}</span></div>
    </div>`; frag.appendChild(div); });
  mount.appendChild(frag);
}

/* كتالوج الخدمات العام */
function renderServicesCatalog(){
  const GLOBAL = [
    "لوحة متابعة الطفولة المبكرة","إدارة الإحالات","سجل الطفل الموحّد","تقارير قياس الأثر","أتمتة التنبيهات",
    "مخزون الخدمات والطاقات","تكامل البيانات","حوكمة البيانات والامتثال","مؤشرات الأداء المتقدمة","التكامل مع الهوية الوطنية"
  ];
  clearNode(view);
  const wrap=document.createElement('div'); wrap.className='card'; wrap.innerHTML = `
    <h2 class="section-title">كتالوج الخدمات</h2>
    <div class="toolbar"><input id="svcSearch" class="input" placeholder="ابحث عن خدمة...">
    <button class="btn ghost" id="svcReset">مسح</button></div>
    <div id="svcGrid" class="services-grid"></div>`;
  view.appendChild(wrap);
  const grid = $("#svcGrid");
  const renderItems = (arr)=>{
    clearNode(grid);
    const frag=document.createDocumentFragment();
    arr.forEach(t=>{ const d=document.createElement('div'); d.className='service'; d.innerHTML = `<h4>${t}</h4><p>وصف مختصر للخدمة.</p>`; frag.appendChild(d); });
    grid.appendChild(frag);
  };
  renderItems(GLOBAL);
  $("#svcSearch").oninput = (e)=> renderItems(GLOBAL.filter(x=> x.includes(e.target.value)));
  $("#svcReset").onclick = ()=>{ $("#svcSearch").value=''; renderItems(GLOBAL); };
}

/* عرض الحسابات */
function renderAccount(accKey, tabKey){
  const meta = ACCOUNTS[accKey]; if(!meta) return render404();
  const pack = DATA[accKey]; const current = tabKey || "summary";
  clearNode(view);
  const header=document.createElement('div'); header.className='card'; header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center'; header.style.gap='10px';
  header.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px">
      <div class="kpi-icon"><svg class="i" viewBox="0 0 24 24"><use href="${meta.icon}"/></svg></div>
      <div><div style="font-weight:800">${meta.name}</div>
        <div style="color:#64748b;font-size:13px">لوحة تحكم الحساب · تبويب: <b>${(TABS.find(t=>t.key===current)||{}).label||""}</b> <span id='roleChip' class='role-chip' style='margin-inline-start:8px'></span></div>
      </div>
    </div>
    <a class="btn ghost" href="#/services">كتالوج الخدمات</a>`;
  view.appendChild(header);

  const nav=document.createElement('nav'); nav.className='tabs'; nav.setAttribute('role','tablist'); nav.setAttribute('aria-label','تبويبات الحساب');
  nav.innerHTML = TABS.map(t=>`<a class="tab" role="tab" aria-selected="${t.key===current}" href="#/acc/${accKey}?tab=${t.key}">
        <svg class="i muted" viewBox="0 0 24 24"><use href="${meta.icon}"/></svg>${t.label}</a>`).join('');
  view.appendChild(nav);

  const mount=document.createElement('div'); mount.id='accContent'; view.appendChild(mount);

  if (current==="summary"){
    const data = makeKPIsForAccount(accKey);
    mount.innerHTML = `<div class="kpi-grid">${data.map(k=>`
      <div class="kpi-card">
        <div class="kpi-icon">${KPIIcon()}</div>
        <div><div class="kpi-title">${k.title}</div>
          <div class="kpi-meta"><span class="kpi-value">${k.value}</span>
            <span class="badge ${k.grade}">${k.grade==="ok"?"جيد":k.grade==="warn"?"تحذير":"حرِج"}</span>
            <span class="badge tgt">${k.target}</span>
            <span class="badge info">${k.trend}</span>
          </div></div>
      </div>`).join('')}</div>`;
  }

  if (current==="services"){
    const grouped = (pack.services)||{};
    let blocks = ''; Object.entries(grouped).forEach(([group,items])=>{
      if (!items.length) return;
      if (typeof items[0] === 'string'){
        blocks += `<div class="card" style="margin:8px 0"><b>${group}</b>
          <div class="services-grid">${items.map(it=>`<div class="service"><h4>${it}</h4><p>تفاصيل قابلة للتخصيص.</p></div>`).join('')}</div>
        </div>`;
      } else {
        blocks += `<div class="card" style="margin:8px 0"><b>${group}</b>` + items.map(f=> formCard(f.form, f.fields, accKey)).join('') + `</div>`;
      }
    });
    mount.innerHTML = blocks || `<div class="card">لا توجد خدمات.</div>`; enforceRole('services');
  }

  if (current==="operations"){
    const ops = (pack.ops||[]).slice();
    mount.innerHTML = `<div class="card"><div style='display:flex;align-items:center;justify-content:space-between'><b>العمليات الجارية</b><button class='btn ghost' id='ops_export_${accKey}'>تصدير Excel</button></div>
      <div id="opList_${accKey}">${ops.map(v=>`<div class="card" style="margin-top:8px"><div style="display:flex;justify-content:space-between;gap:8px"><span>${v}</span><button class="btn ghost">تم</button></div></div>`).join('')}</div>
      <div class="toolbar" style="margin-top:10px"><input id="newOp_${accKey}" class="input" placeholder="أضف مهمة تشغيلية..."><button class="btn" id="addOp_${accKey}">إضافة</button></div>
    </div>`;
    const list = document.getElementById('opList_'+accKey);
    document.getElementById('addOp_'+accKey).onclick = ()=>{
      const inp = document.getElementById('newOp_'+accKey); const v = inp.value.trim(); if(!v) return;
      const row = document.createElement('div'); row.className='card'; row.style.marginTop='8px';
      row.innerHTML = `<div style="display:flex;justify-content:space-between;gap:8px"><span>${v}</span><button class="btn ghost">تم</button></div>`;
      row.querySelector('button').onclick = ()=> row.remove();
      list.appendChild(row); inp.value='';
    };
    document.getElementById('ops_export_'+accKey).onclick = ()=>{
      const rows = [['المهمة']].concat(Array.from(list.querySelectorAll('.card span')).map(s=>[s.textContent.trim()]));
      rowsToXLS('operations_'+accKey, rows);
    };
    enforceRole('operations');
  }

  if (current==="indicators"){
    const data = makeKPIsForAccount(accKey);
    mount.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px"><b>جدول المؤشرات</b><div style="display:flex;gap:6px"><button class="btn ghost" id="kpi_print">طباعة/PDF</button><button class="btn ghost" id="kpi_export_${accKey}">تصدير Excel</button></div></div><table class="table">
      <thead><tr>
        <th data-k="title">المؤشر</th><th data-k="value">القيمة</th>
        <th data-k="grade">التقييم</th><th>الهدف</th><th data-k="trend">الاتجاه</th><th>آخر تحديث</th>
      </tr></thead>
      <tbody>${data.map(k=>`
        <tr>
          <td>${k.title}</td>
          <td><b>${k.value}</b></td>
          <td><span class="badge ${k.grade}">${k.grade==="ok"?"جيد":k.grade==="warn"?"تحذير":"حرِج"}</span></td>
          <td><span class="badge tgt">${k.target||"-"}</span></td>
          <td><span class="badge info">${k.trend}</span></td>
          <td><span class="badge">اليوم</span></td>
        </tr>`).join('')}</tbody>
    </table>`;
    $$('#accContent th[data-k]').forEach(th=>{
      let asc=true; th.addEventListener('click', ()=>{
        const idx = {title:0,value:1,grade:2,trend:4}[th.dataset.k];
        const rows = Array.from(document.querySelectorAll('#accContent tbody tr'));
        rows.sort((a,b)=>{
          const A=a.children[idx].textContent.trim(), B=b.children[idx].textContent.trim();
          return asc ? A.localeCompare(B,'ar') : B.localeCompare(A,'ar');
        }).forEach(r=> r.parentNode.appendChild(r)); asc=!asc;
      });
    });
    const expBtn = document.getElementById('kpi_export_'+accKey); if(expBtn){ expBtn.onclick = ()=>{ const rows = toRowsFromTable('#accContent table'); rowsToXLS('kpi_'+accKey, rows); } }
    const pr = document.getElementById('kpi_print'); if(pr){ pr.onclick = ()=> printSection(); }
  }

  if (current==="reports"){
    mount.innerHTML = `<div class="services-grid" style="grid-template-columns:repeat(3,minmax(0,1fr))">
      ${["الأداء الشهري","الجودة والامتثال","الإحالات والانتظار","التغطية الجغرافية","الأثر المجتمعي","كفاءة الإنفاق"].map(t=>`
        <a class="service" href="#" onclick="return false" style="text-decoration:none">
          <h4>تقرير ${t}</h4><p>PDF · آخر إصدار</p>
        </a>`).join('')}
    </div>`;
  }

  if (current==="resources"){
    mount.innerHTML = `<div class="card"><b>الموارد</b>
      <ul style="margin:8px 0 0 0;padding-inline-start:18px">
        <li><a href="#/policies">الأدلة والسياسات</a></li>
        <li><a href="#/support">الدعم الفني</a></li>
        <li><a href="#/contact">اتصل بنا</a></li>
      </ul></div>`;
  }

  if (current==="governance"){
    mount.innerHTML = `<div class="card"><b>الحوكمة والأدوار</b>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="card" style="border-style:dashed"><b>الأدوار</b>
          <ul style="margin:6px 0 0 0;padding-inline-start:18px">
            <li>مالك الحساب</li><li>مشرف المؤشرات</li><li>منسق التقارير</li><li>محرر العمليات</li><li>عارض</li>
          </ul></div>
        <div class="card" style="border-style:dashed"><b>سياسات البيانات</b>
          <ul style="margin:6px 0 0 0;padding-inline-start:18px">
            <li>أقل صلاحية</li><li>إخفاء الهوية</li><li>تدقيق الدخول والتغييرات</li>
          </ul></div>
      </div></div>`;
  }
}

/* بحث موحّد */
(function(){
  const btn = document.getElementById('globalSearchBtn');
  if(btn){ btn.onclick = ()=>{ document.getElementById('globalSearchBackdrop').style.display='block'; document.getElementById('globalSearchWrap').style.display='grid'; setTimeout(()=> document.getElementById('gs_q').focus(),0); }; }
  const close = ()=>{ document.getElementById('globalSearchBackdrop').style.display='none'; document.getElementById('globalSearchWrap').style.display='none'; };
  document.getElementById('gs_close').onclick = close;
  document.getElementById('globalSearchBackdrop').onclick = close;
  document.getElementById('gs_go').onclick = ()=>{
    const q = (document.getElementById('gs_q').value||'').trim();
    const grid = document.getElementById('gs_results'); grid.innerHTML='';
    if(!q){ grid.innerHTML='<div class="card">أدخل عبارة للبحث.</div>'; return; }
    const res = [];
    Object.entries(DATA).forEach(([key, pack])=>{
      const groups = pack.services||{};
      Object.entries(groups).forEach(([g, items])=>{
        if(!items || !items.length) return;
        if(typeof items[0]==='string'){
          items.forEach(it=>{
            const hay = (it + ' ' + g + ' ' + (ACCOUNTS[key]?.name||key));
            if(hay.includes(q)) res.push({acc:key, title: it, group: g});
          });
        }
      });
    });
    if(!res.length){ grid.innerHTML='<div class="card">لا توجد نتائج.</div>'; return; }
    const frag = document.createDocumentFragment();
    res.slice(0,40).forEach(r=>{
      const a = document.createElement('a');
      a.className='service'; a.href = `#/acc/${r.acc}?tab=services`; a.onclick=(ev)=>{ev.preventDefault(); close(); location.hash=a.getAttribute('href');};
      a.innerHTML = `<h4>${r.title}</h4><p>${(ACCOUNTS[r.acc]?.name||r.acc)} — ${r.group}</p>`;
      frag.appendChild(a);
    });
    grid.appendChild(frag);
  };
})();

/* بدء التشغيل */
window.addEventListener('load', ()=>{
  document.querySelectorAll('details').forEach(d=> d.addEventListener('toggle', ()=>{ if(d.open) document.querySelectorAll('details').forEach(x=> x!==d && (x.open=false)); }));
  if (!location.hash || location.hash==="#" || location.hash==="#/") location.hash = '#/overview';
  route();
  const fab=document.querySelector('.fab-home'); if(fab) fab.style.display = isMobile() ? 'flex' : 'none'; if(isMobile()) fab.href = '#/overview';
});
document.addEventListener('keydown', (e)=>{
  const inInput=/^(INPUT|TEXTAREA|SELECT)$/.test(document.activeElement?.tagName||''); if(inInput) return;
  if((e.altKey&&(e.key==='h'||e.key==='H'))||(e.key==='h'||e.key==='H')){ e.preventDefault(); location.hash='#/overview'; }
});
</script>
</body></html>
