<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ù…Ù†ØµØ© Ù†Ù…Ùˆ NOMU â€” v4.0 (Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª + CRUD + Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ)</title>
<style>
:root{
  --bg:#f7fbff; --paper:#fff; --brand:#16a34a; --ink:#0f172a; --sub:#475569; --accent:#f59e0b;
  --muted:#f1f5f9; --border:#e2e8f0; --radius:16px; --pad:16px; --gap:12px; --gap-lg:20px; --shadow:0 10px 30px rgba(2,12,27,.06);
  --font:"Tajawal","Noto Kufi Arabic",system-ui,-apple-system,"Segoe UI",Arial;
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.7 var(--font)}
a{color:#0ea5e9;text-decoration:none}
header{position:sticky;top:0;z-index:30;background:#ffffffe6;backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
.topbar{max-width:1240px;margin:auto;padding:10px var(--pad);display:flex;align-items:center;gap:10px}
.logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 180deg,#22c55e,#86efac,#34d399,#22c55e);box-shadow:0 6px 16px rgba(16,185,129,.25)}
.left-logos{margin-inline-start:auto;display:flex;gap:8px}
.pill-logo{display:flex;align-items:center;gap:8px;background:var(--muted);border:1px solid var(--border);border-radius:999px;padding:6px 10px}
.pill-logo img{height:28px;display:block}
.main{max-width:1240px;margin:20px auto;display:grid;grid-template-columns:280px 1fr;gap:var(--gap-lg);padding:0 var(--pad)}
nav .side{position:sticky;top:72px;background:var(--paper);border:1px solid var(--border);border-radius:var(--radius);padding:10px;box-shadow:var(--shadow)}
.group h4{margin:10px 8px;color:var(--sub);font-size:13px}
.link{display:flex;gap:10px;padding:10px;border-radius:12px;color:var(--ink);border:1px solid transparent}
.link:hover{background:var(--muted);border-color:var(--border)} .link.active{background:linear-gradient(180deg,#ecfdf5,#e7f9f0);border-color:#befae0}
.content{display:grid;gap:var(--gap-lg)}
.card{background:var(--paper);border:1px solid var(--border);border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow)}
.toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.tag{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#f0fdf4;color:#14532d;padding:6px 10px;border-radius:999px;font-size:12px}
.btn{background:var(--brand);color:#052e1d;border:none;padding:9px 12px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 6px 18px rgba(34,197,94,.25)}
.ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}
.grid{display:grid;gap:var(--gap)} .two{grid-template-columns:1fr 1fr} .three{grid-template-columns:repeat(3,1fr)} .four{grid-template-columns:repeat(4,1fr)}
.form label{display:block;margin:6px 0 4px} .form input,.form select,.form textarea{width:100%;padding:9px;border:1px solid var(--border);border-radius:10px;background:#fff}
.tabs{display:flex;gap:8px;flex-wrap:wrap;border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:8px}
.tab{padding:8px 12px;border:1px solid var(--border);border-bottom:none;border-radius:10px 10px 0 0;background:#f8fafc;cursor:pointer}
.tab.active{background:#fff;border-color:#22c55e}
.tabpanel{border:1px solid var(--border);border-radius:0 12px 12px 12px;padding:12px;background:#fff}
.kpi{border:1px solid var(--border);border-radius:14px;padding:14px;background:#f8fffb} .kpi b{display:block;font-size:22px;margin-top:6px}
table{width:100%;border-collapse:separate;border-spacing:0 8px} th,td{text-align:right;padding:10px;background:#fcfdff} th{color:#64748b;font-size:12px}
.tools{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.search{display:flex;gap:8px;align-items:center}
.files{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px} .filepill{display:flex;align-items:center;gap:6px;border:1px dashed #cbd5e1;background:#fff;border-radius:999px;padding:6px 10px;font-size:12px}
.note{font-size:12px;color:#64748b}
.callout{background:#f0f9ff;border:1px solid #bae6fd;border-radius:12px;padding:10px}
.danger{background:#fff1f2;border:1px solid #fecdd3}
footer{max-width:1240px;margin:22px auto 36px;color:#64748b;text-align:center;padding:0 var(--pad)}
@media (max-width:980px){ .main{grid-template-columns:1fr} .four{grid-template-columns:1fr 1fr} }
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px">
      <div class="logo" aria-hidden="true"></div>
      <div><b>NOMU â€” Ù…Ù†ØµØ© Ù†Ù…Ùˆ</b><div style="font-size:12px;color:#0f766e">Ù…Ù†ØµØ© ÙˆØ·Ù†ÙŠØ© Ù„Ù„Ø·ÙÙˆÙ„Ø© Ø§Ù„Ù…Ø¨ÙƒØ±Ø©</div></div>
    </div>
    <div class="left-logos">
      <span class="pill-logo" title="Vision 2030">
        <img alt="Vision 2030" src='data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="140" height="36"><rect x="1" y="5" rx="12" width="138" height="26" fill="%23f1f5f9" stroke="%23cbd5e1"/><text x="70" y="24" text-anchor="middle" font-size="14" font-family="Tajawal,Arial" fill="%230f172a">Vision 2030</text></svg>'/>
      </span>
      <span class="pill-logo" title="Ù…Ø¨Ø§Ø¯Ø±Ø© ØªÙ„Ø¨ÙŠØ©">
        <img alt="Talbiya" src='data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="140" height="36"><rect x="1" y="5" rx="12" width="138" height="26" fill="%23f1f5f9" stroke="%23cbd5e1"/><text x="70" y="24" text-anchor="middle" font-size="14" font-family="Tajawal,Arial" fill="%230f172a">%D9%85%D8%A8%D8%A7%D8%AF%D8%B1%D8%A9%20%D8%AA%D9%84%D8%A8%D9%8A%D8%A9</text></svg>'/>
      </span>
    </div>
  </div>
</header>

<main class="main">
  <nav>
    <div class="side">
      <div class="group">
        <h4>Ø§Ù„ØªØ¹Ø§Ø±ÙŠÙ</h4>
        <a class="link" href="#/intro">Ø¹Ù† Ø§Ù„Ù…Ù†ØµØ©</a>
        <a class="link" href="#/kpi">Ø³Ø¬Ù„ KPI</a>
      </div>
      <div class="group">
        <h4>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h4>
        <a class="link" href="#/acc/health">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø©</a>
        <a class="link" href="#/acc/clinic">Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØµØ­ÙŠØ©</a>
        <a class="link" href="#/acc/education">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</a>
        <a class="link" href="#/acc/neighborhood">Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ø£Ø­ÙŠØ§Ø¡</a>
        <a class="link" href="#/acc/nonprofit">Ø§Ù„Ø¬Ù…Ø¹ÙŠØ§Øª</a>
        <a class="link" href="#/acc/hr">Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</a>
        <a class="link" href="#/acc/csr">Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø®Ø§Øµ</a>
        <a class="link" href="#/acc/family">Ø§Ù„Ø£Ø³Ø±Ø©</a>
        <a class="link" href="#/acc/admin">Ø§Ù„Ù„Ø¬Ù†Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ©</a>
      </div>
      <div class="group">
        <h4>ØªØ´ØºÙŠÙ„</h4>
        <a class="link" href="#/dispatch">Ù…ÙˆØ²Ù‘Ø¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</a>
        <a class="link" href="#/ops">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§ÙƒØ²</a>
      </div>
      <div class="group">
        <h4>Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø©</h4>
        <a class="link" href="#/sponsors">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø¹Ø§Ø©</a>
        <a class="link" href="#/pricing">Ù„ÙˆØ§Ø¦Ø­ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</a>
      </div>
      <div class="group">
        <h4>Ø§Ù„Ø£Ù…Ù† ÙˆØ§Ù„Ø±Ø¨Ø·</h4>
        <a class="link" href="#/sso">SSO Ù†ÙØ§Ø°</a>
        <a class="link" href="#/rbac">RBAC</a>
        <a class="link" href="#/config">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
      </div>
      <div class="group">
        <h4>Ø³ÙŠØ§Ø³Ø§Øª ÙˆÙ…Ø³Ø§Ø¹Ø¯Ø©</h4>
        <a class="link" href="#/privacy">Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a>
        <a class="link" href="#/child">Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø·ÙÙ„</a>
        <a class="link" href="#/help">Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</a>
        <a class="link" href="#/terms">Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</a>
      </div>
      <div class="group">
        <h4>Ø£Ø¯ÙˆØ§Øª</h4>
        <a class="link" href="#/export">ØªØµØ¯ÙŠØ±</a>
        <a class="link" href="#/apidocs">API Docs</a>
      </div>
    </div>
  </nav>
  <section class="content" id="view"></section>
</main>

<footer>Ù†Ù…Ùˆ NOMU â€” v4.0 (Ù…Ù†ØµØ© Ù…ØªÙƒØ§Ù…Ù„Ø© Ø¨ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ø­Ø¯Ø©: CRUD + ØªØ¨ÙˆÙŠØ¨Ø§Øª + Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ + ØªØ´ØºÙŠÙ„ + Ø§Ø³ØªØ¯Ø§Ù…Ø© + Ø³ÙŠØ§Ø³Ø§Øª)</footer>

<script>
/* ============= Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© ============= */
const $=(q,root=document)=>root.querySelector(q);
const $$=(q,root=document)=>Array.from(root.querySelectorAll(q));
function route(){ const p=location.hash.slice(1)||'/intro'; $$('a.link').forEach(a=>a.classList.toggle('active', a.getAttribute('href')===`#${p}`)); (routes[p]||intro)(); }
window.addEventListener('hashchange',route);

const downloadFile=(name,blob)=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); };
const downloadJSON=(name,obj)=>downloadFile(name,new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}));
const toCSV=(rows)=>rows.map(r=>r.map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
const downloadCSV=(name,rows)=>downloadFile(name,new Blob([toCSV(rows)],{type:'text/csv'}));
const uid=(p='ID')=>p+'-'+Math.random().toString(36).slice(2,8).toUpperCase();
const today=()=>new Date().toISOString().slice(0,10);

/* ============= SSO & RBAC & Config ============= */
const DEFAULT_CONFIG={
  sso:{ issuer:'https://nafath.example.gov.sa', authorize_url:'https://nafath.example.gov.sa/authorize', token_url:'https://nafath.example.gov.sa/token', client_id:'NOMU-CLIENT-ID', redirect_uri:'https://nomu.gov.sa/callback' },
  apis:{ internal:{ health:'/api/health', clinic:'/api/clinic', education:'/api/education', neighborhood:'/api/neighborhood', nonprofit:'/api/nonprofit', hr:'/api/hr', csr:'/api/csr', family:'/api/family', admin:'/api/admin', dispatch:'/api/dispatch' } }
};
const loadCfg=()=>{ try{ return JSON.parse(localStorage.getItem('nomu_cfg')||'null') || DEFAULT_CONFIG }catch(e){ return DEFAULT_CONFIG } };
const saveCfg=(cfg)=>localStorage.setItem('nomu_cfg', JSON.stringify(cfg));

let RBAC={ roles:{
  'health.practitioner':['child.read','health.write','referral.send','referral.accept','appointment.manage','kpi.view'],
  'clinic.staff':['child.read','appointment.manage','referral.accept','kpi.view'],
  'education.specialist':['child.read','education.write','referral.accept','kpi.view'],
  'neighborhood.coordinator':['program.manage','booking.manage','referral.accept','kpi.view'],
  'nonprofit.worker':['child.read','service.write','referral.accept','kpi.view'],
  'admin.national':['kpi.view','kpi.define','policy.write','audit.read'],
  'family.guardian':['child.own','consent.grant','appointment.book']
}};
const can=(role,perm,consent=true)=> (RBAC.roles[role]||[]).includes(perm) && (perm!=='child.read' || consent || role==='admin.national');

/* ============= Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© (Mock API) ============= */
const DB_KEY='nomu_db_v40';
const DB=()=>{ try{ return JSON.parse(localStorage.getItem(DB_KEY)||'{}') }catch(e){ return {} } };
const DB_SAVE=(db)=>localStorage.setItem(DB_KEY, JSON.stringify(db));
const ensure=(...path)=>{ const db=DB(); let cur=db; for(const k of path){ cur[k]=cur[k]||{}; cur=cur[k]; } DB_SAVE(db); return cur; };

const API={
  list:(entity,section)=>Object.values(ensure(entity,section).items||{}),
  create:(entity,section,record)=>{ const root=ensure(entity,section); root.items=root.items||{}; const id=uid('REC'); root.items[id]={id,...record,createdAt:new Date().toISOString()}; DB_SAVE(DB()); return root.items[id]; },
  update:(entity,section,id,patch)=>{ const root=ensure(entity,section); if(root.items?.[id]){ root.items[id]={...root.items[id],...patch,updatedAt:new Date().toISOString()}; DB_SAVE(DB()); return root.items[id]; } },
  remove:(entity,section,id)=>{ const root=ensure(entity,section); if(root.items?.[id]){ delete root.items[id]; DB_SAVE(DB()); return true; } return false; },
  import:(entity,section,arr)=>{ const root=ensure(entity,section); root.items=root.items||{}; arr.forEach(x=>{ const id=x.id||uid('REC'); root.items[id]={id,...x}; }); DB_SAVE(DB()); },
  clear:(entity,section)=>{ const root=ensure(entity,section); root.items={}; DB_SAVE(DB()); },
};

/* ============= Ø¨ÙŠØ§Ù†Ø§Øª ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ² + ØªÙˆØ²ÙŠØ¹ ============= */
const CENTERS=[
  { id:'CLN-001', name:'Ù…Ø±ÙƒØ² ØµØ­ÙŠ Ø­ÙŠ Ø§Ù„Ø§Ø²Ø¯Ù‡Ø§Ø±', type:'clinic', region:'Ø§Ù„Ø±ÙŠØ§Ø¶', specialty:['Ù†Ù…Ø§Ø¦ÙŠ','ØªØ®Ø§Ø·Ø¨'], capacityDay:24, bookedToday:8, avgVisitMin:30, slaDays:7 },
  { id:'CLN-002', name:'Ù…Ø±ÙƒØ² ØµØ­ÙŠ Ø­ÙŠ Ø§Ù„Ø´Ø§Ø·Ø¦', type:'clinic', region:'Ø§Ù„Ø´Ø±Ù‚ÙŠØ©', specialty:['Ù†Ù…Ø§Ø¦ÙŠ','ÙˆØ¸ÙŠÙÙŠ'], capacityDay:18, bookedToday:15, avgVisitMin:40, slaDays:5 },
  { id:'NHB-101', name:'Ù…Ø±ÙƒØ² Ø­ÙŠ Ø§Ù„ØªØ¹Ø§ÙˆÙ†', type:'neighborhood', region:'Ø§Ù„Ø±ÙŠØ§Ø¶', specialty:['ØªÙˆØ¹ÙŠØ©','ÙØ±Ø² Ø£ÙˆÙ„ÙŠ'], capacityDay:40, bookedToday:10, avgVisitMin:20, slaDays:3 },
  { id:'NHB-102', name:'Ù…Ø±ÙƒØ² Ø­ÙŠ Ø§Ù„Ø¹Ù„ÙŠØ§', type:'neighborhood', region:'Ø§Ù„Ø±ÙŠØ§Ø¶', specialty:['ØªÙˆØ¹ÙŠØ©','ÙØ±Ø² Ø£ÙˆÙ„ÙŠ'], capacityDay:35, bookedToday:34, avgVisitMin:20, slaDays:3 },
  { id:'NGO-501', name:'Ø¬Ù…Ø¹ÙŠØ© Ù†Ù…Ø§Ø¡ Ø§Ù„Ø·ÙÙˆÙ„Ø©', type:'nonprofit', region:'Ø§Ù„Ø±ÙŠØ§Ø¶', specialty:['ØªØ¯Ø®Ù„ Ù…Ø¨ÙƒØ±','ØªØ®Ø§Ø·Ø¨'], capacityDay:22, bookedToday:6, avgVisitMin:45, slaDays:10 }
];
const occPct=c=>Math.round((c.bookedToday / Math.max(1,c.capacityDay))*100);
const estWaitDays=c=>{ const overflow=Math.max(0, c.bookedToday - c.capacityDay); return overflow>0 ? Math.ceil(overflow / Math.max(1,c.capacityDay)) : 0; };
function pickCenter({region, need, maxSlaDays=14}){
  const candidates = CENTERS.filter(c=> (c.region===region) && (need==='ÙØ±Ø² Ø£ÙˆÙ„ÙŠ' ? true : c.specialty.includes(need)));
  if(!candidates.length) return null;
  const scored = candidates.map(c=>{
    const occ = c.bookedToday/Math.max(1,c.capacityDay), occScore=1-Math.min(1,occ);
    const slaScore=Math.max(0,(maxSlaDays-c.slaDays)/maxSlaDays);
    return {c,score:occScore*0.6+slaScore*0.4};
  }).sort((a,b)=>b.score-a.score);
  return scored[0]?.c||null;
}

/* ============= ØªØ¹Ø±ÙŠÙØ§Øª KPI ============= */
const KPI_REGISTRY=[
  { id:'DEV_SCREEN', name:'Ù†Ø³Ø¨Ø© ØªØºØ·ÙŠØ© Ø§Ù„ÙØ­Øµ Ø§Ù„Ù†Ù…Ø§Ø¦ÙŠ', owner:'ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø©', formula:'Ø§Ù„Ù…ÙØ­ÙˆØµÙˆÙ† Ã· Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙÙˆÙ† Ã—100', period:'Ø´Ù‡Ø±ÙŠ', source:'HealthAssessment' },
  { id:'SCHOOL_READY', name:'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©', owner:'ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…', formula:'Ø¬Ø§Ù‡Ø²ÙˆÙ† Ã· Ø¥Ø¬Ù…Ø§Ù„ÙŠ 5â€“6 Ã—100', period:'ÙØµÙ„ÙŠ', source:'EducationPlan' },
  { id:'REF_TTR', name:'Ø²Ù…Ù† Ø§Ù„Ø¥Ø­Ø§Ù„Ø© (ÙŠÙˆÙ…)', owner:'Ø§Ù„Ù„Ø¬Ù†Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ©', formula:'Ù…ØªÙˆØ³Ø· (Ù‚Ø¨ÙˆÙ„ âˆ’ ÙØªØ­)', period:'Ø´Ù‡Ø±ÙŠ', source:'Referral' },
  { id:'WAIT', name:'Ù…ØªÙˆØ³Ø· Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø®Ø¯Ù…Ø©', owner:'Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ù‚Ø¯Ù‘ÙÙ…Ø©', formula:'Ù…ØªÙˆØ³Ø· (Ø£ÙˆÙ„ Ø¬Ù„Ø³Ø© âˆ’ Ø§Ù„Ù‚Ø¨ÙˆÙ„)', period:'Ø´Ù‡Ø±ÙŠ', source:'ServiceSession' },
  { id:'CSR_FUNDS', name:'ØªÙ…ÙˆÙŠÙ„ CSR', owner:'Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø®Ø§Øµ + Ø§Ù„Ù…Ù†ØµØ©', formula:'Ø§Ù„ØªØ¹Ù‡Ø¯Ø§Øª Ø§Ù„Ù…Ø¤ÙƒØ¯Ø© + Ø§Ù„Ù…Ø­ÙˆÙ‘Ù„', period:'Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ', source:'CSRCommitment' },
  { id:'ACTIVE_REF', name:'Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©', owner:'Ø§Ù„Ù„Ø¬Ù†Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ©', formula:'Ø§Ù„Ù…ÙØªÙˆØ­Ø© âˆ’ Ø§Ù„Ù…ØºÙ„Ù‚Ø©', period:'ÙŠÙˆÙ…ÙŠ', source:'Referral' }
];

/* ============= Ù…ÙˆÙ„Ù‘Ø¯ Ù†Ù…Ø§Ø°Ø¬/Ø¬Ø¯Ø§ÙˆÙ„ Ø¹Ø§Ù… ============= */
function buildForm(container, schema, current=null){
  container.innerHTML = `<div class="form grid two">
    ${schema.map(f=>{
      const val=current?.[f.key]??(f.value??'');
      const type=f.type||'text';
      const extra=(type==='textarea')?`<textarea data-key="${f.key}" placeholder="${f.key}">${val}</textarea>`:`<input type="${type}" data-key="${f.key}" value="${val}" placeholder="${f.key}"/>`;
      return `<label>${f.label}${extra}</label>`;
    }).join('')}
    ${schema.some(f=>f.type==='file')?`<div class="files" id="flist"></div>`:''}
  </div>`;
  // Ù…Ø±ÙÙ‚Ø§Øª Ø¹Ø§Ù…Ø© (Ø¥Ø°Ø§ Ø·Ù„Ø¨)
  schema.filter(f=>f.type==='file').forEach(f=>{
    const input = container.querySelector(`[data-key="${f.key}"]`);
    const flist = container.querySelector('#flist');
    input.addEventListener('change', e=>{
      [...e.target.files].forEach(file=>{
        const fileId=uid('FILE');
        const url=URL.createObjectURL(file);
        const pill=document.createElement('span'); pill.className='filepill';
        pill.innerHTML=`ğŸ“ ${file.name} â€¢ ${(file.size/1024).toFixed(1)} KB <a href="${url}" download="${file.name}">ØªÙ†Ø²ÙŠÙ„</a>`;
        flist.appendChild(pill);
      });
    });
  });
}
function buildTable(container, schema, rows, {onEdit,onDelete}={}){
  if(!rows.length){ container.innerHTML='<div class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª.</div>'; return; }
  const cols = ['id',...schema.map(f=>f.key),'createdAt','updatedAt'];
  container.innerHTML = `
    <div class="tools">
      <div class="search">
        <input id="q" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹" />
        <button class="ghost" id="exportCsv">ØªØµØ¯ÙŠØ± CSV</button>
        <label class="ghost" style="padding:6px 10px;border-radius:10px;cursor:pointer">
          Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON <input id="importJson" type="file" accept="application/json" style="display:none"/>
        </label>
      </div>
    </div>
    <div style="overflow:auto"><table id="tbl"><thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}<th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody></tbody></table></div>`;
  const tbody=$('#tbl tbody',container);
  const render=(data)=>{ tbody.innerHTML=data.map(r=>`<tr>${cols.map(c=>`<td>${(r[c]??'')}</td>`).join('')}<td>
      <button class="ghost" data-edit="${r.id}">ØªØ¹Ø¯ÙŠÙ„</button>
      <button class="ghost" data-del="${r.id}">Ø­Ø°Ù</button>
    </td></tr>`).join(''); };
  render(rows);
  $('#q',container).oninput=(e)=>{ const q=e.target.value.trim(); const filtered=rows.filter(r=>JSON.stringify(r).includes(q)); render(filtered); };
  $('#exportCsv',container).onclick=()=>{ const header=[...cols]; const data=rows.map(r=>cols.map(c=>r[c]??'')); downloadCSV('export.csv',[header,...data]); };
  $('#importJson',container).onchange=(e)=>{ const file=e.target.files[0]; if(!file) return; const fr=new FileReader(); fr.onload=()=>{ try{ const arr=JSON.parse(fr.result||'[]'); onEdit?.({import:arr}); }catch(err){ alert('ØµÙŠØºØ© JSON ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); } }; fr.readAsText(file); };
  container.addEventListener('click',(ev)=>{
    const id=ev.target.getAttribute('data-edit'); const del=ev.target.getAttribute('data-del');
    if(id && onEdit) onEdit({id});
    if(del && onDelete) onDelete({id:del});
  });
}

/* ============= ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„/Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„ÙƒÙ„ Ø­Ø³Ø§Ø¨ ============= */
const ACCOUNTS={
  health:{ title:'ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø©', tabs:{
    'Ø³Ø¬Ù„ Ø§Ù„ÙØ­ÙˆØµ':[
      {label:'MRN',key:'mrn'},{label:'Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ Ø§Ù„Ù†Ù…Ø§Ø¦ÙŠ',key:'dev_result'},
      {label:'PHQ-2/9',key:'phq_score'},{label:'ICD-10',key:'icd10'}
    ],
    'Ø§Ù„ØªØ¯Ø®Ù„ Ø§Ù„Ù…Ø¨ÙƒØ±':[
      {label:'Ù†ÙˆØ¹ Ø§Ù„ØªØ¯Ø®Ù„',key:'intervention_type'},{label:'Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª',key:'sessions',type:'number'},
      {label:'Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©',key:'followup_date',type:'date'}
    ],
    'Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª':[
      {label:'ØªØ§Ø±ÙŠØ® ÙØªØ­ Ø§Ù„Ø­Ø§Ù„Ø©',key:'opened_at',type:'date',value:today()},{label:'Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø©',key:'ref_to'},
      {label:'Ø£ÙˆÙ„ÙˆÙŠØ©',key:'priority'},{label:'SLA (ÙŠÙˆÙ…)',key:'sla',type:'number',value:7}
    ],
    'Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯':[
      {label:'Ù‡ÙˆÙŠØ© Ø§Ù„Ø·ÙÙ„',key:'childId'},{label:'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©',key:'region'},{label:'Ø§Ù„Ø­Ø§Ø¬Ø©',key:'need'},{label:'Ø£ÙˆÙ„ÙˆÙŠØ©',key:'prio'}
    ],
    'Ù…Ø·Ø§Ù„Ø¨Ø§Øª NPHIES':[
      {label:'Ø±Ù‚Ù… Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø©',key:'claim_id'},{label:'Ø§Ù„Ø­Ø§Ù„Ø©',key:'claim_status'}
    ],
    'ØªÙ‚Ø§Ø±ÙŠØ±':[],
    'Ù…Ø±ÙÙ‚Ø§Øª':[ {label:'Ù…Ù„ÙØ§Øª',key:'files',type:'file'} ]
  }},
  clinic:{ title:'Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØµØ­ÙŠØ©', tabs:{
    'Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯':[ {label:'Ø³Ø¬Ù„ Ø§Ù„Ø·ÙÙ„',key:'mrn'},{label:'Ø§Ù„ØªØ®ØµØµ',key:'specialty'},{label:'Ù…ÙˆØ¹Ø¯ (ØªØ§Ø±ÙŠØ®/Ø³Ø§Ø¹Ø©)',key:'appt_datetime',type:'datetime-local'} ],
    'Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª':[ {label:'Ù…Ù† Ø¬Ù‡Ø©',key:'ref_from'},{label:'Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø©',key:'ref_status'},{label:'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø¨ÙˆÙ„',key:'accepted_at',type:'date'} ],
    'Ø§Ù„Ø®Ø¯Ù…Ø§Øª':[ {label:'Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©',key:'service'},{label:'SLA Ø£ÙŠØ§Ù…',key:'sla_days',type:'number'} ],
    'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†':[ {label:'Ù…Ø¹Ø¯Ø§Øª/Ø£Ø¯ÙˆØ§Øª',key:'inventory_item'},{label:'Ø§Ù„ÙƒÙ…ÙŠØ©',key:'qty',type:'number'} ],
    'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±':[], 'Ù…Ø±ÙÙ‚Ø§Øª':[ {label:'Ù…Ù„ÙØ§Øª',key:'files',type:'file'} ]
  }},
  education:{ title:'ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…', tabs:{
    'Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©':[ {label:'Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©',key:'readiness_score',type:'number'},{label:'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©',key:'school_name'} ],
    'IEP/Ø¯Ù…Ø¬':[ {label:'IEP JSON',key:'iep_json',type:'textarea'},{label:'Ù†ÙˆØ¹ Ø§Ù„Ø¯Ù…Ø¬',key:'inclusion_type'} ],
    'Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª':[ {label:'ØªØ§Ø±ÙŠØ® ÙØªØ­',key:'opened_at',type:'date',value:today()},{label:'Ø¥Ù„Ù‰ Ø¬Ù‡Ø©',key:'ref_to'},{label:'SLA (ÙŠÙˆÙ…)',key:'sla',type:'number',value:10} ],
    'ØªÙˆØ§ØµÙ„ Ø§Ù„Ø£Ø³Ø±Ø©':[ {label:'Ù‡ÙˆÙŠØ© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±',key:'guardian_id'},{label:'Ø§Ù„Ù‚Ù†Ø§Ø©',key:'channel'} ],
    'ØªÙ‚Ø§Ø±ÙŠØ± Ù†ÙˆØ±':[], 'Ù…Ø±ÙÙ‚Ø§Øª':[ {label:'Ù…Ù„ÙØ§Øª',key:'files',type:'file'} ]
  }},
  neighborhood:{ title:'Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ø£Ø­ÙŠØ§Ø¡', tabs:{
    'Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬':[ {label:'Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬',key:'program'},{label:'Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©',key:'age_band'},{label:'Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨ÙŠØ©',key:'capacity',type:'number'} ],
    'Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙˆÙ†':[ {label:'Ø§Ø³Ù… Ø§Ù„Ù…ØªØ·ÙˆØ¹',key:'vol_name'},{label:'Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ·ÙˆØ¹',key:'vol_hours',type:'number'} ],
    'Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª':[ {label:'ØªØ§Ø±ÙŠØ®',key:'date',type:'date'},{label:'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯',key:'seats',type:'number'} ],
    'Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª':[ {label:'Ù…Ù†/Ø¥Ù„Ù‰',key:'ref_direction'},{label:'Ø§Ù„Ø­Ø§Ù„Ø©',key:'status'} ],
    'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±':[], 'Ù…Ø±ÙÙ‚Ø§Øª':[ {label:'Ù…Ù„ÙØ§Øª',key:'files',type:'file'} ]
  }},
  nonprofit:{ title:'Ø§Ù„Ø¬Ù…Ø¹ÙŠØ§Øª', tabs:{
    'Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬':[ {label:'Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬',key:'program'},{label:'Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª',key:'sessions',type:'number'} ],
    'Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙˆÙ†':[ {label:'Ù‡ÙˆÙŠØ© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±',key:'guardian_id'},{label:'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©',key:'region'} ],
    'Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙˆÙ†':[ {label:'Ø§Ø³Ù… Ø§Ù„Ù…ØªØ·ÙˆØ¹',key:'vol_name'},{label:'Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ·ÙˆØ¹',key:'hours',type:'number'} ],
    'Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª':[ {label:'Ø¥Ù„Ù‰ Ø¬Ù‡Ø©',key:'ref_to'},{label:'Ø§Ù„Ø­Ø§Ù„Ø©',key:'status'} ],
    'Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø«Ø±':[ {label:'ØªØ­Ø³Ù† Ø§Ù„Ø·ÙÙ„ (%)',key:'improve_pct',type:'number'} ],
    'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±':[], 'Ù…Ø±ÙÙ‚Ø§Øª':[ {label:'Ù…Ù„ÙØ§Øª',key:'files',type:'file'} ]
  }},
  hr:{ title:'Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©', tabs:{
    'Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø¯Ø¹Ù…':[ {label:'Ù†ÙˆØ¹ Ø§Ù„Ø¯Ø¹Ù…',key:'support_type'},{label:'Ø§Ù„Ù…Ø¨Ù„Øº/Ø§Ù„Ø´Ù‡Ø±',key:'amount',type:'number'},{label:'Ø£Ù‡Ù„ÙŠØ© Ø§Ù„Ø£Ø³Ø±Ø©',key:'eligibility'} ],
    'Ø§Ù„ØªØ·ÙˆØ¹ Ø§Ù„ÙˆØ·Ù†ÙŠ':[ {label:'Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø©',key:'initiative'},{label:'Ø§Ù„Ø³Ø§Ø¹Ø§Øª',key:'hours',type:'number'} ],
    'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±':[], 'Ù…Ø±ÙÙ‚Ø§Øª':[ {label:'Ù…Ù„ÙØ§Øª',key:'files',type:'file'} ]
  }},
  csr:{ title:'Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø®Ø§Øµ', tabs:{
    'Ø³ÙˆÙ‚ Ø§Ù„Ø±Ø¹Ø§ÙŠØ©':[ {label:'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©',key:'company'},{label:'Ø§Ù„ÙØ¦Ø©',key:'tier'},{label:'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©',key:'region'} ],
    'ØªØ¹Ù‡Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©':[ {label:'Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ¹Ù‡Ø¯',key:'amount',type:'number'},{label:'Ø§Ù„ØºØ±Ø¶',key:'purpose'} ],
    'ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø«Ø±':[], 'Ø­ÙˆÙƒÙ…Ø© CSR':[], 'Ù…Ø±ÙÙ‚Ø§Øª':[ {label:'Ù…Ù„ÙØ§Øª',key:'files',type:'file'} ]
  }},
  family:{ title:'Ø§Ù„Ø£Ø³Ø±Ø©', tabs:{
    'Ù…Ù„Ù Ø§Ù„Ø­Ù…Ù„ ÙˆØ§Ù„Ø·ÙÙ„':[ {label:'Ù‡ÙˆÙŠØ© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±',key:'guardian_id'},{label:'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©',key:'region'},{label:'Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',key:'consent'} ],
    'Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯':[ {label:'Ø§Ù„Ø®Ø¯Ù…Ø©',key:'service'},{label:'Ù…ÙˆØ¹Ø¯',key:'date',type:'date'} ],
    'Ø§Ù„ØªÙˆØµÙŠØ§Øª':[], 'Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø³Ø§Ù†Ø¯Ø©':[], 'Ù…Ø±ÙÙ‚Ø§Øª':[ {label:'Ù…Ù„ÙØ§Øª',key:'files',type:'file'} ]
  }},
  admin:{ title:'Ø§Ù„Ù„Ø¬Ù†Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ©', tabs:{
    'Ù„ÙˆØ­Ø© ÙˆØ·Ù†ÙŠØ©':[],
    'Ø­ÙˆÙƒÙ…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª':[ {label:'Ù‚Ø±Ø§Ø± Ø³ÙŠØ§Ø³Ø©',key:'policy_decision'} ],
    'Ø§Ù„ØªÙƒØ§Ù…Ù„Ø§Øª':[ {label:'ØªØ¹Ø±ÙŠÙ KPI',key:'kpi_def'} ],
    'Ø§Ù„Ø¥Ø´Ø±Ø§Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª':[ {label:'SLA Ø§ÙØªØ±Ø§Ø¶ÙŠ (ÙŠÙˆÙ…)',key:'sla_default',type:'number',value:7} ],
    'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙˆØ·Ù†ÙŠØ©':[], 'Ù…Ø±ÙÙ‚Ø§Øª':[ {label:'Ù…Ù„ÙØ§Øª',key:'files',type:'file'} ]
  }},
};

/* ============= ØµÙØ­Ø§Øª ============= */
function intro(){
  const v=$('#view');
  v.innerHTML = `<div class="card">
    <div class="toolbar"><h2>Ø¹Ù† Ù…Ù†ØµØ© Ù†Ù…Ùˆ (NOMU)</h2><span class="tag">Ù…Ù†ØµØ© ÙˆØ·Ù†ÙŠØ© Ù„Ù„Ø·ÙÙˆÙ„Ø© Ø§Ù„Ù…Ø¨ÙƒØ±Ø©</span></div>
    <p><b>Ø§Ù„Ø±Ø¤ÙŠØ©:</b> ØªÙ…ÙƒÙŠÙ† ÙƒÙ„ Ø·ÙÙ„ ÙÙŠ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ù‚ÙˆÙŠØ© Ù…ØªÙƒØ§Ù…Ù„Ø© ØµØ­ÙŠÙ‹Ø§ ÙˆØªØ¹Ù„ÙŠÙ…ÙŠÙ‹Ø§ ÙˆØ§Ø¬ØªÙ…Ø§Ø¹ÙŠÙ‹Ø§.<br/>
       <b>Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</b> Ù…Ù†ØµØ© Ù…ÙˆØ­Ø¯Ø© Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø·ÙÙ„ ÙˆØ§Ù„Ø£Ø³Ø±Ø© Ø¹Ø¨Ø± Ø§Ù„ØªÙƒØ§Ù…Ù„ØŒ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§ØªØŒ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§ØªØŒ ÙˆØ§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø©.</p>
    <div class="grid four">
      <div class="kpi"><div>ØªØºØ·ÙŠØ© Ø§Ù„ÙØ­Øµ Ø§Ù„Ù†Ù…Ø§Ø¦ÙŠ</div><b id="k1">â€”%</b><span class="note">Ù‡Ø¯Ù 2025: 80%</span></div>
      <div class="kpi"><div>Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©</div><b id="k2">â€”%</b><span class="note">Ù‡Ø¯Ù 2025: 75%</span></div>
      <div class="kpi"><div>Ù…ØªÙˆØ³Ø· Ø²Ù…Ù† Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</div><b id="k3">â€” ÙŠÙˆÙ…</b><span class="note">â‰¤ 7</span></div>
      <div class="kpi"><div>ØªÙ…ÙˆÙŠÙ„ CSR</div><b id="k4">â€” Ø±.Ø³</b><span class="note">Ø³Ù†ÙˆÙŠ</span></div>
    </div>
  </div>`;
}
function kpiPage(){
  const v=$('#view');
  v.innerHTML = `<div class="card">
    <div class="toolbar"><h2>Ø³Ø¬Ù„ ØªØ¹Ø±ÙŠÙØ§Øª KPI</h2><button class="ghost" id="dl">ØªÙ†Ø²ÙŠÙ„ JSON</button></div>
    <table><thead><tr><th>Ø§Ù„Ù…Ø¤Ø´Ø±</th><th>Ø§Ù„Ù…Ø§Ù„Ùƒ</th><th>Ø§Ù„ØµÙŠØºØ©</th><th>Ø§Ù„ÙØªØ±Ø©</th><th>Ø§Ù„Ù…ØµØ¯Ø±</th></tr></thead>
      <tbody>${KPI_REGISTRY.map(k=>`<tr><td><b>${k.name}</b><div class='note'>${k.id}</div></td><td>${k.owner}</td><td>${k.formula}</td><td>${k.period}</td><td>${k.source}</td></tr>`).join('')}</tbody>
    </table>
  </div>`;
  $('#dl').onclick=()=>downloadJSON('kpi_registry.json',KPI_REGISTRY);
}

/* === ØµÙØ­Ø© Ø­Ø³Ø§Ø¨ Ø¹Ø§Ù… (ÙƒÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª + CRUD) === */
function accountPage(key){
  const A=ACCOUNTS[key]; const v=$('#view'); const tabs=Object.keys(A.tabs);
  v.innerHTML = `<div class="card">
    <div class="toolbar"><h2>${A.title}</h2><span class="tag">ÙƒÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù…ÙØ¹Ù‘Ù„Ø©</span></div>
    <div class="tabs">${tabs.map((t,i)=>`<button class="tab ${i===0?'active':''}" data-tab="${t}">${t}</button>`).join('')}</div>
    <div id="tabpanel" class="tabpanel"></div>
  </div>`;
  const renderTab=(name)=>{
    const schema=A.tabs[name]; const panel=$('#tabpanel'); panel.innerHTML='';
    // Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ + Ø£Ø¯ÙˆØ§Øª
    panel.innerHTML = `<div class="grid two">
      <div id="formCard" class="card">
        <div class="toolbar"><h3>${name}</h3><span class="tag">Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</span></div>
        <div id="formHost"></div>
        <div class="tools"><button class="btn" id="saveRec">Ø­ÙØ¸</button><button class="ghost" id="reset">ØªÙØ±ÙŠØº</button>
          ${name==='Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯'?'<button class="ghost" id="smartAssign">ØªÙˆØ²ÙŠØ¹ Ø°ÙƒÙŠ</button>':''}
          ${name==='Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª'?'<button class="ghost" id="rf_send">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø­Ø§Ù„Ø©</button><button class="ghost" id="rf_accept">Ù‚Ø¨ÙˆÙ„</button><button class="ghost" id="rf_reject">Ø±ÙØ¶</button>':''}
        </div>
        ${name==='Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª'?'<div class="callout" id="slaNote">â€”</div>':''}
      </div>
      <div id="tableCard" class="card">
        <div class="toolbar"><h3>Ø§Ù„Ø³Ø¬Ù„Ø§Øª</h3><span class="tag">CRUD + Ø¨Ø­Ø« + Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ±</span></div>
        <div id="tableHost"></div>
      </div>
    </div>`;
    let editId=null;
    buildForm($('#formHost'), schema);
    const refresh=()=>{ const rows=API.list(key,name); buildTable($('#tableHost'), schema, rows,{
      onEdit:({id,import:arr})=>{
        if(arr){ API.import(key,name,arr); refresh(); return; }
        const rec=rows.find(r=>r.id===id); editId=id; buildForm($('#formHost'),schema,rec);
      },
      onDelete:({id})=>{ API.remove(key,name,id); refresh(); }
    }); };
    refresh();

    const readForm=()=>Object.fromEntries(schema.map(f=>[f.key, $('#formHost [data-key="'+f.key+'"]')?.value??'']));
    const clearForm=()=>buildForm($('#formHost'),schema);
    $('#saveRec').onclick=()=>{ const data=readForm(); if(editId){ API.update(key,name,editId,data); editId=null; } else { API.create(key,name,data); } refresh(); clearForm(); };
    $('#reset').onclick=()=>{ editId=null; clearForm(); };

    // ØªÙˆØ²ÙŠØ¹ Ø°ÙƒÙŠ Ù„Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
    if(name==='Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯' && $('#smartAssign')){
      $('#smartAssign').onclick=()=>{
        const region=$('#formHost [data-key="region"]')?.value||'Ø§Ù„Ø±ÙŠØ§Ø¶';
        const need=$('#formHost [data-key="need"]')?.value||$('#formHost [data-key="service"]')?.value||'Ù†Ù…Ø§Ø¦ÙŠ';
        const role='clinic.staff';
        if(!can(role,'appointment.manage')){ alert('â›” Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø­Ø¬Ø²'); return; }
        const c=pickCenter({region,need,maxSlaDays:14});
        if(!c){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙƒØ² Ù…Ù†Ø§Ø³Ø¨'); return; }
        if(occPct(c)<100){ c.bookedToday+=1; alert(`âœ… Ø­Ø¬Ø² ÙÙŠ ${c.name} â€” Ø¥Ø´ØºØ§Ù„ ${occPct(c)}%`); }
        else { alert(`âŒ› Ø§Ù…ØªÙ„Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ… â€” Ø§Ù†ØªØ¸Ø§Ø± ${c.name} (â‰ˆ ${estWaitDays(c)} ÙŠÙˆÙ…)`); }
      };
    }

    // Ø¥Ø­Ø§Ù„Ø§Øª + SLA
    if(name==='Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª'){
      const updateSLA=()=>{
        const opened=$('#formHost [data-key="opened_at"]')?.value;
        const sla=parseInt($('#formHost [data-key="sla"]')?.value||7,10);
        if(!opened){ $('#slaNote').textContent='â€”'; return; }
        const days=Math.ceil((new Date().getTime()-new Date(opened).getTime())/86400000);
        $('#slaNote').textContent = days>sla? `â›” ØªØ¬Ø§ÙˆØ² SLA (${days}/${sla} ÙŠÙˆÙ…)`:`âœ… Ø¶Ù…Ù† SLA (${days}/${sla} ÙŠÙˆÙ…)`;
      };
      $('#formHost').addEventListener('input', e=>{ if(e.target.matches('[data-key="opened_at"],[data-key="sla"]')) updateSLA(); });
      updateSLA();
      $('#rf_send').onclick=()=>{ if(!can('health.practitioner','referral.send')){ alert('â›” ØµÙ„Ø§Ø­ÙŠØ© Ù…ÙÙ‚ÙˆØ¯Ø©'); return; } alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© (Ù…Ø­Ø§ÙƒØ§Ø©)'); };
      $('#rf_accept').onclick=()=>{ if(!can('clinic.staff','referral.accept')){ alert('â›” ØµÙ„Ø§Ø­ÙŠØ© Ù…ÙÙ‚ÙˆØ¯Ø©'); return; } alert('âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© (Ù…Ø­Ø§ÙƒØ§Ø©)'); };
      $('#rf_reject').onclick=()=>alert('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© (Ù…Ø­Ø§ÙƒØ§Ø©)');
    }
  };
  renderTab(tabs[0]);
  $$('.tab',v).forEach(b=>b.onclick=(e)=>{ $$('.tab',v).forEach(x=>x.classList.remove('active')); e.currentTarget.classList.add('active'); renderTab(e.currentTarget.dataset.tab); });
}

/* === Ø§Ù„Ù…ÙˆØ²Ø¹ Ø§Ù„Ø°ÙƒÙŠ === */
function dispatchPage(){
  ensure('dispatch','queue'); const v=$('#view');
  v.innerHTML=`<div class="card">
    <div class="toolbar"><h2>Ø§Ù„Ù…ÙˆØ²Ù‘Ø¹ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</h2><span class="tag">Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±ÙƒØ² Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø´ØºØ§Ù„/SLA/Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</span></div>
    <div class="grid two form">
      <label>Ù‡ÙˆÙŠØ© Ø§Ù„Ø·ÙÙ„<input id="childId" placeholder="Child-XXXX"/></label>
      <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©<select id="region"><option>Ø§Ù„Ø±ÙŠØ§Ø¶</option><option>Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option></select></label>
      <label>Ø§Ù„Ø­Ø§Ø¬Ø©<select id="need"><option>Ù†Ù…Ø§Ø¦ÙŠ</option><option>ØªØ®Ø§Ø·Ø¨</option><option>ÙˆØ¸ÙŠÙÙŠ</option><option>ÙØ±Ø² Ø£ÙˆÙ„ÙŠ</option></select></label>
      <label>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©<select id="priority"><option>Ø¹Ø§Ø¯ÙŠØ©</option><option>Ø¹Ø§Ø¬Ù„Ø©</option></select></label>
      <label>SLA Ø§Ù„Ø£Ù‚ØµÙ‰<input id="sla" type="number" value="14"/></label>
      <label>Ø§Ù„Ø¯ÙˆØ±<select id="role"><option>clinic.staff</option><option>health.practitioner</option><option>neighborhood.coordinator</option><option>admin.national</option></select></label>
    </div>
    <div class="tools"><button class="btn" id="go">ØªÙˆØ²ÙŠØ¹</button><button class="ghost" id="export">ØªØµØ¯ÙŠØ± CSV</button></div>
    <pre id="out" class="callout" style="white-space:pre-wrap"></pre>
  </div>
  <div class="card"><div class="toolbar"><h3>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3><span class="tag">Ù‚Ø§Ø¦Ù…Ø©</span></div><div id="qList"></div></div>`;
  const render=()=>{ const rows=API.list('dispatch','queue'); buildTable($('#qList'),[{key:'childId'},{key:'region'},{key:'need'},{key:'priority'},{key:'centerId'},{key:'centerName'},{key:'status'}],rows,{
    onEdit:()=>{}, onDelete:({id})=>{ API.remove('dispatch','queue',id); render(); }
  }); };
  render();
  $('#go').onclick=()=>{
    const role=$('#role').value; if(!can(role,'appointment.manage')){ $('#out').textContent='â›” Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø­Ø¬Ø²'; return; }
    const req={ id:uid('REQ'), childId:$('#childId').value||'Child-â€”', region:$('#region').value, need:$('#need').value, priority:$('#priority').value, status:'Ø¬Ø¯ÙŠØ¯' };
    const target=pickCenter({region:req.region,need:req.need,maxSlaDays:parseInt($('#sla').value||'14',10)});
    if(target){
      if(occPct(target)<100){ target.bookedToday+=1; req.centerId=target.id; req.centerName=target.name; req.status='Ù…Ø­Ø¬ÙˆØ² Ø§Ù„ÙŠÙˆÙ…'; $('#out').textContent=`âœ… Ø­ÙØ¬Ø² ÙÙŠ ${target.name} â€” Ø¥Ø´ØºØ§Ù„ ${occPct(target)}%`; }
      else{ req.centerId=target.id; req.centerName=target.name; req.status='Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø§Ù„Ù…Ø±ÙƒØ²'; $('#out').textContent=`âŒ› Ø§Ù†ØªØ¸Ø§Ø± ÙÙŠ ${target.name} (â‰ˆ ${estWaitDays(target)} ÙŠÙˆÙ…)`; }
    } else { req.status='Ø§Ù†ØªØ¸Ø§Ø± Ø¹Ø§Ù…'; $('#out').textContent='âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙƒØ² Ù…Ù†Ø§Ø³Ø¨ â€” Ø£ÙØ¶ÙŠÙ Ù„Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¹Ø§Ù…'; }
    API.create('dispatch','queue',req); render();
  };
  $('#export').onclick=()=>{
    const rows=API.list('dispatch','queue'); const cols=['id','childId','region','need','priority','centerId','centerName','status','createdAt'];
    downloadCSV('dispatch_queue.csv',[cols,...rows.map(r=>cols.map(c=>r[c]??''))]);
  };
}

/* === Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§ÙƒØ² === */
function opsPage(){
  const v=$('#view');
  const cards=CENTERS.map(c=>`<div class="card">
    <div class="toolbar"><h3>${c.name}</h3><span class="tag">${c.type}</span></div>
    <div class="grid two">
      <div class="kpi"><div>Ø§Ù„Ø¥Ø´ØºØ§Ù„</div><b>${occPct(c)}%</b><span class="note">Ø³Ø¹Ø© ${c.capacityDay}/ÙŠÙˆÙ…</span></div>
      <div class="kpi"><div>Ø§Ù†ØªØ¸Ø§Ø± ØªÙ‚Ø¯ÙŠØ±ÙŠ</div><b>${estWaitDays(c)} ÙŠÙˆÙ…</b><span class="note">SLA: ${c.slaDays} Ø£ÙŠØ§Ù…</span></div>
    </div>
    <div class="note">ØªØ®ØµØµØ§Øª: ${c.specialty.join('ØŒ ')} â€¢ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${c.region}</div>
  </div>`).join('');
  v.innerHTML=`<div class="card"><div class="toolbar"><h2>Ù„ÙˆØ­Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ²</h2><span class="tag">ØªØ´ØºÙŠÙ„</span></div><div class="grid two">${cards}</div></div>
  <div class="card danger"><b>ØªÙˆØµÙŠØ©:</b> Ù†Ù…ÙˆØ°Ø¬ Ù‡Ø¬ÙŠÙ†: Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØµØ­ÙŠØ© Ù„Ù„ØªØ¯Ø®Ù„ Ø§Ù„Ù…ØªØ®ØµØµØŒ ÙˆÙ…Ø±Ø§ÙƒØ² Ø§Ù„Ø£Ø­ÙŠØ§Ø¡ Ù„Ù„ÙØ±Ø²/Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ÙŠØ© Ø¨Ø¥Ø´Ø±Ø§Ù ÙÙ†ÙŠ Ù„ØªØ®ÙÙŠÙ Ø¶ØºØ· Ø§Ù„ØªÙˆØ¸ÙŠÙ.</div>`;
}

/* === Ø§Ù„Ø±Ø¹Ø§Ø© + Ø§Ù„Ø£Ø³Ø¹Ø§Ø± === */
function sponsorsPage(){
  const v=$('#view'); v.innerHTML=`<div class="card">
    <div class="toolbar"><h2>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø¹Ø§Ø©</h2><span class="tag">Ø§ØªÙØ§Ù‚ÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©</span></div>
    <div class="three grid">
      <div class='card'><h3>Ù…Ø§Ø³ÙŠ</h3><div style='font-size:20px;font-weight:800;color:#0f766e'>1,500,000 Ø±.Ø³/Ø³Ù†Ø©</div><ul><li>Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª</li><li>ØªÙ‚Ø±ÙŠØ± Ø£Ø«Ø± Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ</li><li>Ø£ÙˆÙ„ÙˆÙŠØ© ØªØ³Ù…ÙŠØ©</li><li>Ù…Ù‚Ø¹Ø¯ Ù…Ø¬Ù„Ø³ Ø§Ù„Ø±Ø¹Ø§Ø©</li></ul></div>
      <div class='card'><h3>Ø°Ù‡Ø¨ÙŠ</h3><div style='font-size:20px;font-weight:800;color:#0f766e'>700,000 Ø±.Ø³/Ø³Ù†Ø©</div><ul><li>Ø§Ù„Ø´Ø¹Ø§Ø± Ø¨Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</li><li>ØªÙ‚Ø§Ø±ÙŠØ± Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©</li><li>Ø¯Ø¹ÙˆØ§Øª ÙØ¹Ø§Ù„ÙŠØ§Øª</li></ul></div>
      <div class='card'><h3>ÙØ¶ÙŠ</h3><div style='font-size:20px;font-weight:800;color:#0f766e'>300,000 Ø±.Ø³/Ø³Ù†Ø©</div><ul><li>Ø§Ù„Ø´Ø¹Ø§Ø± Ø¨ØµÙØ­Ø© Ø§Ù„Ø±Ø¹Ø§Ø©</li><li>Ø´Ø§Ø±Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</li></ul></div>
    </div>
    <h3>Ø·Ù„Ø¨ Ø±Ø¹Ø§ÙŠØ©</h3>
    <div class="grid two form">
      <label>Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©<input id="sp_org"/></label>
      <label>Ø³.Øª/Ø±Ù‚Ù… Ø¶Ø±ÙŠØ¨ÙŠ<input id="sp_cr"/></label>
      <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ<input id="sp_mail"/></label>
      <label>ÙØ¦Ø© Ø§Ù„Ø±Ø¹Ø§ÙŠØ©<select id="sp_tier"><option>Diamond</option><option>Gold</option><option>Silver</option></select></label>
      <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©<select id="sp_region"><option>Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ù…Ù„ÙƒØ©</option><option>Ø§Ù„Ø±ÙŠØ§Ø¶</option><option>Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option></select></label>
      <label>Ø§Ù„Ù…Ø¯Ø© (Ø£Ø´Ù‡Ø±)<input id="sp_months" type="number" value="12"/></label>
    </div>
    <button class="btn" id="gen">Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªÙØ§Ù‚ÙŠØ©</button>
    <div class="card" id="agreement" style="display:none;margin-top:12px"></div>
  </div>`;
  $('#gen').onclick=()=>{
    const org=$('#sp_org').value||'____', tier=$('#sp_tier').value, region=$('#sp_region').value, cr=$('#sp_cr').value||'â€”', months=parseInt($('#sp_months').value||'12',10);
    const todayStr=new Date().toLocaleDateString('ar-SA');
    const rights=tier==='Diamond'?'Ø´Ø¹Ø§Ø± Ø´Ø§Ù…Ù„ + ØªÙ‚Ø§Ø±ÙŠØ± Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ© + Ø£ÙˆÙ„ÙˆÙŠØ© ØªØ³Ù…ÙŠØ© + Ù…Ø¬Ù„Ø³ Ø§Ù„Ø±Ø¹Ø§Ø©':(tier==='Gold'?'Ø´Ø¹Ø§Ø± Ø¨Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© + ØªÙ‚Ø§Ø±ÙŠØ± Ù†ØµÙ Ø³Ù†ÙˆÙŠØ© + Ø¯Ø¹ÙˆØ§Øª':'Ø´Ø¹Ø§Ø± Ø¨ØµÙØ­Ø© Ø§Ù„Ø±Ø¹Ø§Ø© + Ø´Ø§Ø±Ø© ØªÙ‚Ø§Ø±ÙŠØ±');
    $('#agreement').style.display='block';
    $('#agreement').innerHTML=`<h3>Ø§ØªÙØ§Ù‚ÙŠØ© Ø±Ø¹Ø§ÙŠØ© Ù…Ù†ØµØ© Ù†Ù…Ùˆ</h3>
    <p>Ø¨ØªØ§Ø±ÙŠØ® <b>${todayStr}</b> Ø¨ÙŠÙ† Ù…Ù†ØµØ© <b>Ù†Ù…Ùˆ NOMU</b> ÙˆØ§Ù„Ø¬Ù‡Ø© <b>${org}</b> (Ø³.Øª/Ø¶Ø±ÙŠØ¨ÙŠ: ${cr}) ÙƒØ±Ø§Ø¹ÙŠ <b>${tier}</b> ÙÙŠ <b>${region}</b> Ù„Ù…Ø¯Ø© <b>${months}</b> Ø´Ù‡Ø±Ù‹Ø§.</p>
    <h4>Ø§Ù„Ø­Ù‚ÙˆÙ‚ ÙˆØ§Ù„Ù…Ø²Ø§ÙŠØ§</h4><p>${rights}</p>
    <h4>Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4><p>Ù„Ø§ ÙˆØµÙˆÙ„ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø®ØµÙŠØ©. Ø£ÙŠ Ù…Ø´Ø§Ø±ÙƒØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ®Ø¶Ø¹ Ù„Ù€ PDPL ÙˆØ§ØªÙØ§Ù‚ÙŠØ§Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø³ØªÙ‚Ù„Ø©.</p>
    <button class="ghost" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø© / PDF</button>`;
  };
}
function pricingPage(){
  const v=$('#view'); v.innerHTML=`<div class="card">
    <div class="toolbar"><h2>Ù„ÙˆØ§Ø¦Ø­ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø±Ø¹Ø§ÙŠØ©</h2><span class="tag">Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</span></div>
    <table><thead><tr><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ (Ø±.Ø³)</th><th>Ø§Ù„Ù…Ø²Ø§ÙŠØ§</th></tr></thead>
      <tbody>
        <tr><td><b>Ù…Ø§Ø³ÙŠ</b></td><td>1,500,000</td><td>Ø´Ø¹Ø§Ø± Ø´Ø§Ù…Ù„ + ØªÙ‚Ø§Ø±ÙŠØ± Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠØ© + Ù…Ø¬Ù„Ø³ Ø§Ù„Ø±Ø¹Ø§Ø©</td></tr>
        <tr><td><b>Ø°Ù‡Ø¨ÙŠ</b></td><td>700,000</td><td>Ø´Ø¹Ø§Ø± Ø¨Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© + ØªÙ‚Ø§Ø±ÙŠØ± Ù†ØµÙ Ø³Ù†ÙˆÙŠØ© + Ø¯Ø¹ÙˆØ§Øª</td></tr>
        <tr><td><b>ÙØ¶ÙŠ</b></td><td>300,000</td><td>Ø´Ø¹Ø§Ø± Ø¨ØµÙØ­Ø© Ø§Ù„Ø±Ø¹Ø§Ø© + Ø´Ø§Ø±Ø© ØªÙ‚Ø§Ø±ÙŠØ±</td></tr>
      </tbody></table>
  </div>`;
}

/* === Ø§Ù„Ø£Ù…Ù† ÙˆØ§Ù„Ø±Ø¨Ø· === */
function ssoPage(){ const v=$('#view'); const cfg=loadCfg(); v.innerHTML=`<div class="card">
  <div class="toolbar"><h2>SSO Ù†ÙØ§Ø° (Ù…Ø­Ø§ÙƒØ§Ø©)</h2><span class="tag">OIDC</span></div>
  <p>ISSUER: <code>${cfg.sso.issuer}</code> â€¢ AUTHZ: <code>${cfg.sso.authorize_url}</code> â€¢ TOKEN: <code>${cfg.sso.token_url}</code></p>
  <button class="btn" id="nafath">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ù†ÙØ§Ø°</button>
  <pre id="ssoLog" class="callout" style="white-space:pre-wrap;margin-top:10px"></pre></div>`;
  $('#nafath').onclick=()=>{ const mock='USR-'+Math.random().toString(36).slice(2,8).toUpperCase(); $('#ssoLog').textContent=`â†’ code â†’ id_token\nUserID: ${mock}\nRoles: ["clinic.staff","referral.accept"]`; };
}
function rbacPage(){ const v=$('#view'); const allPerms=Array.from(new Set(Object.values(RBAC.roles).flat()));
  v.innerHTML=`<div class="card"><div class="toolbar"><h2>RBAC</h2><span class="tag">ØªØ¹Ø±ÙŠÙ ÙˆØªÙ‚ÙŠÙŠÙ…</span></div>
  <div class="grid two">
    <div><h3>Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</h3>${Object.entries(RBAC.roles).map(([r,ps])=>`<div class='note'><b>${r}</b>: ${ps.join(', ')}</div>`).join('')}
    <div class="form" style="margin-top:10px"><label>Ø¯ÙˆØ± Ø¬Ø¯ÙŠØ¯<input id="newRole"/></label><label>Ø§Ù…ØªÙŠØ§Ø²Ø§Øª (Ø¨ÙÙˆØ§ØµÙ„)<input id="newPerms"/></label><button class="btn" id="addRole">Ø­ÙØ¸</button></div></div>
    <div><h3>ØªÙ‚ÙŠÙŠÙ…</h3><div class="form">
      <label>Ø§Ù„Ø¯ÙˆØ±<select id="roleSel">${Object.keys(RBAC.roles).map(r=>`<option>${r}</option>`).join('')}</select></label>
      <label>Ø§Ù„Ø§Ù…ØªÙŠØ§Ø²<select id="permSel">${allPerms.map(p=>`<option>${p}</option>`).join('')}</select></label>
      <label>Ù…ÙˆØ§ÙÙ‚Ø© PDPLØŸ<select id="consSel"><option value="true">Ù†Ø¹Ù…</option><option value="false">Ù„Ø§</option></select></label></div>
      <button class="btn" id="eval">ØªÙ‚ÙŠÙŠÙ…</button>
      <pre id="rbacOut" class="callout" style="white-space:pre-wrap;margin-top:10px"></pre></div>
  </div></div>`;
  $('#addRole').onclick=()=>{ const r=$('#newRole').value.trim(); const perms=$('#newPerms').value.split(',').map(x=>x.trim()).filter(Boolean); if(!r||!perms.length) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚ÙŠÙ…'); RBAC.roles[r]=perms; alert('ØªÙ…'); route(); };
  $('#eval').onclick=()=>{ const role=$('#roleSel').value, perm=$('#permSel').value, consent=$('#consSel').value==='true'; $('#rbacOut').textContent=(can(role,perm,consent)?'âœ… Ù…Ø³Ù…ÙˆØ­':'â›” Ù…Ø±ÙÙˆØ¶')+`\nØ§Ù„Ø¯ÙˆØ±: ${role}\nØ§Ù„Ø§Ù…ØªÙŠØ§Ø²: ${perm}\nØ§Ù„Ù…ÙˆØ§ÙÙ‚Ø©: ${consent}`; };
}
function configPage(){ const v=$('#view'); const cfg=loadCfg(); v.innerHTML=`<div class="card">
  <div class="toolbar"><h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2><span class="tag">Endpoints</span></div>
  <div class="grid two form">
    <label>SSO Issuer<input id="issuer" value="${cfg.sso.issuer}"/></label>
    <label>Authorize URL<input id="authz" value="${cfg.sso.authorize_url}"/></label>
    <label>Token URL<input id="token" value="${cfg.sso.token_url}"/></label>
    <label>Client ID<input id="cid" value="${cfg.sso.client_id}"/></label>
    <label>Redirect URI<input id="redir" value="${cfg.sso.redirect_uri}"/></label>
  </div>
  <h3>Ù…Ø³Ø§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ©</h3>
  <div class="grid two form">
    ${Object.entries(cfg.apis.internal).map(([k,v2])=>`<label>${k}<input data-int="${k}" value="${v2}"/></label>`).join('')}
  </div>
  <div class="tools"><button class="btn" id="saveCfg">Ø­ÙØ¸</button><button class="ghost" id="dlCfg">ØªÙ†Ø²ÙŠÙ„ config.json</button><button class="ghost" id="resetCfg">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button></div>
</div>`;
  $('#saveCfg').onclick=()=>{ const next={ sso:{ issuer:$('#issuer').value, authorize_url:$('#authz').value, token_url:$('#token').value, client_id:$('#cid').value, redirect_uri:$('#redir').value }, apis:{ internal:Object.fromEntries($$('[data-int]').map(i=>[i.dataset.int,i.value])) } }; saveCfg(next); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'); };
  $('#dlCfg').onclick=()=>downloadJSON('config.json', loadCfg());
  $('#resetCfg').onclick=()=>{ localStorage.removeItem('nomu_cfg'); alert('ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©'); route(); };
}

/* === Ø³ÙŠØ§Ø³Ø§Øª / Ù…Ø³Ø§Ø¹Ø¯Ø© / Ø´Ø±ÙˆØ· === */
function privacyPage(){ const v=$('#view'); v.innerHTML=`<div class="card"><div class="toolbar"><h2>Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© (PDPL)</h2><span class="tag">ØªÙ†ÙÙŠØ°ÙŠØ©</span></div>
<ul><li>Ù…ÙˆØ§ÙÙ‚Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</li><li>ØªØ´ÙÙŠØ± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ù‚Ù„ ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ†</li><li>RBAC ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø«Ø±</li><li>Ø­Ù‚ÙˆÙ‚: Ø§Ù„Ø§Ø·Ù„Ø§Ø¹/Ø§Ù„ØªØµØ­ÙŠØ­/Ø§Ù„Ø³Ø­Ø¨/Ø§Ù„Ø­Ø°Ù</li></ul><button class="ghost" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button></div>`; }
function childPage(){ const v=$('#view'); v.innerHTML=`<div class="card"><div class="toolbar"><h2>Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø·ÙÙ„</h2><span class="tag">Ø³Ù„Ø§Ù…Ø© Ø£ÙˆÙ„Ù‹Ø§</span></div>
<ol><li>ØªÙˆØ«ÙŠÙ‚ Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©</li><li>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø±</li><li>Ø§Ù„Ø¥Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</li></ol><div class="callout">Ù‚Ù†Ø§Ø© Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø®ÙˆÙ‘Ù„ÙŠÙ†.</div><button class="ghost" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button></div>`; }
function helpPage(){ const v=$('#view'); v.innerHTML=`<div class="card"><div class="toolbar"><h2>Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</h2><span class="tag">FAQ</span></div>
<details open><summary><b>Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ</b></summary><p>ÙƒÙ„ Ù…Ø§ ØªÙØ¯Ø®Ù„Ù‡ ÙŠÙØ­ÙØ¸ ÙÙŠ LocalStorage ÙˆÙŠÙ…ÙƒÙ† ØªØµØ¯ÙŠØ±Ù‡ JSON/CSV.</p></details>
<details><summary><b>Ø±Ø¨Ø· Ø§Ù„Ø®Ù„ÙÙŠØ©</b></summary><p>Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯ÙˆØ§Ù„ API Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ø¨ÙˆØ§Ø¬Ù‡ØªÙƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© (fetch).</p></details></div>`; }
function termsPage(){ const v=$('#view'); v.innerHTML=`<div class="card"><div class="toolbar"><h2>Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</h2><span class="tag">Ø§Ø³ØªØ®Ø¯Ø§Ù…</span></div>
<ul><li>Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„ÙˆØ·Ù†ÙŠØ© ÙˆPDPL.</li><li>Ø­Ø¸Ø± Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©.</li><li>Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø¹Ø¨Ø± Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ©.</li></ul><button class="ghost" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button></div>`; }

/* === API Docs / Export === */
function apiDocsPage(){ const v=$('#view'); const cfg=loadCfg(); v.innerHTML=`<div class="card">
  <div class="toolbar"><h2>API Docs (Ù…Ø­Ø§ÙƒØ§Ø©)</h2><span class="tag">Endpoints</span></div>
  <table><thead><tr><th>Ø§Ù„ÙƒÙŠØ§Ù†</th><th>Endpoint</th></tr></thead><tbody>${Object.entries(cfg.apis.internal).map(([k,val])=>`<tr><td>${k}</td><td><code>${val}</code></td></tr>`).join('')}</tbody></table>
  <h3>POST /api/health/referral</h3><pre class="callout">{ "mrn":"...", "ref_to":"education", "priority":"high", "attachments":["url1"] }</pre>
</div>`; }
function exportPage(){ const v=$('#view'); const db=DB(); v.innerHTML=`<div class="card"><div class="toolbar"><h2>ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2><span class="tag">LocalStorage</span></div>
<div class="tools"><button class="btn" id="dlDb">ØªÙ†Ø²ÙŠÙ„ JSON ÙƒØ§Ù…Ù„</button><label class="ghost" style="padding:6px 10px;border-radius:10px;cursor:pointer">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON<input id="upDb" type="file" accept="application/json" style="display:none"/></label><button class="ghost" id="wipe">ØªÙØ±ÙŠØº ÙƒØ§Ù…Ù„</button></div>
<pre class="note">Ø§Ù„Ù…ÙØªØ§Ø­: ${DB_KEY} â€¢ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: ${new Blob([JSON.stringify(db)]).size} Ø¨Ø§ÙŠØª</pre></div>`;
  $('#dlDb').onclick=()=>downloadJSON('nomu_db_backup.json', DB());
  $('#upDb').onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ const obj=JSON.parse(fr.result||'{}'); DB_SAVE(obj); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'); }catch(err){ alert('JSON ØºÙŠØ± ØµØ§Ù„Ø­'); } }; fr.readAsText(f); };
  $('#wipe').onclick=()=>{ if(confirm('Ø³ÙŠÙ…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©')){ DB_SAVE({}); alert('ØªÙ…'); } };
}

/* ============= Router ============= */
const routes={
  '/intro':intro,'/kpi':kpiPage,
  '/acc/health':()=>accountPage('health'),'/acc/clinic':()=>accountPage('clinic'),'/acc/education':()=>accountPage('education'),
  '/acc/neighborhood':()=>accountPage('neighborhood'),'/acc/nonprofit':()=>accountPage('nonprofit'),'/acc/hr':()=>accountPage('hr'),
  '/acc/csr':()=>accountPage('csr'),'/acc/family':()=>accountPage('family'),'/acc/admin':()=>accountPage('admin'),
  '/dispatch':dispatchPage,'/ops':opsPage,
  '/sponsors':sponsorsPage,'/pricing':pricingPage,
  '/sso':ssoPage,'/rbac':rbacPage,'/config':configPage,
  '/privacy':privacyPage,'/child':childPage,'/help':helpPage,'/terms':termsPage,
  '/export':exportPage,'/apidocs':apiDocsPage
};
if(!location.hash) location.hash='#/intro';
route();
</script>
</body>
</html>
