<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نمو NOMU — منصة وطنية للطفولة المبكرة</title>
  <meta name="description" content="نمو NOMU — نموذج أحادي الملف: لوحات، RBAC، i18n، تصدير CSV، نماذج متقدمة، سوق الرعاية، إحالات، وإدارة خصوصية (PDPL)." />
  <style>
    :root{ --bg:#0b1220;--card:#121a2b;--muted:#1a2440;--pri:#5ac8fa;--sec:#8ef6d0;--acc:#ffd166;--danger:#ff6b6b;--ok:#22c55e;--text:#e6edf7;--sub:#a7b0c3;--border:#263251;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:18px;--pad:18px;--gap:14px;--gap-lg:22px;--font:system-ui,"Segoe UI",Tahoma,Arial;--mono:ui-monospace,Consolas,monaco,monospace }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1220 0%,#0b1220 50%,#0e172a 100%);color:var(--text);font:15px/1.6 var(--font)}
    a{color:var(--pri);text-decoration:none}
    .app{display:grid;grid-template-rows:auto 1fr;min-height:100vh}
    header{position:sticky;top:0;z-index:50;background:rgba(11,18,32,.85);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
    .topbar{display:flex;align-items:center;gap:12px;max-width:1200px;margin:auto;padding:10px var(--pad)}
    .logo{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px}
    .logo img{width:34px;height:34px;border-radius:8px;object-fit:cover}
    .logo .ph{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,var(--pri),var(--sec))}
    .badge{display:inline-flex;align-items:center;gap:6px;background:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--sub);font-size:12px}
    .search{margin-inline-start:auto;position:relative}
    .search input{width:320px;max-width:60vw;background:var(--card);border:1px solid var(--border);color:var(--text);padding:10px 34px 10px 12px;border-radius:10px}
    .search svg{position:absolute;inset-inline-end:10px;top:50%;transform:translateY(-50%);opacity:.7}
    .user{display:flex;align-items:center;gap:10px}
    .avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#4158d0,#c850c0 60%,#ffcc70)}

    .main{max-width:1200px;margin:24px auto;display:grid;grid-template-columns:260px 1fr;gap:var(--gap-lg);padding:0 var(--pad)}
    nav{position:sticky;top:65px;height:fit-content}
    .side{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:10px}
    .group{margin:10px 0}
    .group h4{margin:6px 12px 8px;color:var(--sub);font-weight:600;font-size:13px}
    .link{display:flex;align-items:center;gap:10px;border-radius:10px;padding:10px 12px;color:var(--text);border:1px solid transparent}
    .link:hover{background:var(--muted);border-color:var(--border)}
    .link.active{background:linear-gradient(180deg,rgba(90,200,250,.09),rgba(90,200,250,.04));border-color:#274a70}
    .link[hidden]{display:none}

    .content{display:grid;gap:var(--gap-lg)}
    .cards{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap)}
    .card{grid-column:span 4;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow)}
    .card span.k{display:block;color:var(--sub);font-size:12px}
    .card b.v{display:block;font-size:26px;margin-top:6px}
    .card small{color:var(--sub)}
    .wide{grid-column:span 12}
    .half{grid-column:span 6}
    .third{grid-column:span 4}

    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button,.btn{background:var(--pri);color:#071426;border:none;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(90,200,250,.25)}
    button.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
    button.warn{background:var(--acc);color:#1b1100}
    button.danger{background:var(--danger)}
    .tag{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--muted);padding:6px 10px;border-radius:999px;color:var(--sub);font-size:12px}

    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{text-align:right;padding:12px;background:var(--card)}
    th{color:var(--sub);font-size:12px}
    tbody tr{border:1px solid var(--border)}
    tbody td{border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
    tbody td:first-child{border-inline-start:1px solid var(--border);border-start-start-radius:10px;border-end-start-radius:10px}
    tbody td:last-child{border-inline-end:1px solid var(--border);border-start-end-radius:10px;border-end-end-radius:10px}

    .grid{display:grid;gap:var(--gap)}
    .grid.two{grid-template-columns:1fr 1fr}
    .grid.three{grid-template-columns:repeat(3,1fr)}

    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.5);backdrop-filter:blur(2px)}
    .modal.open{display:grid}
    .modal .box{width:min(700px,94vw);background:var(--card);border:1px solid var(--border);border-radius:18px;padding:20px;box-shadow:var(--shadow)}

    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0f172a;color:var(--text)}
    label{font-size:13px;color:var(--sub)}
    .field{display:grid;gap:6px;margin:10px 0}
    .help{font-size:12px;color:var(--sub)}
    .err{color:var(--acc);font-size:12px}

    .empty{border:1px dashed var(--border);border-radius:14px;padding:26px;color:var(--sub);text-align:center}
    .footer{margin:30px auto;max-width:1200px;color:var(--sub);text-align:center;padding:10px}

    /* Architecture page styles */
    .arch {display:grid; gap: var(--gap-lg)}
    .arch .grid-2 {display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap)}
    .arch .tree {background: var(--card); border:1px solid var(--border); border-radius: var(--radius); padding: var(--pad)}
    .arch details {border:1px dashed var(--border); border-radius:12px; padding:10px; margin:8px 0; background: #0f172a}
    .arch summary {cursor:pointer; font-weight:700}
    .arch .muted {color: var(--sub); font-size:12px}
    .arch .pill {display:inline-flex; gap:8px; padding:6px 10px; border:1px solid var(--border); background:var(--muted); border-radius:999px; font-size:12px; margin:4px 6px 0 0}
    .arch .badge-ok{background:rgba(34,197,94,.15); border-color:#14532d}
    .arch .searchbar input{width:100%; background:var(--card); border:1px solid var(--border); color:var(--text); padding:10px 12px; border-radius:10px}
    .arch .hit {outline:2px solid var(--pri); border-radius:10px}

    @media (max-width:960px){
      .main{grid-template-columns:1fr}
      nav{position:static}
      .cards{grid-template-columns:repeat(6,1fr)}
      .card{grid-column:span 6}
      .half{grid-column:span 6}
      .third{grid-column:span 6}
      .arch .grid-2 {grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="topbar" role="banner">
      <div class="logo" aria-label="NOMU">
        <img id="logo" alt="شعار" class="ph" />
        <span id="t-app">نمو NOMU</span>
        <span class="badge" title="نموذج">Prototype</span>
      </div>
      <nav class="actions" aria-label="التنقل السريع">
        <a class="btn" href="#/home" data-i18n="nav.home">الرئيسية</a>
        <button class="ghost" onclick="openLogin()" data-i18n="nav.login">تسجيل الدخول</button>
        <button class="ghost" onclick="openConsent()" data-i18n="nav.consent">الموافقة والخصوصية</button>
      </nav>
      <div class="search" role="search">
        <input id="q" placeholder="ابحث عن طفل، إحالة، جمعية، مبادرة…" oninput="globalSearch(this.value)" />
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      </div>
      <div class="user" aria-label="الحساب">
        <div class="tag" id="roleTag">دخول ضيف</div>
        <div class="avatar" title="المستخدم"></div>
      </div>
    </div>
  </header>

  <main class="main" role="main">
    <nav>
      <div class="side" role="navigation" aria-label="أقسام المنصة">
        <div class="group">
          <h4 data-i18n="nav.dashboards">لوحات القيادة</h4>
          <a class="link active" href="#/home" data-route data-i18n="nav.home">الرئيسية</a>
          <a class="link" href="#/family" data-route data-perm="family:view" data-i18n="nav.family">حساب الأسرة</a>
          <a class="link" href="#/health" data-route data-perm="health:view" data-i18n="nav.health">الصحة</a>
          <a class="link" href="#/education" data-route data-perm="education:view" data-i18n="nav.education">التعليم</a>
          <a class="link" href="#/nonprofit" data-route data-perm="nonprofit:view" data-i18n="nav.nonprofit">الجمعيات</a>
          <a class="link" href="#/csr" data-route data-perm="csr:view" data-i18n="nav.csr">القطاع الخاص (CSR)</a>
          <a class="link" href="#/admin" data-route data-perm="admin:view" data-i18n="nav.admin">اللجنة الوطنية / الإدارة</a>
          <a class="link" href="#/architecture" data-route data-i18n="nav.arch">خريطة الهيكل</a>
        </div>
        <div class="group">
          <h4 data-i18n="nav.tools">أدوات</h4>
          <a class="link" href="#/market" data-route data-perm="market:view" data-i18n="nav.market">سوق الرعاية</a>
          <a class="link" href="#/referrals" data-route data-perm="referrals:view" data-i18n="nav.referrals">الإحالات</a>
          <a class="link" href="#/reports" data-route data-perm="reports:view" data-i18n="nav.reports">التقارير</a>
          <a class="link" href="#/settings" data-route data-i18n="nav.settings">الإعدادات</a>
        </div>
      </div>
    </nav>

    <section class="content" id="view"></section>
  </main>

  <footer class="footer" id="footer-note">
    نمو — نموذج أحادي الملف. البيانات محليًا (LocalStorage). يمكن تفعيل API ورفع شعار من الإعدادات.
  </footer>
</div>

<!-- Toasts -->
<div id="toastRegion" role="status" aria-live="polite" style="position:fixed;inset-inline-start:18px;bottom:18px;display:grid;gap:8px;z-index:9999"></div>

<!-- Modals -->
<div class="modal" id="modal-login" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
  <div class="box">
    <h3 id="loginTitle" data-i18n="login.title">تسجيل الدخول</h3>
    <p class="help" id="loginHelp" data-i18n="login.help">اختر نوع الحساب لتجربة الواجهات.</p>
    <div class="grid two">
      <div class="field">
        <label data-i18n="login.role">نوع المستخدم</label>
        <select id="loginRole" required>
          <option value="guest">ضيف</option>
          <option value="family">أسرة</option>
          <option value="health">الصحة</option>
          <option value="education">التعليم</option>
          <option value="nonprofit">جمعية</option>
          <option value="csr">شركة (CSR)</option>
          <option value="admin">لجنة وطنية</option>
        </select>
        <div class="err" data-err="loginRole"></div>
      </div>
      <div class="field">
        <label data-i18n="login.region">المنطقة الإدارية</label>
        <select id="loginRegion" required>
          <option>الرياض</option>
          <option>حائل</option>
          <option>الشرقية</option>
          <option>مكة المكرمة</option>
          <option>المدينة المنورة</option>
        </select>
        <div class="err" data-err="loginRegion"></div>
      </div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button onclick="doLogin()" data-i18n="btn.login">دخول</button>
      <button class="ghost" onclick="closeModal('modal-login')" data-i18n="btn.cancel">إلغاء</button>
    </div>
  </div>
</div>

<div class="modal" id="modal-consent" role="dialog" aria-modal="true" aria-labelledby="consentTitle" aria-describedby="consentDesc">
  <div class="box">
    <h3 id="consentTitle" data-i18n="consent.title">الموافقة وإدارة الخصوصية (PDPL)</h3>
    <p class="help" id="consentDesc">حدد موافقاتك على معالجة البيانات ومشاركتها.</p>
    <div class="grid two">
      <div class="field"><label><input type="checkbox" id="c1"> <span data-i18n="consent.c1">معالجة بيانات الأم خلال الحمل لأغراض المتابعة الصحية</span></label></div>
      <div class="field"><label><input type="checkbox" id="c2"> <span data-i18n="consent.c2">مشاركة تقارير الطفل النمائية مع وزارة التعليم</span></label></div>
      <div class="field"><label><input type="checkbox" id="c3"> <span data-i18n="consent.c3">مشاركة بيانات الدعم الاجتماعي مع الوزارة المختصة</span></label></div>
      <div class="field"><label><input type="checkbox" id="c4"> <span data-i18n="consent.c4">تلقي تنبيهات وتوصيات عبر البريد/الرسائل</span></label></div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button onclick="saveConsent()" data-i18n="btn.save">حفظ</button>
      <button class="ghost" onclick="closeModal('modal-consent')" data-i18n="btn.cancel">إلغاء</button>
    </div>
  </div>
</div>

<div class="modal" id="modal-screening" role="dialog" aria-modal="true" aria-labelledby="screeningTitle">
  <div class="box">
    <h3 id="screeningTitle" data-i18n="screening.title">تسجيل فحص</h3>
    <div class="grid two">
      <div class="field"><label data-i18n="labels.childId">معرف الطفل</label><input id="f_sc_child" data-req data-pattern="^C-\\d+$" placeholder="C-501"><div class="err" data-err="f_sc_child"></div></div>
      <div class="field"><label data-i18n="labels.type">نوع الفحص</label><select id="f_sc_type"><option>نمو نمائي</option><option>سمع</option><option>نظر</option><option>نفسي</option></select></div>
      <div class="field"><label data-i18n="labels.date">التاريخ</label><input id="f_sc_date" type="date" data-req><div class="err" data-err="f_sc_date"></div></div>
      <div class="field"><label data-i18n="labels.result">النتيجة</label><input id="f_sc_result" placeholder="سليم / إحالة / متابعة"></div>
      <div class="field"><label data-i18n="labels.facility">المنشأة</label><input id="f_sc_facility" placeholder="مركز صحي - المنطقة"></div>
    </div>
    <div class="actions"><button onclick="submitScreening()" data-i18n="btn.save">حفظ</button><button class="ghost" onclick="closeModal('modal-screening')" data-i18n="btn.cancel">إلغاء</button></div>
  </div>
</div>

<div class="modal" id="modal-referral" role="dialog" aria-modal="true" aria-labelledby="refTitle">
  <div class="box">
    <h3 id="refTitle" data-i18n="referral.title">إنشاء إحالة</h3>
    <div class="grid two">
      <div class="field"><label data-i18n="labels.from">من</label><select id="f_ref_from"><option>الأسرة</option><option>الصحة</option><option>التعليم</option><option>جمعية</option></select></div>
      <div class="field"><label data-i18n="labels.to">إلى</label><select id="f_ref_to"><option>الصحة</option><option>التعليم</option><option>جمعية</option></select></div>
      <div class="field"><label data-i18n="labels.childId">معرف الطفل</label><input id="f_ref_child" data-req data-pattern="^C-\\d+$" placeholder="C-501"><div class="err" data-err="f_ref_child"></div></div>
      <div class="field"><label data-i18n="labels.priority">الأولوية</label><select id="f_ref_pri"><option>عادية</option><option>عاجلة</option></select></div>
      <div class="field"><label data-i18n="labels.status">الحالة</label><select id="f_ref_status"><option>قيد المعالجة</option><option>مكتملة</option></select></div>
      <div class="field"><label data-i18n="labels.date">التاريخ</label><input id="f_ref_date" type="date" data-req><div class="err" data-err="f_ref_date"></div></div>
    </div>
    <div class="actions"><button onclick="submitReferral()" data-i18n="btn.save">حفظ</button><button class="ghost" onclick="closeModal('modal-referral')" data-i18n="btn.cancel">إلغاء</button></div>
  </div>
</div>

<div class="modal" id="modal-iep" role="dialog" aria-modal="true" aria-labelledby="iepTitle">
  <div class="box">
    <h3 id="iepTitle" data-i18n="iep.title">إنشاء خطة IEP</h3>
    <div class="grid two">
      <div class="field"><label data-i18n="labels.childId">معرف الطفل</label><input id="f_iep_child" data-req data-pattern="^C-\\d+$" placeholder="C-502"><div class="err" data-err="f_iep_child"></div></div>
      <div class="field"><label data-i18n="labels.review">مراجعة</label><input id="f_iep_review" type="date" data-req><div class="err" data-err="f_iep_review"></div></div>
      <div class="field" style="grid-column:1/-1"><label data-i18n="labels.goals">الأهداف</label><textarea id="f_iep_goals" rows="3" placeholder="أهداف قابلة للقياس بزمن ومسؤولية"></textarea></div>
    </div>
    <div class="actions"><button onclick="submitIEP()" data-i18n="btn.save">حفظ</button><button class="ghost" onclick="closeModal('modal-iep')" data-i18n="btn.cancel">إلغاء</button></div>
  </div>
</div>

<div class="modal" id="modal-market" role="dialog" aria-modal="true" aria-labelledby="mTitle">
  <div class="box">
    <h3 id="mTitle" data-i18n="market.title">طرح مبادرة</h3>
    <div class="grid two">
      <div class="field"><label data-i18n="labels.title">العنوان</label><input id="f_m_title" data-req placeholder="جلسات تدخل مبكر - الرياض"><div class="err" data-err="f_m_title"></div></div>
      <div class="field"><label data-i18n="labels.kpi">الهدف (KPI)</label><input id="f_m_kpi" data-req placeholder="100 طفل خلال 6 أشهر"><div class="err" data-err="f_m_kpi"></div></div>
      <div class="field"><label data-i18n="labels.ask">المبلغ المطلوب</label><input id="f_m_ask" type="number" min="0" step="1000" data-req placeholder="100000"><div class="err" data-err="f_m_ask"></div></div>
      <div class="field"><label data-i18n="labels.owner">الجهة المالكة</label><input id="f_m_owner" data-req placeholder="جمعية نماء"><div class="err" data-err="f_m_owner"></div></div>
    </div>
    <div class="actions"><button onclick="submitMarket()" data-i18n="btn.save">حفظ</button><button class="ghost" onclick="closeModal('modal-market')" data-i18n="btn.cancel">إلغاء</button></div>
  </div>
</div>

<div class="modal" id="modal-csr" role="dialog" aria-modal="true" aria-labelledby="csrTitle">
  <div class="box">
    <h3 id="csrTitle" data-i18n="csr.title">مساهمة CSR</h3>
    <div class="grid two">
      <div class="field"><label data-i18n="labels.marketId">معرف المبادرة</label><input id="f_csr_to" data-req placeholder="M-1"><div class="err" data-err="f_csr_to"></div></div>
      <div class="field"><label data-i18n="labels.company">الشركة</label><input id="f_csr_company" data-req placeholder="شركة الأفق"><div class="err" data-err="f_csr_company"></div></div>
      <div class="field"><label data-i18n="labels.amount">المبلغ (ر.س)</label><input id="f_csr_amount" type="number" min="0" step="1000" data-req placeholder="20000"><div class="err" data-err="f_csr_amount"></div></div>
      <div class="field"><label data-i18n="labels.date">التاريخ</label><input id="f_csr_date" type="date" data-req><div class="err" data-err="f_csr_date"></div></div>
    </div>
    <div class="actions"><button onclick="submitCSR()" data-i18n="btn.save">حفظ</button><button class="ghost" onclick="closeModal('modal-csr')" data-i18n="btn.cancel">إلغاء</button></div>
  </div>
</div>

<div class="modal" id="modal-logo" role="dialog" aria-modal="true" aria-labelledby="logoTitle">
  <div class="box">
    <h3 id="logoTitle" data-i18n="logo.title">رفع شعار الجهة</h3>
    <div class="field"><input type="file" accept="image/*" id="logoFile"></div>
    <div class="actions"><button onclick="uploadLogo()" data-i18n="btn.save">حفظ</button><button class="ghost" onclick="closeModal('modal-logo')" data-i18n="btn.cancel">إلغاء</button></div>
  </div>
</div>

<script>
/* ==========================================================
   NOMU — Single-File Prototype (RTL/AR + EN)
   ========================================================== */
const $ = (q,root=document)=>root.querySelector(q);
const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));

/* ---------- i18n ---------- */
const i18n = {
  lang: localStorage.getItem('nomu.lang') || 'ar',
  t: {
    ar: {'nav.home':'الرئيسية','nav.login':'تسجيل الدخول','nav.consent':'الموافقة والخصوصية','nav.dashboards':'لوحات القيادة','nav.family':'حساب الأسرة','nav.health':'الصحة','nav.education':'التعليم','nav.nonprofit':'الجمعيات','nav.csr':'القطاع الخاص (CSR)','nav.admin':'اللجنة الوطنية / الإدارة','nav.tools':'أدوات','nav.market':'سوق الرعاية','nav.referrals':'الإحالات','nav.reports':'التقارير','nav.settings':'الإعدادات',
      'nav.arch':'خريطة الهيكل','arch.title':'خريطة هيكل منصة نمو','arch.filter':'فلتر / بحث…','arch.layers':'الطبقات','arch.national':'الطبقة الوطنية','arch.accounts':'حسابات المنصة','arch.shared':'المكونات المشتركة','arch.journey':'رحلة الطفل (Transitions)','arch.kpis':'مؤشرات رئيسية','arch.roleScoped':'يعرض العناصر وفق صلاحيات دورك الحالي',
      'arch.kpi_screened':'% الأطفال المفحوصين نمائيًا','arch.kpi_ready':'% الأطفال الجاهزين للمدرسة','arch.kpi_csr':'CSR / منح (ر.س)','arch.kpi_referrals':'الإحالات النشطة','arch.kpi_funded':'المبادرات الممولة',
      'login.title':'تسجيل الدخول','login.help':'اختر نوع الحساب لتجربة الواجهات.','login.role':'نوع المستخدم','login.region':'المنطقة الإدارية','btn.login':'دخول','btn.cancel':'إلغاء','btn.save':'حفظ','btn.print':'طباعة/حفظ PDF','btn.logo':'رفع شعار','consent.title':'الموافقة وإدارة الخصوصية (PDPL)','consent.c1':'معالجة بيانات الأم خلال الحمل لأغراض المتابعة الصحية','consent.c2':'مشاركة تقارير الطفل النمائية مع وزارة التعليم','consent.c3':'مشاركة بيانات الدعم الاجتماعي مع الوزارة المختصة','consent.c4':'تلقي تنبيهات وتوصيات عبر البريد/الرسائل','labels.childId':'معرف الطفل','labels.type':'نوع الفحص','labels.date':'التاريخ','labels.result':'النتيجة','labels.facility':'المنشأة','labels.from':'من','labels.to':'إلى','labels.priority':'الأولوية','labels.status':'الحالة','labels.review':'مراجعة','labels.goals':'الأهداف','labels.title':'العنوان','labels.kpi':'الهدف (KPI)','labels.ask':'المبلغ المطلوب','labels.owner':'الجهة المالكة','labels.marketId':'معرف المبادرة','labels.company':'الشركة','labels.amount':'المبلغ (ر.س)','screening.title':'تسجيل فحص','referral.title':'إنشاء إحالة','iep.title':'إنشاء خطة IEP','market.title':'طرح مبادرة','csr.title':'مساهمة CSR','logo.title':'رفع شعار الجهة','reports.export':'تصدير CSV','errors.required':'هذا الحقل مطلوب','errors.pattern':'صيغة غير صحيحة','toast.saved':'تم الحفظ','toast.updated':'تم التحديث','toast.apiSaved':'تم الإرسال عبر API','toast.apiFallback':'API غير متاح — حُفظ محليًا','region.set':'تم ضبط المنطقة','role.signed':'تم تسجيل الدخول كـ '},
    en: {'nav.home':'Home','nav.login':'Sign in','nav.consent':'Consent & Privacy','nav.dashboards':'Dashboards','nav.family':'Family','nav.health':'Health','nav.education':'Education','nav.nonprofit':'Nonprofits','nav.csr':'Private Sector (CSR)','nav.admin':'National Committee / Admin','nav.tools':'Tools','nav.market':'Care Marketplace','nav.referrals':'Referrals','nav.reports':'Reports','nav.settings':'Settings',
      'nav.arch':'Architecture Map','arch.title':'NOMU Platform Architecture','arch.filter':'Filter / Search…','arch.layers':'Layers','arch.national':'National Layer','arch.accounts':'Platform Accounts','arch.shared':'Shared Components','arch.journey':'Child Journey (Transitions)','arch.kpis':'Key Indicators','arch.roleScoped':'Items reflect your current RBAC role',
      'arch.kpi_screened':'% of children screened (developmental)','arch.kpi_ready':'% of school-ready children','arch.kpi_csr':'CSR / Grants (SAR)','arch.kpi_referrals':'Active Referrals','arch.kpi_funded':'Funded Initiatives',
      'login.title':'Sign in','login.help':'Pick a role to explore the UI.','login.role':'Role','login.region':'Region','btn.login':'Sign in','btn.cancel':'Cancel','btn.save':'Save','btn.print':'Print / Save PDF','btn.logo':'Upload Logo','consent.title':'Consent & Privacy (PDPL)','consent.c1':'Process maternal data during pregnancy for healthcare follow-up','consent.c2':'Share child developmental reports with MoE','consent.c3':'Share social support data with the relevant ministry','consent.c4':'Receive alerts/recommendations via email/SMS','labels.childId':'Child ID','labels.type':'Type','labels.date':'Date','labels.result':'Result','labels.facility':'Facility','labels.from':'From','labels.to':'To','labels.priority':'Priority','labels.status':'Status','labels.review':'Review','labels.goals':'Goals','labels.title':'Title','labels.kpi':'KPI','labels.ask':'Requested Amount','labels.owner':'Owner','labels.marketId':'Market ID','labels.company':'Company','labels.amount':'Amount (SAR)','screening.title':'Record Screening','referral.title':'Create Referral','iep.title':'Create IEP','market.title':'Post Initiative','csr.title':'CSR Contribution','logo.title':'Upload Logo','reports.export':'Export CSV','errors.required':'This field is required','errors.pattern':'Invalid format','toast.saved':'Saved','toast.updated':'Updated','toast.apiSaved':'Sent via API','toast.apiFallback':'API unavailable — saved locally','region.set':'Region set','role.signed':'Signed in as '}
  }
};
function t(key){ const dict=i18n.t[i18n.lang]||i18n.t.ar; return dict[key]||key }
function applyI18n(){ const dict=i18n.t[i18n.lang]||i18n.t.ar; $$('[data-i18n]').forEach(el=>{ const key=el.getAttribute('data-i18n'); if(dict[key]) el.textContent=dict[key] }); document.documentElement.lang=i18n.lang; document.documentElement.dir=(i18n.lang==='ar')?'rtl':'ltr' }

/* ---------- API Bridge (اختياري) ---------- */
const api = { enabled:false, baseUrl:'https://api.example.com', token:null };
async function apiFetch(path,opts={}){ if(!api.enabled) throw new Error('API_DISABLED'); const res=await fetch(api.baseUrl+path,{ headers:Object.assign({'Content-Type':'application/json', ...(api.token?{Authorization:'Bearer '+api.token}:{})}), ...opts }); if(!res.ok){ const t=await res.text(); throw new Error('API '+res.status+': '+t) } return res.json() }

/* ---------- RBAC ---------- */
const permsByRole = {
  guest:['home:view','reports:view','market:view','referrals:view','settings:view'],
  family:['home:view','family:view','referrals:view','screening:create','settings:view'],
  health:['home:view','health:view','screening:create','referrals:create','reports:view','settings:view'],
  education:['home:view','education:view','iep:create','referrals:view','reports:view','settings:view'],
  nonprofit:['home:view','nonprofit:view','market:create','reports:view','settings:view'],
  csr:['home:view','csr:view','csr:create','market:view','reports:view','settings:view'],
  admin:['home:view','admin:view','family:view','health:view','education:view','nonprofit:view','csr:view','market:view','referrals:view','reports:view','settings:view']
};
function can(perm){ const role=store.state.user.role||'guest'; return (permsByRole[role]||[]).includes(perm) }
function enforceRBAC(){ $$('[data-perm]').forEach(el=>{ const need=el.getAttribute('data-perm'); el.hidden=!can(need) }) }

/* ---------- Store ---------- */
const store = {
  load(){
    try{
      const data=JSON.parse(localStorage.getItem('nomu')||'{}');
      this.state=Object.assign({
        user:{role:'guest',region:'الرياض'},
        ui:{logo:null},
        consent:{c1:false,c2:false,c3:false,c4:false},
        households:[{id:'H-1001', father:'محمد', mother:'سارة', region:'حائل',
          children:[{id:'C-501', name:'ليان', dob:'2021-03-10'},{id:'C-502', name:'تركي', dob:'2019-11-02'}]}],
        screenings:[{id:'S-9001', childId:'C-501', type:'نمو نمائي', date:'2025-09-20', result:'سليم', facility:'مركز صحي شمال حائل'}],
        referrals:[{id:'R-7001', from:'الصحة', to:'التعليم', childId:'C-502', priority:'عادية', status:'قيد المعالجة', created:'2025-09-25'}],
        ieps:[{id:'IEP-3001', childId:'C-502', goals:'تحسين المهارات اللغوية', review:'2025-12-01'}],
        nonprofits:[{id:'NPO-10', name:'جمعية نماء للطفولة', region:'حائل', programs:3, beneficiaries:120}],
        marketplace:[{id:'M-1', title:'جلسات تدخل مبكر لحائل', kpi:'100 طفل خلال 6 أشهر', ask:250000, funded:120000, owner:'جمعية نماء'}, {id:'M-2', title:'فحوص سمع لحديثي الولادة – الشرقية', kpi:'300 وليد', ask:180000, funded:45000, owner:'صحة الشرقية'}],
        csr:[{id:'CSR-100', company:'شركة الأفق', amount:50000, to:'M-1', date:'2025-10-01'}]
      }, data)
    }catch(e){ this.state={} }
  },
  save(){ localStorage.setItem('nomu', JSON.stringify(this.state)) }
};
store.load();

/* ---------- Utils ---------- */
function fmt(n){return new Intl.NumberFormat(i18n.lang==='ar'?'ar-SA':'en-US').format(n)}
function today(){return new Date().toISOString().slice(0,10)}
function toast(msg){ const wrap=$('#toastRegion'); const t=document.createElement('div'); t.setAttribute('role','status'); t.style.cssText='background:#111b;color:#fff;padding:10px 14px;border-radius:12px;backdrop-filter:blur(4px);display:flex;align-items:center;gap:10px'; t.innerHTML=`<span>${msg}</span><button aria-label="Dismiss" style="background:transparent;color:#fff;border:0;font-weight:700">×</button>`; t.querySelector('button').onclick=()=>t.remove(); wrap.appendChild(t); setTimeout(()=>t.remove(),3500) }
function escapeHtml(str){return (''+str).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]))}
function download(filename, text, type='text/csv;charset=utf-8;'){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type})); a.download=filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),500) }

/* ---------- KPIs helpers ---------- */
function kpisFromStore(){
  // إجمالي الأطفال
  const totalKids = (store.state.households||[]).reduce((a,h)=>a+(h.children?.length||0),0);

  // % الأطفال المفحوصين نمائيًا
  const screenedKids = new Set(
    (store.state.screenings||[])
      .filter(s => (s.type||'').includes('نمو'))
      .map(s => s.childId)
  ).size;
  const pctScreened = totalKids ? Math.round((screenedKids*100)/totalKids) : 0;

  // CSR/منح (ر.س)
  const csrTotal = (store.state.csr||[]).reduce((a,c)=>a+(c.amount||0),0);

  // % الجاهزين للمدرسة (تعريف مبدئي)
  const kids = (store.state.households||[]).flatMap(h=>h.children||[]);
  const now = new Date();
  const ageYears = dob => { const d=new Date(dob); return isNaN(d)?0:((now-d)/(365.25*24*3600*1000)); };
  const eligible = kids.filter(k=>{ const a=ageYears(k.dob); return a>=5 && a<7; });
  const activeRefKids = new Set((store.state.referrals||[]).filter(r=>r.status!=='مكتملة').map(r=>r.childId));
  const eligibleReady = eligible.filter(k=>{
    const hasScreening = (store.state.screenings||[]).some(s=>s.childId===k.id);
    const noActiveRef = !activeRefKids.has(k.id);
    return hasScreening && noActiveRef;
  }).length;
  const pctReady = eligible.length ? Math.round((eligibleReady*100)/eligible.length) : 0;

  // اتجاه الفحوص (آخر 6 أشهر)
  const byMonth = {};
  (store.state.screenings||[]).forEach(s=>{
    const m = (s.date||today()).slice(0,7);
    byMonth[m] = (byMonth[m]||0)+1;
  });
  const months = Object.keys(byMonth).sort();
  const trend = months.slice(-6).map(m=>byMonth[m]);

  // جديد: الإحالات النشطة + المبادرات الممولة
  const activeReferrals = (store.state.referrals||[]).filter(r=>r.status!=='مكتملة').length;
  const fundedInitiatives = (store.state.marketplace||[]).filter(m=>(m.funded||0)>0).length;

  // تمويل CSR شهريًا (آخر 6 أشهر)
  const csrByMonth = {};
  (store.state.csr||[]).forEach(c=>{
    const m = (c.date||today()).slice(0,7);
    csrByMonth[m] = (csrByMonth[m]||0) + (c.amount||0);
  });
  const csrMonths = Object.keys(csrByMonth).sort();
  const csrTrend = csrMonths.slice(-6).map(m=>csrByMonth[m]);

  return { pctScreened, pctReady, csrTotal, trend, activeReferrals, fundedInitiatives, csrTrend };
}

/* ---------- Router & Deep-links ---------- */
function parseHash(){ const [path,q='']=(location.hash.replace('#','')||'/home').split('?'); const params=Object.fromEntries(new URLSearchParams(q).entries()); return {path,params} }
const routes = { '/home': viewHome, '/family': viewFamily, '/health': viewHealth, '/education': viewEducation, '/nonprofit': viewNonprofit, '/csr': viewCSR, '/admin': viewAdmin, '/market': viewMarket, '/referrals': viewReferrals, '/reports': viewReports, '/settings': viewSettings, '/architecture': viewArchitecture };
function router(){ const {path,params}=parseHash(); $$('a.link').forEach(a=>a.classList.toggle('active',a.getAttribute('href')===`#${path}`)); const el = document.getElementById('view'); el.innerHTML=''; (routes[path]||view404)(el,params); enforceRBAC(); applyI18n(); handleDeepLinks(path,params) }
window.addEventListener('hashchange',router);
function handleDeepLinks(path,params){
  if(params.new==='true'){ if(path==='/market') openModal('modal-market'); if(path==='/referrals') openModal('modal-referral'); if(path==='/health' || path==='/family') openModal('modal-screening') }
  if(params.child){ const el=$('#f_sc_child'); if(el){ el.value=params.child } }
}

/* ---------- Helpers ---------- */
function kpiCard(title,value,delta){ return `<div class="card third"><span class="k">${title}</span><b class="v">${value}</b><small>${delta||''}</small></div>` }
function denyCard(){ return `<div class="empty"><b>${i18n.lang==='ar'?'صلاحيات غير كافية':'Insufficient permissions'}</b></div>` }

/* ---------- Views ---------- */
function viewHome(root){
  const totalKids = store.state.households.reduce((a,h)=>a+h.children.length,0);
  const screened = store.state.screenings.length;
  const referrals = store.state.referrals.length;
  const funded = store.state.marketplace.reduce((a,m)=>a+m.funded,0);
  root.innerHTML = `
    <div class="toolbar">
      <h2>${i18n.lang==='ar'?'لوحة وطنية مختصرة':'National Overview'}</h2>
      <div class="actions">
        <span class="tag">${i18n.lang==='ar'?'المنطقة':'Region'}: ${store.state.user.region}</span>
        <button onclick="location.hash='#/reports'">${i18n.lang==='ar'?'عرض التقارير':'Open Reports'}</button>
      </div>
    </div>
    <div class="cards">
      ${kpiCard(i18n.lang==='ar'?'الأطفال في السجل':'Registered Children', fmt(totalKids))}
      ${kpiCard(i18n.lang==='ar'?'فحوص نمائية مُسجلة':'Recorded Screenings', fmt(screened))}
      ${kpiCard(i18n.lang==='ar'?'إحالات نشطة':'Active Referrals', fmt(referrals))}
      ${kpiCard(i18n.lang==='ar'?'تمويل CSR/منح (ر.س)':'CSR/Grants Funding (SAR)', fmt(funded))}
      <div class="card wide" id="chart"></div>
      <div class="card half">
        <div class="toolbar"><b>${i18n.lang==='ar'?'آخر المبادرات في سوق الرعاية':'Latest Marketplace Initiatives'}</b>
          <div class="actions"><button class="ghost" onclick="location.hash='#/market'">${i18n.lang==='ar'?'إدارة':'Manage'}</button></div>
        </div>
        ${tableMarketplace(store.state.marketplace.slice(0,5))}
      </div>
      <div class="card half">
        <div class="toolbar"><b>${i18n.lang==='ar'?'آخر الإحالات':'Recent Referrals'}</b>
          <div class="actions"><button class="ghost" onclick="location.hash='#/referrals'">${i18n.lang==='ar'?'إدارة':'Manage'}</button></div>
        </div>
        ${tableReferrals(store.state.referrals.slice(0,5))}
      </div>
    </div>`;
  drawTrend($('#chart'), i18n.lang==='ar'?'أطفال مفحوصون خلال 6 أشهر':'Screened Children (6m)', [40,55,61,70,86,93]);
}

function viewFamily(root){
  if(!can('family:view')){ root.innerHTML=denyCard(); return }
  const h = store.state.households[0];
  root.innerHTML = `
    <div class="toolbar">
      <h2>${i18n.lang==='ar'?'حساب الأسرة':'Family Account'}</h2>
      <div class="actions">
        ${can('screening:create')?`<button onclick="openModal('modal-screening')">${i18n.lang==='ar'?'حجز/تسجيل فحص':'Book/Record Screening'}</button>`:''}
        ${can('referrals:create')?`<button class="ghost" onclick="openModal('modal-referral')">${i18n.lang==='ar'?'طلب إحالة':'Create Referral'}</button>`:''}
      </div>
    </div>
    <div class="cards">
      ${kpiCard(i18n.lang==='ar'?'الأطفال':'Children', h.children.length)}
      ${kpiCard(i18n.lang==='ar'?'فحوص مكتملة':'Completed Screenings', store.state.screenings.filter(s=>h.children.some(c=>c.id===s.childId)).length)}
      ${kpiCard(i18n.lang==='ar'?'إحالات مرتبطة':'Related Referrals', store.state.referrals.filter(r=>h.children.some(c=>c.id===r.childId)).length)}
      <div class="card wide">
        <div class="toolbar"><b>${i18n.lang==='ar'?'أطفال الأسرة':'Children'}</b>
          <div class="actions"><button class="ghost" onclick="addChild()">${i18n.lang==='ar'?'إضافة طفل':'Add Child'}</button></div>
        </div>
        ${tableKids(h.children)}
      </div>
      <div class="card half"><b>${i18n.lang==='ar'?'الفحوص':'Screenings'}</b>${tableScreenings(store.state.screenings.filter(s=>h.children.some(c=>c.id===s.childId)))}</div>
      <div class="card half"><b>${i18n.lang==='ar'?'التوصيات الذكية':'Smart Tips'}</b><div class="empty">${i18n.lang==='ar'?'ستظهر التوصيات حسب العمر والفحوص المنجزة.':'Tips will appear based on age and completed screenings.'}</div></div>
    </div>`;
}

function viewHealth(root){
  if(!can('health:view')){ root.innerHTML=denyCard(); return }
  root.innerHTML = `
    <div class="toolbar">
      <h2>${i18n.lang==='ar'?'وزارة الصحة':'Ministry of Health'}</h2>
      <div class="actions">
        ${can('screening:create')?`<button onclick="openModal('modal-screening')">${i18n.lang==='ar'?'تسجيل فحص':'Record Screening'}</button>`:''}
        ${can('referrals:create')?`<button class="ghost" onclick="openModal('modal-referral')">${i18n.lang==='ar'?'إحالة للتعليم':'Refer to Education'}</button>`:''}
      </div>
    </div>
    <div class="cards">
      ${kpiCard(i18n.lang==='ar'?'فحوص هذا الشهر':'This Month Screenings', store.state.screenings.filter(s=>s.date.slice(0,7)===today().slice(0,7)).length)}
      ${kpiCard(i18n.lang==='ar'?'متوسط زمن الانتظار (يوم)':'Avg Wait (days)', 7)}
      ${kpiCard(i18n.lang==='ar'?'الإحالات المرسلة':'Referrals Sent', store.state.referrals.filter(r=>r.from==='الصحة').length)}
      <div class="card wide"><b>${i18n.lang==='ar'?'سجل الفحوص':'Screenings Log'}</b>${tableScreenings(store.state.screenings)}</div>
    </div>`;
}

function viewEducation(root){
  if(!can('education:view')){ root.innerHTML=denyCard(); return }
  root.innerHTML = `
    <div class="toolbar">
      <h2>${i18n.lang==='ar'?'وزارة التعليم':'Ministry of Education'}</h2>
      <div class="actions">${can('iep:create')?`<button onclick="openModal('modal-iep')">${i18n.lang==='ar'?'إنشاء IEP':'Create IEP'}</button>`:''}</div>
    </div>
    <div class="cards">
      ${kpiCard(i18n.lang==='ar'?'تقارير الجاهزية الصادرة':'Readiness Reports Issued', 42)}
      ${kpiCard(i18n.lang==='ar'?'خطط IEP نشطة':'Active IEPs', store.state.ieps.length)}
      ${kpiCard(i18n.lang==='ar'?'إحالات واردة':'Incoming Referrals', store.state.referrals.filter(r=>r.to==='التعليم').length)}
      <div class="card half"><b>${i18n.lang==='ar'?'الإحالات الواردة':'Incoming Referrals'}</b>${tableReferrals(store.state.referrals.filter(r=>r.to==='التعليم'))}</div>
      <div class="card half"><b>IEP</b>${tableIEP(store.state.ieps)}</div>
    </div>`;
}

function viewNonprofit(root){
  if(!can('nonprofit:view')){ root.innerHTML=denyCard(); return }
  root.innerHTML = `
    <div class="toolbar">
      <h2>${i18n.lang==='ar'?'الجمعيات':'Nonprofits'}</h2>
      <div class="actions">${can('market:create')?`<button onclick="openModal('modal-market')">${i18n.lang==='ار'?'طرح مبادرة':'Post Initiative'}</button>`:''}</div>
    </div>
    <div class="cards">
      ${kpiCard(i18n.lang==='ar'?'برامج فعّالة':'Active Programs', 5)}
      ${kpiCard(i18n.lang==='ar'?'المستفيدون':'Beneficiaries', 120)}
      ${kpiCard(i18n.lang==='ar'?'المتطوعون':'Volunteers', 48)}
      <div class="card wide"><b>${i18n.lang==='ar'?'جمعيات مسجلة':'Registered NGOs'}</b>${tableNPOs(store.state.nonprofits)}</div>
    </div>`;
}

function viewCSR(root){
  if(!can('csr:view')){ root.innerHTML=denyCard(); return }
  root.innerHTML = `
    <div class="toolbar">
      <h2>CSR</h2>
      <div class="actions">${can('csr:create')?`<button onclick="openModal('modal-csr')">${i18n.lang==='ar'?'مساهمة جديدة':'New Contribution'}</button>`:''}</div>
    </div>
    <div class="cards">
      ${kpiCard(i18n.lang==='ar'?'إجمالي المساهمات (ر.س)':'Total Contributions (SAR)', fmt(store.state.csr.reduce((a,c)=>a+c.amount,0)))}
      ${kpiCard(i18n.lang==='ar'?'عدد الشركات':'Companies', new Set(store.state.csr.map(c=>c.company)).size)}
      ${kpiCard(i18n.lang==='ar'?'مبادرات مدعومة':'Supported Initiatives', new Set(store.state.csr.map(c=>c.to)).size)}
      <div class="card half"><b>${i18n.lang==='ar'?'المساهمات':'Contributions'}</b>${tableCSR(store.state.csr)}</div>
      <div class="card half"><b>${i18n.lang==='ar'?'سوق الرعاية':'Marketplace'}</b>${tableMarketplace(store.state.marketplace)}</div>
    </div>`;
}

function viewAdmin(root){
  if(!can('admin:view')){ root.innerHTML=denyCard(); return }
  root.innerHTML = `
    <div class="toolbar">
      <h2>${i18n.lang==='ar'?'اللجنة الوطنية / إدارة المنصة':'National Committee / Platform Admin'}</h2>
      <div class="actions">
        <button class="warn" onclick="seedDemo()">${i18n.lang==='ar'?'ملء بيانات تجريبية':'Seed Demo'}</button>
        <button class="danger" onclick="wipe()">${i18n.lang==='ar'?'مسح البيانات':'Wipe Data'}</button>
      </div>
    </div>
    <div class="cards">
      ${kpiCard(i18n.lang==='ar'?'مستخدمون نشطون (تجريبي)':'Active Users (Demo)', 312)}
      ${kpiCard(i18n.lang==='ar'?'عمليات تكامل ناجحة':'Successful Integrations', '99%')}
      ${kpiCard(i18n.lang==='ar'?'أمان وامتثال':'Security & Compliance', 'PDPL / MFA')}
      <div class="card half">
        <b>${i18n.lang==='ar'?'إعدادات عامة':'General Settings'}</b>
        <div class="grid two">
          <div class="field"><label>${i18n.lang==='ar'?'منطقة افتراضية':'Default Region'}</label>
            <select onchange="setRegion(this.value)">
              <option ${store.state.user.region==='الرياض'?'selected':''}>الرياض</option>
              <option ${store.state.user.region==='حائل'?'selected':''}>حائل</option>
              <option ${store.state.user.region==='الشرقية'?'selected':''}>الشرقية</option>
            </select>
          </div>
          <div class="field"><label>${i18n.lang==='ar'?'لغة الواجهة':'Interface Language'}</label>
            <select id="langSel" onchange="setLang(this.value)">
              <option value="ar" ${i18n.lang==='ar'?'selected':''}>العربية</option>
              <option value="en" ${i18n.lang==='en'?'selected':''}>English</option>
            </select>
          </div>
          <div class="field"><label>${i18n.lang==='ar'?'شعار الواجهة':'Logo'}</label>
            <div class="actions"><button class="ghost" onclick="openModal('modal-logo')">${i18n.lang==='ar'?'رفع شعار':'Upload Logo'}</button></div>
          </div>
        </div>
      </div>
      <div class="card half">
        <b>${i18n.lang==='ar'?'سياسات الخصوصية':'Privacy Policies'}</b>
        <div class="grid"><div class="tag">PoLP</div><div class="tag">Audit Trail</div><div class="tag">Encryption</div><div class="tag">Consent</div></div>
      </div>
    </div>`;
}

function viewMarket(root){ if(!can('market:view')){ root.innerHTML=denyCard(); return }
  root.innerHTML = `<div class="toolbar"><h2>${i18n.lang==='ar'?'سوق الرعاية':'Care Marketplace'}</h2><div class="actions">${can('market:create')?`<button onclick="openModal('modal-market')">${i18n.lang==='ar'?'مبادرة جديدة':'New Initiative'}</button>`:''}</div></div><div class="cards"><div class="card wide">${tableMarketplace(store.state.marketplace,true)}</div></div>` }

function viewReferrals(root){ if(!can('referrals:view')){ root.innerHTML=denyCard(); return }
  root.innerHTML = `<div class="toolbar"><h2>${i18n.lang==='ar'?'الإحالات':'Referrals'}</h2><div class="actions">${can('referrals:create')?`<button onclick="openModal('modal-referral')">${i18n.lang==='ar'?'إحالة جديدة':'New Referral'}</button>`:''}</div></div><div class="cards"><div class="card wide">${tableReferrals(store.state.referrals,true)}</div></div>` }

function viewReports(root){ if(!can('reports:view')){ root.innerHTML=denyCard(); return }
  const totals={kids:store.state.households.reduce((a,h)=>a+h.children.length,0), scr:store.state.screenings.length, ref:store.state.referrals.length};
  root.innerHTML = `<div class="toolbar"><h2>${i18n.lang==='ar'?'التقارير':'Reports'}</h2><div class="actions"><button class="ghost" onclick="window.print()" data-i18n="btn.print">طباعة/حفظ PDF</button><button onclick="exportCSVs()">${t('reports.export')}</button></div></div><div class="cards">${kpiCard(i18n.lang==='ar'?'إجمالي الأطفال':'Total Children', fmt(totals.kids))}${kpiCard(i18n.lang==='ar'?'الفحوص':'Screenings', fmt(totals.scr))}${kpiCard(i18n.lang==='ar'?'الإحالات':'Referrals', fmt(totals.ref))}<div class="card wide" id="chart2"></div><div class="card wide"><b>${i18n.lang==='ar'?'سجل كامل':'Full Dump'}</b><pre style="white-space:pre-wrap;background:#0f172a;border:1px solid var(--border);padding:12px;border-radius:12px;direction:ltr">${escapeHtml(JSON.stringify(store.state,null,2))}</pre></div></div>`;
  drawTrend($('#chart2'), i18n.lang==='ar'?'تمويل شهري (ر.س)':'Monthly Funding (SAR)', [20,30,15,60,40,80]);
}

function viewSettings(root){
  root.innerHTML = `<div class="toolbar"><h2>${i18n.lang==='ar'?'الإعدادات':'Settings'}</h2></div><div class="cards"><div class="card half"><b>${i18n.lang==='ar'?'إدارة الموافقات':'Consent Management'}</b><p class="help">${i18n.lang==='ar'?'نفس عناصر نافذة الخصوصية.':'Same as consent modal.'}</p><div class="actions"><button onclick="openConsent()">${i18n.lang==='ar'?'فتح':'Open'}</button></div></div><div class="card half"><b>${i18n.lang==='ar'?'جلسة المستخدم':'User Session'}</b><div class="actions"><button class="ghost" onclick="openLogin()">${i18n.lang==='ar'?'تبديل الدور':'Switch Role'}</button><button class="danger" onclick="wipe()">${i18n.lang==='ar'?'مسح البيانات المحلية':'Clear Local Data'}</button></div></div><div class="card wide"><b>${i18n.lang==='ar'?'وضع التكامل مع API':'API Bridge'}</b><div class="grid two"><div class="field"><label><input type="checkbox" id="api_enabled"> ${i18n.lang==='ar'?'تفعيل وضع API':'Enable API Mode'}</label><div class="help">${i18n.lang==='ar'?'عند التفعيل، يُستخدم REST بدلاً من LocalStorage.':'When enabled, REST replaces LocalStorage.'}</div></div><div class="field"><label>Base URL</label><input id="api_base" placeholder="https://api.example.com" /></div><div class="field"><label>Token</label><input id="api_token" placeholder="Bearer ..." /></div><div class="field"><label>${i18n.lang==='ar'?'الشعار':'Logo'}</label><div class="actions"><button class="ghost" onclick="openModal('modal-logo')">${i18n.lang==='ar'?'رفع شعار':'Upload Logo'}</button></div></div></div><div class="actions"><button onclick="applyApiSettings()">${i18n.lang==='ar'?'حفظ إعدادات API':'Save API Settings'}</button></div></div></div>`;
  $('#api_enabled').checked=api.enabled; $('#api_base').value=api.baseUrl; $('#api_token').value=api.token||'';
}
function view404(root){ root.innerHTML = `<div class="empty"><b>${i18n.lang==='ar'?'الصفحة غير موجودة':'Page Not Found'}</b><div>${i18n.lang==='ar'?'المسار:':'Path:'} ${location.hash}</div></div>` }

/* ---------- Tables ---------- */
function tableKids(items){ return `<table><thead><tr><th>${i18n.lang==='ar'?'الرقم':'ID'}</th><th>${i18n.lang==='ar'?'الاسم':'Name'}</th><th>${i18n.lang==='ar'?'الميلاد':'Birthdate'}</th></tr></thead><tbody>${items.map(c=>`<tr><td>${c.id}</td><td>${c.name}</td><td>${c.dob}</td></tr>`).join('')}</tbody></table>` }
function tableScreenings(items){ return `<table><thead><tr><th>${i18n.lang==='ar'?'المعرف':'ID'}</th><th>${i18n.lang==='ar'?'الطفل':'Child'}</th><th>${i18n.lang==='ar'?'النوع':'Type'}</th><th>${i18n.lang==='ar'?'التاريخ':'Date'}</th><th>${i18n.lang==='ar'?'النتيجة':'Result'}</th><th>${i18n.lang==='ar'?'المنشأة':'Facility'}</th></tr></thead><tbody>${items.map(s=>`<tr><td>${s.id}</td><td>${s.childId}</td><td>${s.type}</td><td>${s.date}</td><td>${s.result}</td><td>${s.facility}</td></tr>`).join('')}</tbody></table>` }
function tableReferrals(items,actions){ return `<table><thead><tr><th>${i18n.lang==='ar'?'المعرف':'ID'}</th><th>${i18n.lang==='ar'?'من':'From'}</th><th>${i18n.lang==='ar'?'إلى':'To'}</th><th>${i18n.lang==='ar'?'الطفل':'Child'}</th><th>${i18n.lang==='ar'?'الأولوية':'Priority'}</th><th>${i18n.lang==='ar'?'الحالة':'Status'}</th><th>${i18n.lang==='ar'?'التاريخ':'Date'}</th>${actions?'<th></th>':''}</tr></thead><tbody>${items.map(r=>`<tr><td>${r.id}</td><td>${r.from}</td><td>${r.to}</td><td>${r.childId}</td><td>${r.priority}</td><td>${r.status}</td><td>${r.created}</td>${actions?`<td><button class='ghost' onclick="updateReferral('${r.id}')">${i18n.lang==='ar'?'تحديث':'Update'}</button></td>`:''}</tr>`).join('')}</tbody></table>` }
function tableIEP(items){ return `<table><thead><tr><th>${i18n.lang==='ar'?'المعرف':'ID'}</th><th>${i18n.lang==='ar'?'الطفل':'Child'}</th><th>${i18n.lang==='ar'?'الأهداف':'Goals'}</th><th>${i18n.lang==='ar'?'مراجعة':'Review'}</th></tr></thead><tbody>${items.map(i=>`<tr><td>${i.id}</td><td>${i.childId}</td><td>${i.goals}</td><td>${i.review}</td></tr>`).join('')}</tbody></table>` }
function tableNPOs(items){ return `<table><thead><tr><th>${i18n.lang==='ar'?'المعرف':'ID'}</th><th>${i18n.lang==='ar'?'الاسم':'Name'}</th><th>${i18n.lang==='ar'?'المنطقة':'Region'}</th><th>${i18n.lang==='ar'?'برامج':'Programs'}</th><th>${i18n.lang==='ar'?'مستفيدون':'Beneficiaries'}</th></tr></thead><tbody>${items.map(n=>`<tr><td>${n.id||'-'}</td><td>${n.name}</td><td>${n.region}</td><td>${n.programs}</td><td>${n.beneficiaries}</td></tr>`).join('')}</tbody></table>` }
function tableCSR(items){ return `<table><thead><tr><th>${i18n.lang==='ar'?'المعرف':'ID'}</th><th>${i18n.lang==='ar'?'الشركة':'Company'}</th><th>${i18n.lang==='ar'?'المبلغ':'Amount'}</th><th>${i18n.lang==='ar'?'المبادرة':'Initiative'}</th><th>${i18n.lang==='ar'?'التاريخ':'Date'}</th></tr></thead><tbody>${items.map(c=>`<tr><td>${c.id}</td><td>${c.company}</td><td>${fmt(c.amount)}</td><td>${c.to}</td><td>${c.date}</td></tr>`).join('')}</tbody></table>` }
function tableMarketplace(items,actions){ return `<table><thead><tr><th>${i18n.lang==='ar'?'المعرف':'ID'}</th><th>${i18n.lang==='ar'?'المبادرة':'Initiative'}</th><th>KPI</th><th>${i18n.lang==='ar'?'المطلوب':'Requested'}</th><th>${i18n.lang==='ar'?'الممول':'Funded'}</th><th>${i18n.lang==='ar'?'الجهة':'Owner'}</th>${actions?'<th></th>':''}</tr></thead><tbody>${items.map(m=>`<tr><td>${m.id}</td><td>${m.title}</td><td>${m.kpi}</td><td>${fmt(m.ask)}</td><td>${fmt(m.funded)}</td><td>${m.owner}</td>${actions?`<td><button class='ghost' onclick="fund('${m.id}')">${i18n.lang==='ar'?'تمويل':'Fund'}</button></td>`:''}</tr>`).join('')}</tbody></table>` }

/* ---------- Chart ---------- */
function drawTrend(el,title,data){
  const w=el.clientWidth||600,h=180,p=24;
  const min=Math.min(...data),max=Math.max(...data); const rng=(max-min)||1;
  const toX=i=>p + (i*(w-2*p))/(data.length-1); const toY=v=>h-p - ((v-min)*(h-2*p))/rng;
  const pts=data.map((v,i)=>`${toX(i)},${toY(v)}`).join(' ');
  const ticks=5; let axis='';
  for(let i=0;i<=ticks;i++){ const y=p + (i*(h-2*p))/ticks; const val=(max - (i*rng)/ticks).toFixed(0);
    axis+=`<line x1="${p-6}" y1="${y}" x2="${w-p}" y2="${y}" stroke="#27324d" stroke-width="1" opacity="0.4"/><text x="${w-p+6}" y="${y+4}" font-size="10" fill="#a7b0c3">${val}</text>` }
  const circles=data.map((v,i)=>`<circle cx="${toX(i)}" cy="${toY(v)}" r="3.5" fill="${getComputedStyle(document.documentElement).getPropertyValue('--pri')}"/><text x="${toX(i)+6}" y="${toY(v)-6}" font-size="10" fill="#a7b0c3">${v}</text>`).join('');
  el.innerHTML = `<b>${title}</b><svg viewBox="0 0 ${w} ${h}" width="100%" height="${h}" role="img" aria-label="${title}"><rect x="${p-8}" y="${p-8}" width="${w-2*(p-8)}" height="${h-2*(p-8)}" fill="none" stroke="#27324d" opacity=".4"/><polyline points="${pts}" fill="none" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--pri')}" stroke-width="3"/>${circles}${axis}</svg>`;
}

/* ---------- Modal (focus trap + Esc) ---------- */
let lastFocused=null; let activeModal=null;
function openModal(id){ const m=$('#'+id); if(!m) return; activeModal=m; m.classList.add('open'); lastFocused=document.activeElement; const focusables=$$('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])',m); (focusables[0]||m).focus();
  function trap(e){ if(e.key==='Tab'){ const first=focusables[0], last=focusables[focusables.length-1]; if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault() } else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault() } } if(e.key==='Escape'){ closeModal(id) } }
  m.addEventListener('keydown',trap); m._trap=trap;
}
function closeModal(id){ const m=$('#'+id); if(!m) return; m.classList.remove('open'); if(m._trap){ m.removeEventListener('keydown',m._trap); m._trap=null } (lastFocused||document.body).focus(); activeModal=null }
window.addEventListener('keydown',e=>{ if(e.key==='Escape' && activeModal){ closeModal(activeModal.id) } });

/* ---------- Validation ---------- */
function clearErrors(scope=document){ $$('[data-err]',scope).forEach(el=>el.textContent='') }
function setError(input,msg){ const id=input.id; const el=$(`[data-err="${id}"]`); if(el){ el.textContent=msg } }
function checkRequired(input){ if(input.hasAttribute('data-req') && !input.value.trim()){ setError(input,t('errors.required')); return false } return true }
function checkPattern(input){ const pat=input.getAttribute('data-pattern'); if(pat){ const re=new RegExp(pat); if(!re.test(input.value.trim())){ setError(input,t('errors.pattern')); return false } } return true }
function validateForm(ids){ clearErrors(); let ok=true; ids.forEach(id=>{ const el=$('#'+id); if(!el) return; ok = checkRequired(el) && checkPattern(el) && ok }); return ok }

/* ---------- Architecture Page (data + view) ---------- */
const archData = {
  national: {
    title: t('arch.national'),
    items: [
      'لوحة قيادة وطنية KPIs',
      'إدارة التكامل بين القطاعات',
      'إدارة السياسات',
      'متابعة التمويل الوطني',
      'تقارير وطنية وتحليلات',
      'تكامل: NPHIES/SEHA – نور – الضمان الاجتماعي – منصة التطوع – نفاذ'
    ]
  },
  accounts: [
    { key:'family:view', title:'حساب الأسرة', bullets:[
      'متابعة الحمل وملف الطفل', 'التوصيات الذكية', 'الخدمات المساندة', 'مكتبة توعوية','مساحة الأب'
    ]},
    { key:'health:view', title:'وزارة الصحة', bullets:[
      'إدارة الفحوص النمائية', 'التدخل المبكر', 'الصحة النفسية للأم', 'تكامل NPHIES/SEHA'
    ]},
    { key:'education:view', title:'وزارة التعليم', bullets:[
      'رياض الأطفال والدمج', 'تقرير الجاهزية', 'IEP', 'التواصل مع الأسرة'
    ]},
    { key:'nonprofit:view', title:'الجمعيات الأهلية', bullets:[
      'إدارة البرامج والمستفيدين', 'المتطوعون', 'قياس الأثر الاجتماعي'
    ]},
    { key:'csr:view', title:'القطاع الخاص (CSR)', bullets:[
      'سوق الرعاية', 'محفظة رقمية', 'تقارير الأثر', 'بروفايل CSR'
    ]},
    { key:'admin:view', title:'اللجنة الوطنية', bullets:[
      'إشراف وطني موحد', 'سياسات وحوكمة', 'تبادل بيانات آمن (PDPL)', 'التقارير الوطنية'
    ]},
    { key:'family:view', title:'وزارة الموارد البشرية والتنمية الاجتماعية', bullets:[
      'الدعم المالي', 'الدعم الأسري', 'مؤشرات الاستقرار', 'الربط بمنصات الدعم والتطوع'
    ]}
  ],
  shared: [
    'SSO تسجيل دخول موحد','التوقيع الإلكتروني','لوحات متابعة وتنبيهات ذكية',
    'مكتبة توعوية','دعم الوصول','تطبيق جوال','API Bridge + CSV/PDF',
    'PoLP / MFA / Audit Trail / PDPL'
  ],
  journey: [
    { title:'ما قبل الزواج/الحمل', x:'وزارة الصحة + الجمعيات', kpi:'% المقبلين على الزواج المفحوصين' },
    { title:'الحمل', x:'المستشفيات + دعم نفسي', kpi:'% الأمهات المفحوصات نفسيًا' },
    { title:'الولادة', x:'فحص مواليد + NICU + اكتئاب ما بعد الولادة', kpi:'% المواليد المفحوصين' },
    { title:'0–3 سنوات', x:'متابعة نمو + تدخل مبكر', kpi:'% الأطفال المفحوصين نمائيًا' },
    { title:'3–6 سنوات', x:'الدمج ورياض الأطفال + IEP', kpi:'% الأطفال الجاهزين للمدرسة' },
    { title:'الخدمات المساندة للأسرة', x:'إرشاد + دعم مالي + مجموعات دعم', kpi:'% الأسر المستفيدة' }
  ]
};
function pill(txt, ok=false){ return `<span class="pill ${ok?'badge-ok':''}">${escapeHtml(txt)}</span>` }
function renderDetails(title, items=[], filter=''){
  const body = items.map(item=>{
    const hit = filter && (item.toLowerCase().includes(filter.toLowerCase())) ? ' hit' : '';
    return `<div class="tree${hit}">${escapeHtml(item)}</div>`;
  }).join('');
  return `<details open><summary>${escapeHtml(title)}</summary>${body}</details>`;
}
function renderAccounts(filter=''){
  return archData.accounts
    .filter(acc => can(acc.key) || ['family:view'].includes(acc.key))
    .map(acc=>{
      const items = acc.bullets.map(b=>{
        const hit = filter && b.toLowerCase().includes(filter.toLowerCase()) ? ' hit' : '';
        return `<div class="tree${hit}">• ${escapeHtml(b)}</div>`;
      }).join('');
      return `<details open><summary>${escapeHtml(acc.title)}</summary>${items}</details>`;
    }).join('');
}
function renderJourney(filter=''){
  return archData.journey.map(j=>{
    const label = `${j.title} — ${j.x}`;
    const hit = filter && (label.toLowerCase().includes(filter.toLowerCase()) || (j.kpi||'').toLowerCase().includes(filter.toLowerCase())) ? ' hit' : '';
    return `<details open class="${hit}">
      <summary>${escapeHtml(j.title)}</summary>
      <div class="muted">${escapeHtml(j.x)}</div>
      ${j.kpi? pill(j.kpi) : ''}
    </details>`;
  }).join('');
}
function viewArchitecture(root){
  const kpis = kpisFromStore();
  root.innerHTML = `
    <div class="toolbar">
      <h2>${t('arch.title')}</h2>
      <div class="actions"><span class="tag">${t('arch.roleScoped')}</span></div>
    </div>

    <div class="arch">
      <div class="searchbar">
        <input id="archFilter" placeholder="${t('arch.filter')}" oninput="renderArchFilter(this.value)" />
      </div>

      <div class="grid-2">
        <div class="card tree">
          <b>${t('arch.layers')}</b>
          ${renderDetails(t('arch.national'), archData.national.items)}
          <hr style="border-color:var(--border)"/>
          <b>${t('arch.shared')}</b>
          ${renderDetails(t('arch.shared'), archData.shared)}
        </div>

        <div class="card tree">
          <b>${t('arch.accounts')}</b>
          <div id="archAccounts">${renderAccounts('')}</div>
        </div>
      </div>

      <div class="card">
        <b>${t('arch.journey')}</b>
        <div id="archJourney">${renderJourney('')}</div>
      </div>

      <div class="card">
        <b>${t('arch.kpis')}</b>
        <div class="grid three" id="archKpis">
          ${kpiCard(t('arch.kpi_screened'), fmt(kpis.pctScreened)+'%')}
          ${kpiCard(t('arch.kpi_ready'), fmt(kpis.pctReady)+'%')}
          ${kpiCard(t('arch.kpi_csr'), fmt(kpis.csrTotal))}
          ${kpiCard(t('arch.kpi_referrals'), fmt(kpis.activeReferrals))}
          ${kpiCard(t('arch.kpi_funded'), fmt(kpis.fundedInitiatives))}
        </div>
      </div>

      <div class="grid two">
        <div class="card" id="archChart"></div>
        <div class="card" id="archChart2"></div>
      </div>
    </div>`;

  const label1 = i18n.lang==='ar' ? 'فحوص شهرية (عدد)' : 'Monthly Screenings';
  const label2 = i18n.lang==='ar' ? 'تمويل CSR شهري (ر.س)' : 'Monthly CSR Funding (SAR)';

  drawTrend($('#archChart'),  label1, kpis.trend.length    ? kpis.trend    : [0,0,0,0,0,0]);
  drawTrend($('#archChart2'), label2, kpis.csrTrend.length ? kpis.csrTrend : [0,0,0,0,0,0]);
}
function renderArchFilter(q=''){
  const acc = $('#archAccounts'); const jr = $('#archJourney');
  if(acc) acc.innerHTML = renderAccounts(q||'');
  if(jr) jr.innerHTML = renderJourney(q||'');
}

/* ---------- API & Session actions ---------- */
function openLogin(){ openModal('modal-login') }
function openConsent(){ openModal('modal-consent') }
function doLogin(){ const role=$('#loginRole').value; const region=$('#loginRegion').value; if(!validateForm(['loginRole','loginRegion'])) return; store.state.user={role,region}; store.save(); $('#roleTag').textContent=t('role.signed')+role; closeModal('modal-login'); toast(t('role.signed')+role); enforceRBAC(); router() }
function saveConsent(){ store.state.consent={c1:$('#c1').checked,c2:$('#c2').checked,c3:$('#c3').checked,c4:$('#c4').checked}; store.save(); closeModal('modal-consent'); toast(t('toast.saved')) }

function submitScreening(){ if(!validateForm(['f_sc_child','f_sc_date'])) return; const id='S-'+Math.floor(Math.random()*1e5); const payload={ id, childId:$('#f_sc_child').value, type:$('#f_sc_type').value, date:$('#f_sc_date').value, result:$('#f_sc_result').value||'—', facility:$('#f_sc_facility').value||store.state.user.region+'/مركز صحي' }; if(api.enabled){ apiFetch('/screenings',{method:'POST',body:JSON.stringify(payload)}).then(()=>toast(t('toast.apiSaved'))).catch(()=>{store.state.screenings.push(payload);store.save();toast(t('toast.apiFallback'))}).finally(()=>{closeModal('modal-screening');router(); if (location.hash.startsWith('#/architecture')) { viewArchitecture($('#view')); }}) } else { store.state.screenings.push(payload); store.save(); closeModal('modal-screening'); toast(t('toast.saved')); router(); if (location.hash.startsWith('#/architecture')) { viewArchitecture($('#view')); } } }

function submitReferral(){ if(!validateForm(['f_ref_child','f_ref_date'])) return; const id='R-'+Math.floor(Math.random()*1e5); const payload={ id, from:$('#f_ref_from').value, to:$('#f_ref_to').value, childId:$('#f_ref_child').value, priority:$('#f_ref_pri').value, status:$('#f_ref_status').value, created:$('#f_ref_date').value }; if(api.enabled){ apiFetch('/referrals',{method:'POST',body:JSON.stringify(payload)}).then(()=>toast(t('toast.apiSaved'))).catch(()=>{store.state.referrals.push(payload);store.save();toast(t('toast.apiFallback'))}).finally(()=>{closeModal('modal-referral');router(); if (location.hash.startsWith('#/architecture')) { viewArchitecture($('#view')); }}) } else { store.state.referrals.push(payload); store.save(); closeModal('modal-referral'); toast(t('toast.saved')); router(); if (location.hash.startsWith('#/architecture')) { viewArchitecture($('#view')); } } }

function updateReferral(id){ const r=store.state.referrals.find(x=>x.id===id); if(!r) return; const st=prompt(i18n.lang==='ar'?'تحديث الحالة:':'Update status:', r.status)||r.status; r.status=st; store.save(); toast(t('toast.updated')); router(); if (location.hash.startsWith('#/architecture')) { viewArchitecture($('#view')); } }

function submitIEP(){ if(!validateForm(['f_iep_child','f_iep_review'])) return; const id='IEP-'+Math.floor(Math.random()*1e5); const payload={ id, childId:$('#f_iep_child').value, goals:$('#f_iep_goals').value||'Goals', review:$('#f_iep_review').value }; if(api.enabled){ apiFetch('/iep',{method:'POST',body:JSON.stringify(payload)}).then(()=>toast(t('toast.apiSaved'))).catch(()=>{store.state.ieps.push(payload);store.save();toast(t('toast.apiFallback'))}).finally(()=>{closeModal('modal-iep');router(); if (location.hash.startsWith('#/architecture')) { viewArchitecture($('#view')); }}) } else { store.state.ieps.push(payload); store.save(); closeModal('modal-iep'); toast(t('toast.saved')); router(); if (location.hash.startsWith('#/architecture')) { viewArchitecture($('#view')); } } }

function submitMarket(){ if(!validateForm(['f_m_title','f_m_kpi','f_m_ask','f_m_owner'])) return; const id='M-'+Math.floor(Math.random()*1e5); const payload={ id, title:$('#f_m_title').value, kpi:$('#f_m_kpi').value, ask:parseInt($('#f_m_ask').value||'0',10), funded:0, owner:$('#f_m_owner').value||'جمعية' }; if(api.enabled){ apiFetch('/market',{method:'POST',body:JSON.stringify(payload)}).then(()=>toast(t('toast.apiSaved'))).catch(()=>{store.state.marketplace.push(payload);store.save();toast(t('toast.apiFallback'))}).finally(()=>{closeModal('modal-market');router(); if (location.hash.startsWith('#/architecture')) { viewArchitecture($('#view')); }}) } else { store.state.marketplace.push(payload); store.save(); closeModal('modal-market'); toast(t('toast.saved')); router(); if (location.hash.startsWith('#/architecture')) { viewArchitecture($('#view')); } } }

function submitCSR(){ if(!validateForm(['f_csr_to','f_csr_company','f_csr_amount','f_csr_date'])) return; const id='CSR-'+Math.floor(Math.random()*1e5); const payload={ id, company:$('#f_csr_company').value||'Company', amount:parseInt($('#f_csr_amount').value||'0',10), to:$('#f_csr_to').value, date:$('#f_csr_date').value }; if(api.enabled){ apiFetch('/csr',{method:'POST',body:JSON.stringify(payload)}).then(()=>toast(t('toast.apiSaved'))).catch(()=>{store.state.csr.push(payload); const m=store.state.marketplace.find(x=>x.id===payload.to); if(m) m.funded+=payload.amount; store.save(); toast(t('toast.apiFallback'))}).finally(()=>{closeModal('modal-csr');router(); if (location.hash.startsWith('#/architecture')) { viewArchitecture($('#view')); }}) } else { store.state.csr.push(payload); const m=store.state.marketplace.find(x=>x.id===payload.to); if(m) m.funded+=payload.amount; store.save(); closeModal('modal-csr'); toast(t('toast.saved')); router(); if (location.hash.startsWith('#/architecture')) { viewArchitecture($('#view')); } } }

function fund(id){ const amount=parseInt(prompt(i18n.lang==='ar'?'مبلغ التمويل (ر.س):':'Funding amount (SAR):','10000')||'0',10); if(!amount) return; const payload={ id:'CSR-'+Math.floor(Math.random()*1e5), company:'Supporter', amount, to:id, date:today() }; if(api.enabled){ apiFetch('/csr',{method:'POST',body:JSON.stringify(payload)}).catch(()=>{}); } store.state.csr.push(payload); const m=store.state.marketplace.find(x=>x.id===id); if(m) m.funded+=amount; store.save(); toast(t('toast.updated')); router(); if (location.hash.startsWith('#/architecture')) { viewArchitecture($('#view')); } }

function addChild(){ const h=store.state.households[0]; const id='C-'+Math.floor(Math.random()*1e4); const name=prompt(i18n.lang==='ar'?'اسم الطفل:':'Child name:','طفلي'); const dob=prompt(i18n.lang==='ar'?'تاريخ الميلاد (YYYY-MM-DD):':'Birthdate (YYYY-MM-DD):',today()); if(!name) return; h.children.push({id,name,dob}); store.save(); toast(t('toast.saved')); router(); if (location.hash.startsWith('#/architecture')) { viewArchitecture($('#view')); } }

/* ---------- Logo upload ---------- */
function uploadLogo(){ const f=$('#logoFile').files[0]; if(!f) return; if(f.size>1.5*1024*1024){ toast(i18n.lang==='ar'?'حجم الشعار كبير':'Logo too large'); return } const r=new FileReader(); r.onload=e=>{ store.state.ui.logo=e.target.result; store.save(); $('#logo').src=store.state.ui.logo; $('#logo').classList.remove('ph'); closeModal('modal-logo'); toast(i18n.lang==='ar'?'تم تحديث الشعار':'Logo updated') }; r.readAsDataURL(f) }

/* ---------- CSV Exports ---------- */
function toCSV(rows, headers){
  const esc=v=>(''+(v??'')).replaceAll('"','""');
  const head=headers.join(',');
  const body=rows.map(r=>headers.map(h=>`"${esc(r[h])}"`).join(',')).join('\n');
  return head+'\n'+body;
}
function exportCSVs(){
  const meta=`generated_at,role,region\n"${new Date().toISOString()}","${store.state.user.role}","${store.state.user.region}"\n\n`;
  const sCSV=meta+toCSV(store.state.screenings,["id","childId","type","date","result","facility"]);
  download('screenings.csv',sCSV);
  const rCSV=meta+toCSV(store.state.referrals,["id","from","to","childId","priority","status","created"]);
  download('referrals.csv',rCSV);
  const cCSV=meta+toCSV(store.state.csr,["id","company","amount","to","date"]);
  download('csr.csv',cCSV);
  toast(i18n.lang==='ar'?'تم تصدير CSV':'CSV exported');
}

/* ---------- Settings helpers ---------- */
function setRegion(region){store.state.user.region=region;store.save();toast(t('region.set'));router()}
function setLang(lang){ i18n.lang=lang; localStorage.setItem('nomu.lang',lang); applyI18n(); router() }
function applyApiSettings(){ api.enabled=$('#api_enabled').checked; api.baseUrl=$('#api_base').value||api.baseUrl; api.token=$('#api_token').value||null; toast(api.enabled?(i18n.lang==='ar'?'تم تفعيل وضع API':'API mode enabled'):(i18n.lang==='ar'?'تم تعطيل وضع API':'API mode disabled')) }

/* ---------- Search (Global) ---------- */
function globalSearch(q){
  q=(q||'').trim(); if(q.length<2) return;
  const inStr = s => (s||'').toString().toLowerCase();
  const ql = q.toLowerCase();

  // search children by id or name
  const h = store.state.households[0];
  const kid = h?.children?.find(c=> inStr(c.id).includes(ql) || inStr(c.name).includes(ql));
  if(kid){ location.hash=`#/family?child=${encodeURIComponent(kid.id)}`; toast((i18n.lang==='ar'?'فتح ملف الطفل: ':'Open child: ')+kid.id); return }

  // search referrals by id
  const ref = store.state.referrals.find(r=>inStr(r.id).includes(ql) || inStr(r.childId).includes(ql));
  if(ref){ location.hash='#/referrals'; toast((i18n.lang==='ar'?'عرض الإحالة: ':'Show referral: ')+ref.id); return }

  // search marketplace by title
  const m = store.state.marketplace.find(m=>inStr(m.title).includes(ql));
  if(m){ location.hash='#/market'; toast((i18n.lang==='ar'?'عرض المبادرة: ':'Show initiative: ')+m.id); return }

  toast(i18n.lang==='ar'?'لا نتائج مطابقة':'No matches');
}

/* ---------- Seed / Wipe ---------- */
function seedDemo(){
  // add few random records for demo
  const newC = {id:'C-'+Math.floor(Math.random()*1e4), name:'طفل جديد', dob:'2022-01-01'};
  store.state.households[0].children.push(newC);
  store.state.screenings.push({id:'S-'+Math.floor(Math.random()*1e5), childId:newC.id, type:'نمو نمائي', date:today(), result:'سليم', facility:store.state.user.region+'/مركز صحي'});
  store.state.referrals.push({id:'R-'+Math.floor(Math.random()*1e5), from:'الصحة', to:'التعليم', childId:newC.id, priority:'عادية', status:'قيد المعالجة', created:today()});
  store.state.marketplace.push({id:'M-'+Math.floor(Math.random()*1e5), title:'مبادرة جديدة', kpi:'50 طفل/3 أشهر', ask:90000, funded:10000, owner:'جمعية'});
  store.save();
  toast(i18n.lang==='ar'?'تم ملء بيانات تجريبية':'Demo data seeded'); router(); if (location.hash.startsWith('#/architecture')) { viewArchitecture($('#view')); }
}
function wipe(){
  if(!confirm(i18n.lang==='ar'?'سيتم مسح بيانات المنصة المحلية. متابعة؟':'This will clear local data. Continue?')) return;
  localStorage.removeItem('nomu'); store.load(); router(); toast(i18n.lang==='ar'?'تم المسح':'Cleared'); if (location.hash.startsWith('#/architecture')) { viewArchitecture($('#view')); }
}

/* ---------- Init ---------- */
function initLogo(){ if(store.state.ui.logo){ $('#logo').src=store.state.ui.logo; $('#logo').classList.remove('ph') } }
router(); applyI18n(); enforceRBAC(); initLogo();
$('#roleTag').textContent = (i18n.lang==='ar'?'دور: ':'Role: ')+ (store.state.user.role||'guest');
if(!location.hash) location.hash = '#/home';
</script>
</body>
</html>
